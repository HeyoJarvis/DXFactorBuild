/**
 * Fetch both transcript and Copilot notes for xyz standup meeting
 */

const { createClient } = require('@supabase/supabase-js');
const path = require('path');
require('dotenv').config({ path: path.join(__dirname, '../.env') });

const MeetingIntelligenceService = require('./main/services/MeetingIntelligenceService');
const StandaloneMicrosoftService = require('./main/services/StandaloneMicrosoftService');
const TeamSyncSupabaseAdapter = require('./main/services/TeamSyncSupabaseAdapter');
const MicrosoftOAuthService = require('./main/services/oauth/MicrosoftOAuthService');

async function fetchMeetingContent() {
  try {
    console.log('\nğŸ” Fetching xyz standup meeting content...\n');

    // Initialize services
    const supabase = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );

    const supabaseAdapter = new TeamSyncSupabaseAdapter({
      supabase,
      logger: console
    });

    const oauthService = new MicrosoftOAuthService({
      supabaseAdapter,
      logger: console
    });

    const microsoftService = new StandaloneMicrosoftService({
      oauthService,
      supabaseAdapter,
      logger: console
    });

    const meetingService = new MeetingIntelligenceService({
      microsoftService,
      supabaseAdapter,
      logger: console
    });

    const userId = 'e833f35b-5991-4ede-b10a-e3702e46b37b';

    // Get xyz standup meeting from database
    console.log('ğŸ“‹ Looking for xyz standup meeting in database...');
    const { data: meetings, error } = await supabase
      .from('team_meetings')
      .select('*')
      .eq('user_id', userId)
      .ilike('title', '%xyz%standup%')
      .order('start_time', { ascending: false })
      .limit(1);

    if (error) throw error;

    if (!meetings || meetings.length === 0) {
      console.log('âŒ xyz standup meeting not found in database');
      return;
    }

    const meeting = meetings[0];
    console.log('\nâœ… Found meeting:', {
      title: meeting.title,
      meeting_id: meeting.meeting_id,
      start_time: meeting.start_time,
      end_time: meeting.end_time,
      has_manual_notes: !!meeting.manual_notes,
      has_copilot_notes: !!meeting.copilot_notes,
      has_transcript: !!meeting.metadata?.transcript
    });

    // Fetch both transcript and Copilot notes from Microsoft
    console.log('\nğŸ”„ Fetching content from Microsoft Teams...');
    console.log('This will fetch:');
    console.log('  1. Raw transcript (word-for-word conversation)');
    console.log('  2. Copilot notes (AI-generated summary & action items)\n');

    const result = await meetingService.fetchCopilotNotes(userId, meeting.meeting_id);

    console.log('\nğŸ“Š Fetch Result:');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    console.log('Success:', result.success);
    
    if (result.success) {
      console.log('\nâœ… TRANSCRIPT:');
      console.log('  Available:', !!result.transcript);
      if (result.transcript) {
        const transcriptPreview = result.transcript.substring(0, 300);
        console.log('  Preview:', transcriptPreview + '...');
        console.log('  Length:', result.transcript.length, 'characters');
      }

      console.log('\nâœ… COPILOT NOTES:');
      console.log('  Available:', !!result.copilotNotes);
      if (result.copilotNotes) {
        const notesPreview = result.copilotNotes.substring(0, 300);
        console.log('  Preview:', notesPreview + '...');
        console.log('  Length:', result.copilotNotes.length, 'characters');
      } else {
        console.log('  Note: Copilot notes not generated by Teams (will use AI to generate summary)');
      }

      console.log('\nâœ… METADATA:');
      console.log('  Transcript ID:', result.metadata?.transcriptId);
      console.log('  Created:', result.metadata?.createdDateTime);
      console.log('  Meeting ID:', result.metadata?.meetingId);

      // Check updated database record
      console.log('\nğŸ“¥ Checking database for saved content...');
      const { data: updatedMeeting } = await supabase
        .from('team_meetings')
        .select('copilot_notes, metadata, ai_summary')
        .eq('meeting_id', meeting.meeting_id)
        .single();

      if (updatedMeeting) {
        console.log('\nâœ… Database Status:');
        console.log('  Transcript saved:', !!updatedMeeting.metadata?.transcript);
        console.log('  Copilot notes saved:', !!updatedMeeting.copilot_notes);
        console.log('  AI summary:', !!updatedMeeting.ai_summary);
        
        if (updatedMeeting.metadata?.transcript) {
          console.log('  Transcript length:', updatedMeeting.metadata.transcript.length, 'characters');
        }
      }

      console.log('\nâœ… SUCCESS: Meeting content fetched and saved!');
      console.log('\nYou now have:');
      console.log('  ğŸ“ Full transcript with timestamps');
      console.log('  ğŸ¤– Copilot notes (if available)');
      console.log('  ğŸ§  AI-generated summary (if Copilot notes unavailable)');

    } else {
      console.log('\nâŒ Error:', result.error);
      console.log('\nPossible reasons:');
      console.log('  â€¢ Meeting recording wasn\'t enabled');
      console.log('  â€¢ Transcript not ready yet (usually takes 5-10 minutes)');
      console.log('  â€¢ Microsoft 365 Copilot not enabled');
      console.log('  â€¢ meeting_id needs to be the online meeting ID, not calendar event ID');
    }

  } catch (error) {
    console.error('\nâŒ Failed:', error.message);
    console.error(error.stack);
  }
}

fetchMeetingContent();

