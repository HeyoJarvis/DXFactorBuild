# üîÑ Hybrid OAuth Setup - Complete

## Architecture

We now use a **hybrid approach** for OAuth:

### Supabase Auth (Slack)
‚úÖ **Slack** uses Supabase's built-in OAuth
- Redirect URI already configured in Supabase: `https://your-project.supabase.co/auth/v1/callback`
- No need to configure localhost redirects in Slack app
- Easier to manage and deploy
- Uses Supabase's `auth.signInWithOAuth()`

### Direct OAuth (Microsoft, Google)
‚úÖ **Microsoft** and **Google** use custom OAuth server
- Uses `electron-oauth-server.js` on port 8890
- More control over the OAuth flow
- Easier to customize user data handling
- Requires redirect URIs configured in Azure/Google Console

---

## How It Works

### Slack Login Flow:
```
1. User clicks "Sign in with Slack"
   ‚Üì
2. AuthService.signInWithSlack()
   ‚Üì
3. Supabase.auth.signInWithOAuth({ provider: 'slack' })
   ‚Üì
4. Opens browser ‚Üí Slack OAuth ‚Üí Supabase callback
   ‚Üì
5. App polls for session: pollForSession()
   ‚Üì
6. Session received ‚Üí ensureUserOnboardingFields()
   ‚Üì
7. User record created/updated in users table
   ‚Üì
8. Onboarding flow starts
```

### Microsoft Login Flow:
```
1. User clicks "Sign in with Microsoft"
   ‚Üì
2. AuthService.signInWithMicrosoft()
   ‚Üì
3. Opens browser ‚Üí electron-oauth-server.js
   ‚Üì
4. OAuth server handles Microsoft OAuth
   ‚Üì
5. App polls OAuth server: waitForOAuthCallback()
   ‚Üì
6. User data received ‚Üí handleDirectAuth()
   ‚Üì
7. User created/updated directly in database
   ‚Üì
8. Onboarding flow starts
```

---

## Configuration Required

### For Slack (Supabase):
1. **Supabase Dashboard**:
   - Authentication ‚Üí Providers ‚Üí Slack
   - Enable Slack provider
   - Add your Slack Client ID and Secret
   - Redirect URL is automatic: `https://your-project.supabase.co/auth/v1/callback`

2. **Slack App**:
   - Add redirect URL: `https://your-project.supabase.co/auth/v1/callback`
   - ‚ùå NO need for: `http://localhost:8890/auth/slack/callback`

### For Microsoft (Direct OAuth):
1. **Azure Portal**:
   - Add redirect URI: `http://localhost:8890/auth/microsoft/callback`
   - Or: `http://localhost:8889/auth/microsoft/callback` (if using MICROSOFT_REDIRECT_URI in .env)

2. **.env file**:
   ```bash
   MICROSOFT_CLIENT_ID=your-client-id
   MICROSOFT_CLIENT_SECRET=your-client-secret
   MICROSOFT_REDIRECT_URI=http://localhost:8889/auth/microsoft/callback
   ```

### For Google (Direct OAuth):
1. **Google Console**:
   - Add redirect URI: `http://localhost:8890/auth/google/callback`

2. **.env file**:
   ```bash
   GOOGLE_CLIENT_ID=your-client-id
   GOOGLE_CLIENT_SECRET=your-client-secret
   ```

---

## Benefits of Hybrid Approach

### Supabase Auth (Slack):
‚úÖ Already configured and working
‚úÖ No localhost redirect issues
‚úÖ Automatic session management
‚úÖ Easier to deploy to production
‚úÖ Built-in token refresh

### Direct OAuth (Microsoft, Google):
‚úÖ More control over user data
‚úÖ Can customize authentication flow
‚úÖ Direct database access
‚úÖ No Supabase Auth user count limits
‚úÖ Can add custom provider-specific data

---

## User Data Handling

### Slack (via Supabase Auth):
- User created in Supabase Auth automatically
- `ensureUserOnboardingFields()` syncs to our `users` table
- User ID comes from Supabase Auth
- Session managed by Supabase

### Microsoft/Google (Direct):
- User created directly in our `users` table
- `handleDirectAuth()` creates/updates user
- User ID generated by PostgreSQL
- Session managed locally (electron-store)

---

## Running the System

### Start OAuth Server (for Microsoft/Google):
```bash
node oauth/electron-oauth-server.js
```
This runs on port 8890 (and optionally 8889 for Microsoft)

### Start Electron App:
```bash
npm run dev:desktop
```

### No Need to Configure:
- ‚úÖ Slack works immediately (uses Supabase)
- ‚öôÔ∏è Microsoft/Google need OAuth server running

---

## Deployment Considerations

### Development:
- Slack: Uses Supabase (works locally and remote)
- Microsoft/Google: Uses local OAuth server

### Production:
- Slack: Uses Supabase (already production-ready)
- Microsoft/Google: Will need OAuth server hosted or switch to Supabase Auth

For production, you can:
1. Keep Slack on Supabase
2. Host the OAuth server on a server
3. OR migrate Microsoft/Google to Supabase Auth too

---

**Status**: ‚úÖ Hybrid OAuth implementation complete
**Next Step**: Test Slack login (should work immediately!)

