<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: https: http://localhost:*; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' http://localhost:* https:;">
  <title>HeyJarvis</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=SF+Pro+Text:wght@300;400;500;600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Text', sans-serif;
      background: #fafafa;
      color: #171717;
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(40px) saturate(180%);
      border-radius: 16px;
      box-shadow: 
        0 0 0 0.5px rgba(0, 0, 0, 0.04),
        0 20px 50px -12px rgba(0, 0, 0, 0.12),
        0 8px 16px -8px rgba(0, 0, 0, 0.08);
    }

    body.collapsed {
      height: 48px;
      background: rgba(255, 255, 255, 0.98);
    }

    body.collapsed .copilot-content {
      display: none !important;
    }

    body.expanded {
      height: 100vh;
      background: #fafafa;
    }

    body::before {
      content: '';
      position: absolute;
      top: -20%;
      left: -20%;
      width: 140%;
      height: 140%;
      background: radial-gradient(circle at center, 
        rgba(0, 122, 255, 0.02) 0%, 
        rgba(88, 86, 214, 0.01) 40%, 
        transparent 70%);
      animation: breathe 6s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes breathe {
      0%, 100% { opacity: 0.2; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(1.02); }
    }

    /* Header - Compact Premium Design */
    .copilot-header {
      display: flex;
      align-items: center;
      padding: 8px 20px;
      height: 48px;
      background: white;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      gap: 16px;
      flex-shrink: 0;
    }

    body.collapsed .copilot-header {
      height: 48px;
    }

    .copilot-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      font-weight: 600;
      font-size: 14px;
      color: #171717;
      letter-spacing: -0.02em;
      cursor: move;
      padding: 6px 10px;
      border-radius: 6px;
      user-select: none;
      -webkit-app-region: drag;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .copilot-title:hover {
      background: rgba(0, 0, 0, 0.03);
    }

    .copilot-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
      transition: all 0.3s ease;
    }

    .header-input-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      max-width: 500px;
      margin: 0 16px;
      -webkit-app-region: no-drag;
      position: relative;
    }

    body.expanded .header-input-wrapper {
      display: none;
    }

    .header-input {
      width: 100%;
      height: 32px;
      background: rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 8px;
      padding: 0 16px;
      padding-right: 40px;
      font-size: 13px;
      color: #171717;
      outline: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .header-input::placeholder {
      color: #a3a3a3;
    }

    .header-input:hover {
      background: rgba(0, 0, 0, 0.06);
      border-color: rgba(0, 0, 0, 0.12);
    }

    .header-input-send-btn {
      position: absolute;
      right: 6px;
      width: 24px;
      height: 24px;
      background: rgba(0, 122, 255, 0.1);
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      pointer-events: none;
    }

    .header-input-wrapper:hover .header-input-send-btn,
    .header-input:focus ~ .header-input-send-btn,
    .header-input-send-btn.has-text {
      opacity: 1;
      pointer-events: auto;
    }

    .header-input-send-btn:hover {
      background: rgba(0, 122, 255, 0.2);
      transform: scale(1.05);
    }

    .header-input-send-btn:active {
      transform: scale(0.95);
    }

    .header-input-send-btn svg {
      width: 14px;
      height: 14px;
      color: #007AFF;
    }

    .header-input:focus {
      background: white;
      border-color: #171717;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.04);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      -webkit-app-region: no-drag;
    }

    .header-nav-btn {
      height: 32px;
      padding: 0 16px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #737373;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      letter-spacing: -0.01em;
    }

    .header-nav-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #171717;
    }

    .header-nav-btn.active {
      background: #171717;
      color: white;
    }

    .header-nav-btn.active:hover {
      background: #0a0a0a;
    }

    .nav-badge {
      width: 6px;
      height: 6px;
      background: #FF3B30;
      border-radius: 50%;
      margin-left: 2px;
    }

    .header-nav-btn.active .nav-badge {
      background: white;
    }

    .header-divider {
      width: 1px;
      height: 24px;
      background: rgba(0, 0, 0, 0.1);
      margin: 0 6px;
    }

    .header-action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #737373;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .header-action-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #171717;
    }

    .header-action-btn:active {
      transform: scale(0.95);
    }

    .notification-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 8px;
      height: 8px;
      background: #FF3B30;
      border-radius: 50%;
      border: 2px solid white;
    }

    /* Microsoft 365 Button */
    .ms-auth-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #737373;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .ms-auth-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #171717;
    }

    .ms-auth-btn.connected {
      color: #10b981;
    }

    .ms-auth-btn.connected:hover {
      background: rgba(16, 185, 129, 0.1);
    }

    .ms-status-dot {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #737373;
      transition: all 0.2s ease;
    }

    .ms-auth-btn.connected .ms-status-dot {
      background: #10b981;
      box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
      animation: msPulse 2s ease-in-out infinite;
    }

    @keyframes msPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .ms-auth-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    }

    .ms-auth-modal.show {
      display: flex;
    }

    .ms-auth-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ms-auth-content h3 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #171717;
    }

    .ms-auth-content p {
      font-size: 14px;
      color: #737373;
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .ms-auth-actions {
      display: flex;
      gap: 12px;
    }

    .ms-auth-actions button {
      flex: 1;
      height: 40px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ms-auth-primary {
      background: linear-gradient(135deg, #0078d4 0%, #5856d6 100%);
      color: white;
    }

    .ms-auth-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
    }

    .ms-auth-secondary {
      background: rgba(0, 0, 0, 0.05);
      color: #171717;
    }

    .ms-auth-secondary:hover {
      background: rgba(0, 0, 0, 0.08);
    }

    @keyframes msSpinAnimation {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }


    .header-chat-container {
      display: none;
      align-items: center;
      flex: 1;
      max-width: 300px;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    body.collapsed .header-chat-container {
      display: flex;
    }

    .header-chat-input {
      flex: 1;
      background: rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 22px;
      padding: 10px 18px;
      color: #1d1d1f;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
      min-width: 0;
    }

    .header-chat-input:focus {
      background: rgba(0, 0, 0, 0.06);
      border-color: rgba(0, 122, 255, 0.4);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.08);
    }

    .header-chat-input::placeholder {
      color: rgba(0, 0, 0, 0.4);
    }

    .header-send-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
      color: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
    }

    .header-send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
    }

    .copilot-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    body.collapsed .copilot-controls {
      display: none;
    }

    .control-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.05);
      color: rgba(0, 0, 0, 0.5);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .control-btn:hover {
      background: rgba(0, 0, 0, 0.1);
      color: rgba(0, 0, 0, 0.75);
      transform: scale(1.1);
    }

    .control-btn.close:hover {
      background: #FF3B30;
      color: #ffffff;
    }


    /* Content Area */
    .copilot-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    body.collapsed .copilot-content {
      display: none;
    }

    .tab-content {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .tab-content.active {
      display: flex;
    }

    /* Status Bar - Light Theme */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: rgba(0, 0, 0, 0.02);
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
    }

    .status-indicators {
      display: flex;
      gap: 20px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(142, 142, 147, 0.8);
    }

    .status-dot.online {
      background: #34C759;
      box-shadow: 0 0 8px rgba(52, 199, 89, 0.4);
    }

    /* Chat Interface */
    .chat-interface {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      background: #fafafa;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px 12px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
      min-height: 0;
    }
    
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-container::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }
    
    .chat-container::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    .welcome-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 16px;
      min-height: 150px;
      gap: 16px;
    }

    .welcome-logo {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .welcome-text {
      font-size: 13px;
      font-weight: 500;
      color: #171717;
      letter-spacing: -0.01em;
      text-align: center;
      line-height: 1.4;
    }

    .welcome-subtitle {
      font-size: 12px;
      font-weight: 400;
      color: #a3a3a3;
      letter-spacing: -0.005em;
    }

    .message {
      display: flex;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
    }

    .message.assistant .message-avatar {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
    }

    .message-content {
      flex: 1;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 14px;
      line-height: 1.6;
      max-width: 80%;
      color: #171717;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .message.user .message-content {
      background: #171717;
      border-color: transparent;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }

    .typing-indicator {
      display: none;
      padding: 16px 24px;
      align-items: center;
      gap: 10px;
      background: white;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      font-size: 13px;
      color: #737373;
      flex-shrink: 0;
    }

    .input-container {
      padding: 12px 12px 16px 12px;
      background: white;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      flex-shrink: 0;
    }

    .input-wrapper {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      max-width: 100%;
      margin: 0 auto;
      background: #fafafa;
      border: 1.5px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      padding: 8px 8px 8px 12px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .input-wrapper:focus-within {
      background: white;
      border-color: #171717;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.04);
    }

    .message-input {
      flex: 1;
      background: transparent;
      border: none;
      padding: 4px 0;
      color: #171717;
      font-size: 13px;
      line-height: 1.4;
      resize: none;
      min-height: 20px;
      max-height: 80px;
      font-family: inherit;
    }

    .message-input:focus {
      outline: none;
    }

    .message-input::placeholder {
      color: #a3a3a3;
    }

    .send-btn {
      width: 28px;
      height: 28px;
      background: #171717;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
      font-size: 14px;
    }

    .send-btn:hover:not(:disabled) {
      background: #0a0a0a;
      transform: scale(1.05);
    }

    .send-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .send-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Tasks Styles - Compact Light Theme */
    .tasks-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #fafafa;
    }
    
    .tasks-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .tasks-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .tasks-container::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }
    
    .tasks-container::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .tasks-title {
      font-size: 15px;
      font-weight: 600;
      color: #171717;
      letter-spacing: -0.02em;
    }

    .task-stats {
      display: flex;
      gap: 8px;
      font-size: 11px;
      color: #737373;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-dot.todo { background: #FF9F0A; }
    .stat-dot.in-progress { background: #007AFF; }
    .stat-dot.completed { background: #34C759; }

    .task-filter-section {
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .assignment-filter {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: white;
      color: #171717;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      outline: none;
    }

    .assignment-filter:hover {
      border-color: rgba(0, 212, 255, 0.3);
      background: rgba(0, 212, 255, 0.02);
    }

    .assignment-filter:focus {
      border-color: rgba(0, 212, 255, 0.5);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .task-input-section {
      background: white;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .task-input-wrapper {
      display: flex;
      gap: 8px;
    }

    .task-input {
      flex: 1;
      background: #fafafa;
      border: 1.5px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      padding: 8px 12px;
      color: #171717;
      font-size: 13px;
      outline: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-input::placeholder {
      color: #a3a3a3;
    }

    .task-input:focus {
      background: white;
      border-color: #171717;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.04);
    }

    .add-task-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #171717;
      color: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .add-task-btn:hover {
      background: #0a0a0a;
      transform: scale(1.02);
    }

    .add-task-btn:active {
      transform: scale(0.98);
    }

    .priority-selector {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .priority-btn {
      padding: 4px 8px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 6px;
      background: white;
      color: #737373;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .priority-btn:hover {
      background: #fafafa;
      border-color: #171717;
    }

    .priority-btn.active {
      background: #171717;
      border-color: #171717;
      color: #ffffff;
    }

    .tasks-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .task-item {
      background: white;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .task-item:hover {
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .task-item.completed {
      opacity: 0.5;
      background: #fafafa;
    }

    .task-item.completed .task-title {
      text-decoration: line-through;
      color: #a3a3a3;
    }

    .task-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    .task-checkbox:hover {
      border-color: #171717;
    }

    .task-checkbox.checked {
      background: #171717;
      border-color: #171717;
    }

    .task-checkbox.checked::after {
      content: '‚úì';
      color: white;
      font-size: 11px;
      font-weight: bold;
    }

    .task-title {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
      color: #171717;
    }

    .task-priority {
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .task-priority.urgent {
      background: rgba(255, 59, 48, 0.2);
      color: #FF3B30;
      border: 1px solid rgba(255, 59, 48, 0.3);
    }

    .task-priority.high {
      background: rgba(255, 159, 10, 0.2);
      color: #FF9F0A;
      border: 1px solid rgba(255, 159, 10, 0.3);
    }

    .task-priority.medium {
      background: rgba(0, 122, 255, 0.2);
      color: #007AFF;
      border: 1px solid rgba(0, 122, 255, 0.3);
    }

    .task-priority.low {
      background: rgba(142, 142, 147, 0.2);
      color: #8E8E93;
      border: 1px solid rgba(142, 142, 147, 0.3);
    }

    .task-actions {
      display: flex;
      gap: 8px;
    }

    .task-action-btn {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 5px;
      background: #fafafa;
      color: #737373;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 12px;
    }

    .task-action-btn:hover {
      background: #f0f0f0;
      color: #171717;
    }

    .task-action-btn.delete:hover {
      background: rgba(255, 59, 48, 0.1);
      color: #FF3B30;
    }

    .task-description {
      margin-top: 6px;
      font-size: 12px;
      color: #737373;
      line-height: 1.4;
      padding-left: 24px;
    }

    .task-meta {
      margin-top: 8px;
      padding-left: 24px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 10px;
    }

    .task-assignor,
    .task-assignee {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
    }

    .task-assignor {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .task-assignee {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .task-date {
      color: #a3a3a3;
    }

    /* Task Chat Button */
    .task-action-btn.chat {
      background: #fafafa;
      color: #737373;
      font-size: 14px;
    }
    
    .task-action-btn.chat:hover {
      background: #f0f0f0;
      color: #171717;
      transform: scale(1.05);
    }
    
    /* Task Chat Modal - Light Theme */
    .task-chat-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .task-chat-container {
      width: 90%;
      max-width: 700px;
      height: 80vh;
      max-height: 600px;
      background: white;
      border-radius: 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .task-chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      flex-shrink: 0;
      background: white;
    }
    
    .task-chat-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .task-chat-icon {
      width: 20px;
      height: 20px;
      color: #737373;
    }
    
    .task-chat-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .task-chat-name {
      font-size: 16px;
      font-weight: 600;
      color: #171717;
    }
    
    .task-chat-subtitle {
      font-size: 12px;
      color: #737373;
    }
    
    .task-chat-close {
      background: rgba(0, 0, 0, 0.05);
      border: none;
      color: #737373;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .task-chat-close:hover {
      background: rgba(255, 59, 48, 0.1);
      color: #FF3B30;
    }
    
    .task-chat-context {
      padding: 16px 24px;
      background: rgba(0, 0, 0, 0.02);
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      flex-shrink: 0;
    }
    
    .task-context-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: #737373;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }
    
    .task-context-content {
      font-size: 14px;
      color: #171717;
      line-height: 1.5;
    }
    
    .task-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: #fafafa;
    }
    
    .task-chat-welcome {
      text-align: center;
      padding: 40px 20px;
      color: #737373;
    }
    
    .task-chat-welcome .welcome-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .task-chat-welcome .welcome-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #171717;
    }
    
    .task-chat-welcome .welcome-subtitle {
      font-size: 14px;
      color: #a3a3a3;
    }
    
    .task-message {
      display: flex;
      flex-direction: column;
      gap: 8px;
      animation: messageSlideIn 0.3s ease;
    }
    
    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .task-message.user {
      align-items: flex-end;
    }
    
    .task-message.assistant {
      align-items: flex-start;
    }
    
    .task-message-bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    
    .task-message.user .task-message-bubble {
      background: #171717;
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .task-message.assistant .task-message-bubble {
      background: white;
      color: #171717;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-bottom-left-radius: 4px;
    }
    
    .task-message-time {
      font-size: 11px;
      color: #a3a3a3;
      padding: 0 8px;
    }
    
    .task-chat-typing {
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: #737373;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      background: white;
    }
    
    .task-chat-input {
      padding: 16px 24px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      background: white;
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-shrink: 0;
    }
    
    .task-chat-textarea {
      flex: 1;
      background: #fafafa;
      border: 1.5px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      padding: 12px 16px;
      color: #171717;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      transition: all 0.2s ease;
    }
    
    .task-chat-textarea:focus {
      outline: none;
      border-color: #171717;
      background: white;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.04);
    }
    
    .task-chat-textarea::placeholder {
      color: #a3a3a3;
    }
    
    .task-chat-send {
      background: #171717;
      border: none;
      color: white;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .task-chat-send:hover {
      background: #0a0a0a;
      transform: scale(1.05);
    }
    
    .task-chat-send:active {
      transform: scale(0.95);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 212, 255, 0.3);
      border-radius: 3px;
    }

    /* User dropdown styles */
    .user-dropdown {
      position: relative;
      display: inline-block;
    }

    .user-dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: rgba(10, 10, 15, 0.98);
      backdrop-filter: blur(20px);
      min-width: 160px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 8px;
      z-index: 10000;
      margin-top: 8px;
      overflow: hidden;
    }

    .user-dropdown-content.show {
      display: block;
    }

    .user-dropdown-item {
      color: rgba(255, 255, 255, 0.9);
      padding: 12px 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .user-dropdown-item:hover {
      background: rgba(0, 212, 255, 0.1);
      color: #00d4ff;
    }

    .user-dropdown-item svg {
      width: 14px;
      height: 14px;
    }

    #appTitle {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      position: relative;
      z-index: 10;
    }

    #appTitle:hover {
      color: #00d4ff;
    }

    .copilot-title {
      -webkit-app-region: drag;
    }

    .user-dropdown {
      -webkit-app-region: no-drag;
      z-index: 100;
    }
  </style>
</head>
<body class="collapsed">
  <div class="copilot-header">
    <div class="copilot-title" id="dragHandle">
      <img src="../../Jarvis.png" alt="Jarvis" class="copilot-icon">
      <div class="user-dropdown">
        <span id="appTitle" onclick="toggleUserDropdown()">HeyJarvis</span>
        <div id="userDropdown" class="user-dropdown-content">
          <button class="user-dropdown-item" onclick="handleLogout()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Log Out
          </button>
        </div>
      </div>
    </div>
    
    <div class="header-input-wrapper">
      <input 
        type="text" 
        class="header-input" 
        id="headerInput" 
        placeholder="Ask me anything..." 
        autocomplete="off"
      >
      <button class="header-input-send-btn" id="headerSendBtn" onclick="sendHeaderMessage()" title="Send message">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
    
    <div class="header-actions">
      <button class="header-nav-btn" onclick="switchTab('chat')" id="chatNavBtn" title="Chat">
        Chat
      </button>
      <button class="header-nav-btn" onclick="switchTab('tasks')" id="tasksNavBtn" title="Tasks">
        Tasks
        <span class="nav-badge" id="tasksBadge" style="display: none;"></span>
      </button>
      <div class="header-divider"></div>
      <button class="header-action-btn" onclick="switchTab('tasks')" title="Notifications">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <span class="notification-badge" id="notificationBadge" style="display: none;"></span>
      </button>
      <button class="header-action-btn" onclick="startFactCheck()" title="Fact Check">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </button>
      <button class="ms-auth-btn" id="msAuthBtn" onclick="toggleMicrosoftAuth()" title="Microsoft 365">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M11.4 24H0V12.6h11.4V24zM24 24H12.6V12.6H24V24zM11.4 11.4H0V0h11.4v11.4zm12.6 0H12.6V0H24v11.4z"/>
        </svg>
        <span class="ms-status-dot"></span>
      </button>

    </div>
    
    <div class="copilot-controls">
      <button class="control-btn minimize" onclick="collapseTopBar()" title="Collapse">‚àí</button>
      <button class="control-btn close" onclick="closeWindow()" title="Hide">√ó</button>
    </div>
  </div>


  <div class="copilot-content">
    <!-- Copilot Tab -->
    <div id="copilotTab" class="tab-content active">
      <div class="chat-interface">
        <div class="chat-container" id="chatContainer">
          <div class="welcome-message">
            <img src="../../Jarvis.png" alt="HeyJarvis" class="welcome-logo">
            <div class="welcome-text">
              We are your Mission Control.
              <div class="welcome-subtitle">How can we help you today?</div>
            </div>
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <div>‚ú®</div>
          <div>
            <span>HeyJarvis is thinking</span>
            <div style="display: inline-flex; gap: 6px; margin-left: 12px;">
              <div style="width: 8px; height: 8px; background: #007AFF; border-radius: 50%;"></div>
              <div style="width: 8px; height: 8px; background: #007AFF; border-radius: 50%;"></div>
              <div style="width: 8px; height: 8px; background: #007AFF; border-radius: 50%;"></div>
            </div>
          </div>
        </div>

        <div class="input-container">
          <div class="input-wrapper">
            <textarea class="message-input" id="messageInput" placeholder="Ask me anything..." rows="1"></textarea>
            <button class="send-btn" onclick="sendMessage()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="m3 3 18 9-18 9V3z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tasks Tab -->
    <div id="tasksTab" class="tab-content">
      <div class="tasks-container">
        <div class="tasks-header">
          <div class="tasks-title">‚úì My Tasks</div>
          <div class="task-stats">
            <div class="stat-item">
              <div class="stat-dot todo"></div>
              <span id="todoCount">0</span> To Do
            </div>
            <div class="stat-item">
              <div class="stat-dot in-progress"></div>
              <span id="inProgressCount">0</span> In Progress
            </div>
            <div class="stat-item">
              <div class="stat-dot completed"></div>
              <span id="completedCount">0</span> Done
            </div>
          </div>
        </div>
        
        <div class="task-filter-section">
          <select id="assignmentFilter" class="assignment-filter" onchange="changeAssignmentView()">
            <option value="assigned_to_me">üì• Assigned to Me</option>
            <option value="assigned_by_me">üì§ Assigned by Me</option>
            <option value="all">üìã All Tasks</option>
          </select>
        </div>

        <div class="task-input-section">
          <div class="task-input-wrapper">
            <input type="text" id="taskInput" class="task-input" placeholder="What needs to be done?" onkeypress="if(event.key==='Enter') addTask()">
            <button class="add-task-btn" onclick="addTask()">+ Add Task</button>
          </div>
          <div class="priority-selector">
            <button class="priority-btn" onclick="selectPriority('low')">Low</button>
            <button class="priority-btn active" onclick="selectPriority('medium')">Medium</button>
            <button class="priority-btn" onclick="selectPriority('high')">High</button>
            <button class="priority-btn" onclick="selectPriority('urgent')">Urgent</button>
          </div>
        </div>

        <div class="tasks-list" id="tasksList">
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <div>No tasks yet. Add one above to get started!</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Chat Modal -->
  <div id="taskChatModal" class="task-chat-modal" style="display: none;">
    <div class="task-chat-container">
      <div class="task-chat-header">
        <div class="task-chat-title">
          <svg class="task-chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <div class="task-chat-info">
            <div class="task-chat-name" id="taskChatName">Task Discussion</div>
            <div class="task-chat-subtitle">AI-powered task assistant</div>
          </div>
        </div>
        <button class="task-chat-close" onclick="closeTaskChat()">√ó</button>
      </div>
      
      <div class="task-chat-context">
        <div class="task-context-label">Task Context:</div>
        <div class="task-context-content" id="taskChatContext"></div>
      </div>
      
      <div class="task-chat-messages" id="taskChatMessages">
        <div class="task-chat-welcome">
          <div class="welcome-icon">üéØ</div>
          <div class="welcome-text">Let's work on this task together!</div>
          <div class="welcome-subtitle">I can help you brainstorm, plan, and complete this task.</div>
        </div>
      </div>
      
      <div class="task-chat-typing" id="taskChatTyping" style="display: none;">
        <div>‚ú®</div>
        <div>
          <span>Thinking about your task...</span>
        </div>
      </div>
      
      <div class="task-chat-input">
        <textarea 
          id="taskChatInput" 
          class="task-chat-textarea" 
          placeholder="Ask about this task, brainstorm ideas, get help..." 
          rows="1"
        ></textarea>
        <button class="task-chat-send" onclick="sendTaskChatMessage()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m22 2-7 20-4-9-9-4z"/>
            <path d="M22 2 11 13"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentTab = 'copilot';
    let currentPriority = 'medium';
    let tasks = [];
    let isExpanded = false;
    let chatHistory = [];
    let crmData = null;
    let slackConnected = false;
    let servicesInitialized = false;
    let currentTaskChat = null;
    let taskChatHistories = {}; // Store chat history for each task

    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const headerInput = document.getElementById('headerInput');
    const typingIndicator = document.getElementById('typingIndicator');

    // Tab switching
    function switchTab(tab) {
      currentTab = tab;
      
      // Expand interface when switching tabs
      if (!isExpanded) expandTopBar();
      
      // Update navigation buttons
      document.querySelectorAll('.header-nav-btn').forEach(btn => btn.classList.remove('active'));
      const navMap = { 'chat': 'chatNavBtn', 'copilot': 'chatNavBtn', 'tasks': 'tasksNavBtn' };
      const targetBtn = document.getElementById(navMap[tab]);
      if (targetBtn) targetBtn.classList.add('active');
      
      // Update content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      const contentMap = { 'chat': 'copilotTab', 'copilot': 'copilotTab', 'tasks': 'tasksTab' };
      const targetContent = document.getElementById(contentMap[tab]);
      if (targetContent) targetContent.classList.add('active');
      
      if (tab === 'tasks') {
        loadTasks();
      }
    }

    // Priority selection
    function selectPriority(priority) {
      currentPriority = priority;
      document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    // Task management
    async function addTask() {
      const input = document.getElementById('taskInput');
      const title = input.value.trim();
      
      if (!title) return;
      
      if (!window.electronAPI || !window.electronAPI.tasks) {
        console.warn('Task API not available');
        alert('Task functionality requires the desktop app');
        return;
      }
      
      try {
        const result = await window.electronAPI.tasks.create({
          title,
          priority: currentPriority
        });
        
        if (result.success) {
          input.value = '';
          await loadTasks();
        } else {
          console.error('Failed to create task:', result.error);
        }
      } catch (error) {
        console.error('Error creating task:', error);
      }
    }

    let currentAssignmentView = 'assigned_to_me';

    async function changeAssignmentView() {
      const filterSelect = document.getElementById('assignmentFilter');
      currentAssignmentView = filterSelect.value;
      console.log('üîÑ Changing assignment view to:', currentAssignmentView);
      await loadTasks();
    }

    async function loadTasks() {
      try {
        if (!window.electronAPI || !window.electronAPI.tasks) {
          console.warn('Task API not available');
          renderTasks(); // Show empty state
          return;
        }
        
        const result = await window.electronAPI.tasks.getAll({
          assignmentView: currentAssignmentView
        });
        
        if (result.success) {
          tasks = result.tasks;
          console.log(`üìã Loaded ${tasks.length} tasks for view: ${currentAssignmentView}`);
          await renderTasks();
          updateStats();
        } else {
          console.error('Failed to load tasks:', result.error);
          await renderTasks();
        }
      } catch (error) {
        console.error('Error loading tasks:', error);
        await renderTasks();
      }
    }

    // Cache for Slack user names
    const slackUserCache = new Map();

    async function getSlackUserName(slackUserId) {
      console.log('üîç getSlackUserName called with:', slackUserId);
      
      if (!slackUserId) {
        console.log('‚ö†Ô∏è No Slack user ID provided to getSlackUserName');
        return 'Unknown';
      }
      
      // Check cache first
      if (slackUserCache.has(slackUserId)) {
        console.log('‚úÖ Using cached name for:', slackUserId, '‚Üí', slackUserCache.get(slackUserId));
        return slackUserCache.get(slackUserId);
      }

      console.log('üîç Fetching name for Slack user:', slackUserId);

      // Fetch from Slack
      try {
        if (window.electronAPI && window.electronAPI.tasks && window.electronAPI.tasks.getSlackUserInfo) {
          console.log('‚úÖ electronAPI.tasks.getSlackUserInfo is available');
          const userInfo = await window.electronAPI.tasks.getSlackUserInfo(slackUserId);
          console.log('üì¶ Received user info:', userInfo);
          const name = userInfo.success ? userInfo.name : slackUserId;
          slackUserCache.set(slackUserId, name);
          console.log('‚úÖ Resolved', slackUserId, '‚Üí', name);
          return name;
        } else {
          console.error('‚ö†Ô∏è electronAPI.tasks.getSlackUserInfo not available!', {
            hasElectronAPI: !!window.electronAPI,
            hasTasks: !!(window.electronAPI && window.electronAPI.tasks),
            hasGetSlackUserInfo: !!(window.electronAPI && window.electronAPI.tasks && window.electronAPI.tasks.getSlackUserInfo)
          });
        }
      } catch (error) {
        console.error('‚ùå Error fetching Slack user info:', error);
      }

      console.log('‚ö†Ô∏è Falling back to ID:', slackUserId);
      return slackUserId; // Fallback to ID
    }

    // Helper function to resolve Slack mentions in text
    async function resolveSlackMentions(text) {
      if (!text) return text;
      
      // Find all Slack mentions in the format <@U12345678>
      const mentionPattern = /<@([A-Z0-9]+)>/g;
      const mentions = [...text.matchAll(mentionPattern)];
      
      if (mentions.length === 0) return text;
      
      console.log('üîç Found', mentions.length, 'mentions in text:', text);
      
      // Resolve all mentions
      let resolvedText = text;
      for (const match of mentions) {
        const userId = match[1];
        const userName = await getSlackUserName(userId);
        // Replace <@U12345678> with @Name
        resolvedText = resolvedText.replace(match[0], `@${userName}`);
      }
      
      console.log('‚úÖ Resolved mentions:', resolvedText);
      return resolvedText;
    }

    async function renderTasks() {
      console.log('üìã renderTasks called with', tasks.length, 'tasks');
      const tasksList = document.getElementById('tasksList');
      
      if (tasks.length === 0) {
        tasksList.innerHTML = `
          <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: #a3a3a3; margin-bottom: 16px;">
              <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"></path>
              <rect x="9" y="3" width="6" height="4" rx="1"></rect>
            </svg>
            <div>No tasks yet. Add one above to get started!</div>
          </div>
        `;
        return;
      }
      
      console.log('üîÑ Resolving user names and mentions for tasks...');
      // Resolve all user names and mentions first
      const tasksWithNames = await Promise.all(tasks.map(async (task, index) => {
        console.log(`üìù Task ${index + 1}:`, {
          title: task.title,
          assignor: task.assignor,
          assignee: task.assignee
        });
        
        const assignorName = task.assignor ? await getSlackUserName(task.assignor) : null;
        const assigneeName = task.assignee ? await getSlackUserName(task.assignee) : null;
        
        // Resolve mentions in title and description
        const resolvedTitle = await resolveSlackMentions(task.title);
        const resolvedDescription = await resolveSlackMentions(task.description);
        
        console.log(`‚úÖ Task ${index + 1} names resolved:`, {
          assignorName,
          assigneeName,
          resolvedTitle,
          resolvedDescription: resolvedDescription?.substring(0, 50) + '...'
        });
        
        return {
          ...task,
          title: resolvedTitle,
          description: resolvedDescription,
          assignorName,
          assigneeName
        };
      }));
      
      console.log('‚úÖ All names resolved, rendering', tasksWithNames.length, 'tasks');
      
      tasksList.innerHTML = tasksWithNames.map(task => `
        <div class="task-item ${task.status === 'completed' ? 'completed' : ''}">
          <div class="task-header">
            <div class="task-checkbox ${task.status === 'completed' ? 'checked' : ''}" 
                 onclick="toggleTask('${task.id}', '${task.status}')"></div>
            <div class="task-title">${escapeHtml(task.title)}</div>
            <div class="task-priority ${task.priority}">${task.priority}</div>
            <div class="task-actions">
              <button class="task-action-btn chat" onclick="openTaskChat('${task.id}')" title="AI Chat">üí¨</button>
              <button class="task-action-btn delete" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
            </div>
          </div>
          ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
          <div class="task-meta">
            ${task.assignorName ? `<span class="task-assignor">üë§ From: ${escapeHtml(task.assignorName)}</span>` : ''}
            ${task.assigneeName ? `<span class="task-assignee">üëâ To: ${escapeHtml(task.assigneeName)}</span>` : ''}
            <span class="task-date">Created ${formatDate(task.created_at)}</span>
          </div>
        </div>
      `).join('');
    }

    async function toggleTask(taskId, currentStatus) {
      if (!window.electronAPI || !window.electronAPI.tasks) {
        console.warn('Task API not available');
        return;
      }
      
      try {
        const result = await window.electronAPI.tasks.toggle(taskId, currentStatus);
        if (result.success) await loadTasks();
      } catch (error) {
        console.error('Error toggling task:', error);
      }
    }

    async function deleteTask(taskId) {
      if (!confirm('Delete this task?')) return;
      
      if (!window.electronAPI || !window.electronAPI.tasks) {
        console.warn('Task API not available');
        return;
      }
      
      try {
        const result = await window.electronAPI.tasks.delete(taskId);
        if (result.success) await loadTasks();
      } catch (error) {
        console.error('Error deleting task:', error);
      }
    }

    function updateStats() {
      const todoCount = tasks.filter(t => t.status === 'todo').length;
      const inProgressCount = tasks.filter(t => t.status === 'in_progress').length;
      const completedCount = tasks.filter(t => t.status === 'completed').length;
      
      document.getElementById('todoCount').textContent = todoCount;
      document.getElementById('inProgressCount').textContent = inProgressCount;
      document.getElementById('completedCount').textContent = completedCount;
      
      const badge = document.getElementById('taskBadge');
      const activeCount = todoCount + inProgressCount;
      if (activeCount > 0) {
        badge.textContent = activeCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    // Chat functionality
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      await processChatMessage(message);
      messageInput.value = '';
      messageInput.style.height = 'auto';
    }

    async function sendHeaderMessage() {
      const inputElement = document.getElementById('headerInput');
      if (!inputElement) {
        console.error('‚ùå Header input element not found');
        return;
      }
      
      const message = inputElement.value.trim();
      if (!message) {
        console.log('üì≠ No message to send');
        return;
      }

      console.log('üì§ Sending message:', message);
      
      // Expand when user sends a message
      if (!isExpanded) {
        console.log('üîç Expanding top bar...');
        expandTopBar();
      }
      
      // Switch to chat tab
      switchTab('chat');

      await processChatMessage(message);
      inputElement.value = '';
      
      // Remove has-text class from send button
      const sendBtn = document.getElementById('headerSendBtn');
      if (sendBtn) {
        sendBtn.classList.remove('has-text');
      }
    }

    async function processChatMessage(message) {
      addMessage(message, 'user');
      showTypingIndicator();

      try {
        let response;
        if (window.electronAPI) {
          response = await window.electronAPI.sendMessage(message);
        } else {
          response = {
            content: 'I\'m here to help! What would you like to know?',
            timestamp: new Date().toISOString()
          };
        }

        hideTypingIndicator();
        addMessage(response.content, 'assistant');
      } catch (error) {
        console.error('Error sending message:', error);
        hideTypingIndicator();
        addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
      }
    }

    function sendQuickMessage(message) {
      if (isExpanded && messageInput) {
        messageInput.value = message;
        sendMessage();
      } else if (headerChatInput) {
        headerChatInput.value = message;
        sendHeaderMessage();
      }
    }

    function addMessage(content, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const avatar = sender === 'user' ? 'üë§' : 'ü§ñ';
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
          ${content}
          <div style="font-size: 11px; color: rgba(255, 255, 255, 0.4); margin-top: 4px;">${time}</div>
        </div>
      `;
      
      const welcomeMessage = chatContainer.querySelector('.welcome-message');
      if (welcomeMessage) welcomeMessage.remove();
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      chatHistory.push({ content, sender, timestamp: new Date().toISOString() });
    }

    function showTypingIndicator() {
      typingIndicator.style.display = 'flex';
    }

    function hideTypingIndicator() {
      typingIndicator.style.display = 'none';
    }

    // Window controls
    function collapseTopBar() {
      isExpanded = false;
      document.body.classList.remove('expanded');
      document.body.classList.add('collapsed');
      
      if (window.electronAPI?.collapseTopBar) {
        window.electronAPI.collapseTopBar();
      }
    }

    function expandTopBar() {
      console.log('üîç expandTopBar() called, isExpanded:', isExpanded);
      isExpanded = true;
      document.body.classList.remove('collapsed');
      document.body.classList.add('expanded');
      console.log('‚úÖ Body classes updated:', document.body.classList.toString());
      
      if (window.electronAPI?.expandTopBar) {
        console.log('üì° Calling electron expandTopBar API...');
        window.electronAPI.expandTopBar();
      } else {
        console.warn('‚ö†Ô∏è electron expandTopBar API not available');
      }
    }

    function closeWindow() {
      if (window.electronAPI) {
        window.electronAPI.closeWindow();
      } else {
        window.close();
      }
    }


    function startFactCheck() {
      if (window.electronAPI?.startFactCheck) {
        window.electronAPI.startFactCheck();
      } else {
        console.log('Fact check initiated - screen capture will start');
        // Placeholder for fact check functionality
      }
    }

    // User dropdown functions
    function toggleUserDropdown() {
      console.log('üîΩ Toggle dropdown clicked');
      const dropdown = document.getElementById('userDropdown');
      console.log('üîΩ Dropdown element:', dropdown);
      if (dropdown) {
        dropdown.classList.toggle('show');
        console.log('üîΩ Dropdown classes:', dropdown.className);
      } else {
        console.error('‚ùå Dropdown element not found!');
      }
    }

    // Close dropdown if clicking outside
    window.addEventListener('click', function(event) {
      if (!event.target.matches('#appTitle')) {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown && dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
        }
      }
    });

    async function handleLogout() {
      try {
        console.log('üö™ Logging out...');
        
        // Close dropdown
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.remove('show');
        
        // Call logout API
        if (window.electronAPI?.auth?.signOut) {
          await window.electronAPI.auth.signOut();
          console.log('‚úÖ Logged out successfully');
        } else {
          console.error('‚ùå Logout API not available');
        }
      } catch (error) {
        console.error('‚ùå Logout failed:', error);
      }
    }

    // Services initialization
    async function initializeServices() {
      if (servicesInitialized) return;
      servicesInitialized = true;
      
      if (!window.electronAPI) return;
      
      try {
        if (window.electronAPI.slack?.startMonitoring) {
          const result = await window.electronAPI.slack.startMonitoring();
          if (result.success) {
            slackConnected = true;
            document.getElementById('slackStatusDot').classList.add('online');
          }
        }
        
        if (window.electronAPI.getCRMData) {
          const response = await window.electronAPI.getCRMData();
          if (response.success) {
            crmData = response.data;
            document.getElementById('crmStatusDot').classList.add('online');
          }
        }
      } catch (error) {
        console.error('Service initialization error:', error);
      }
    }

    // Fact checking
    async function startFactCheck() {
      addMessage('üîç Starting fact check...', 'assistant');
      showTypingIndicator();
      
      try {
        if (window.electronAPI?.factCheck) {
          // Implement fact checking logic
        }
      } catch (error) {
        console.error('Fact check error:', error);
      } finally {
        hideTypingIndicator();
      }
    }

    // Helper functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      
      return date.toLocaleDateString();
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
    }

    // ===== TASK CHAT FUNCTIONS =====
    
    async function openTaskChat(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      
      currentTaskChat = task;
      
      // Update modal title and context
      document.getElementById('taskChatName').textContent = task.title;
      document.getElementById('taskChatContext').innerHTML = `
        <strong>${escapeHtml(task.title)}</strong>
        ${task.description ? `<br>${escapeHtml(task.description)}` : ''}
        <br><span style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">
          Priority: ${task.priority} ‚Ä¢ Status: ${task.status}
        </span>
      `;
      
      // Load chat history from Supabase if not already in memory
      if (!taskChatHistories[taskId]) {
        const messagesContainer = document.getElementById('taskChatMessages');
        messagesContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
            <div style="font-size: 24px; margin-bottom: 10px;">üí¨</div>
            <div>Loading chat history...</div>
          </div>
        `;
        
        try {
          console.log('üìú Loading chat history for task:', taskId);
          const result = await window.electronAPI.tasks.getChatHistory(taskId);
          
          if (result.success && result.messages.length > 0) {
            taskChatHistories[taskId] = result.messages;
            console.log(`‚úÖ Loaded ${result.messages.length} messages for task ${taskId}`);
          } else {
            taskChatHistories[taskId] = [];
            console.log('üìù No existing chat history, starting fresh');
          }
        } catch (error) {
          console.error('‚ùå Failed to load task chat history:', error);
          taskChatHistories[taskId] = [];
        }
      }
      
      // Render the chat history
      renderTaskChatHistory(taskId);
      
      // Show modal
      document.getElementById('taskChatModal').style.display = 'flex';
      
      // Focus input after a brief delay to allow animation
      setTimeout(() => {
        document.getElementById('taskChatInput').focus();
      }, 100);
    }
    
    function closeTaskChat() {
      document.getElementById('taskChatModal').style.display = 'none';
      currentTaskChat = null;
    }
    
    function renderTaskChatHistory(taskId) {
      const messagesContainer = document.getElementById('taskChatMessages');
      const history = taskChatHistories[taskId] || [];
      
      if (history.length === 0) {
        messagesContainer.innerHTML = `
          <div class="task-chat-welcome">
            <div class="welcome-icon">üéØ</div>
            <div class="welcome-text">Let's work on this task together!</div>
            <div class="welcome-subtitle">I can help you brainstorm, plan, and complete this task.</div>
          </div>
        `;
      } else {
        messagesContainer.innerHTML = history.map(msg => `
          <div class="task-message ${msg.role}">
            <div class="task-message-bubble">${escapeHtml(msg.content)}</div>
            <div class="task-message-time">${formatTime(msg.timestamp)}</div>
          </div>
        `).join('');
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }
    
    async function sendTaskChatMessage() {
      if (!currentTaskChat) return;
      
      const input = document.getElementById('taskChatInput');
      const message = input.value.trim();
      if (!message) return;
      
      const taskId = currentTaskChat.id;
      
      // Initialize chat history for this task if needed
      if (!taskChatHistories[taskId]) {
        taskChatHistories[taskId] = [];
      }
      
      // Add user message to history
      const userMessage = {
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
      };
      taskChatHistories[taskId].push(userMessage);
      
      // Clear input and update UI
      input.value = '';
      input.style.height = 'auto';
      renderTaskChatHistory(taskId);
      
      // Show typing indicator
      document.getElementById('taskChatTyping').style.display = 'flex';
      
      try {
        // Call backend API with task context
        if (!window.electronAPI || !window.electronAPI.copilot) {
          throw new Error('Electron API not available');
        }
        
        const response = await window.electronAPI.copilot.sendTaskMessage(taskId, message, {
          task: currentTaskChat,
          conversationHistory: taskChatHistories[taskId] || []
        });
        
        // Add AI response to history
        const assistantMessage = {
          role: 'assistant',
          content: response.content || response,
          timestamp: new Date().toISOString()
        };
        taskChatHistories[taskId].push(assistantMessage);
        
        // Update UI
        renderTaskChatHistory(taskId);
        
      } catch (error) {
        console.error('Task chat error:', error);
        
        // Add error message
        const errorMessage = {
          role: 'assistant',
          content: 'Sorry, I encountered an error. Please try again.',
          timestamp: new Date().toISOString()
        };
        taskChatHistories[taskId].push(errorMessage);
        renderTaskChatHistory(taskId);
      } finally {
        // Hide typing indicator
        document.getElementById('taskChatTyping').style.display = 'none';
      }
    }

    // Auto-resize textarea
    if (messageInput) {
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    if (headerInput) {
      const headerSendBtn = document.getElementById('headerSendBtn');
      
      // Show/hide send button based on input content
      headerInput.addEventListener('input', function() {
        if (this.value.trim() && headerSendBtn) {
          headerSendBtn.classList.add('has-text');
        } else if (headerSendBtn) {
          headerSendBtn.classList.remove('has-text');
        }
      });
      
      headerInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendHeaderMessage();
        }
      });
    }

    // Load user info and update UI
    async function loadUserInfo() {
      try {
        console.log('üîç Checking for user info...');
        
        if (window.electronAPI && window.electronAPI.auth) {
          const user = await window.electronAPI.auth.getUser();
          console.log('üë§ User data received:', user);
          console.log('üÜî Slack User ID:', user?.slack_user_id);
          console.log('üìß Email:', user?.email);
          console.log('üë§ Name:', user?.name);
          
          if (user) {
            // Update the title to show "Hey [Name] (Slack ID)"
            const appTitle = document.getElementById('appTitle');
            if (appTitle) {
              // Try different name sources
              let displayName = user.name || user.email?.split('@')[0] || 'Jarvis';
              
              // If it's an email, extract the part before @
              if (displayName.includes('@')) {
                displayName = displayName.split('@')[0];
              }
              
              // Get first name only if it has spaces
              const firstName = displayName.split(' ')[0];
              
              // Capitalize first letter
              const capitalizedName = firstName.charAt(0).toUpperCase() + firstName.slice(1);
              
              // Add Slack ID for debugging
              const slackId = user.slack_user_id || 'NO_SLACK_ID';
              appTitle.textContent = `Hey ${capitalizedName} (${slackId})`;
              console.log('‚úÖ Title updated to: Hey', capitalizedName, `(${slackId})`);
            }
          } else {
            console.warn('‚ö†Ô∏è No user data found');
          }
        } else {
          console.warn('‚ö†Ô∏è electronAPI.auth not available');
        }
      } catch (error) {
        console.error('‚ùå Failed to load user info:', error);
        // Keep default "HeyJarvis" title on error
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ HeyJarvis loaded');
      
      // Load user info and update title
      await loadUserInfo();
      
      initializeServices();
      
      // Set initial active nav button
      const chatNavBtn = document.getElementById('chatNavBtn');
      if (chatNavBtn) chatNavBtn.classList.add('active');
      
      // Setup task chat input handlers
      const taskChatInput = document.getElementById('taskChatInput');
      if (taskChatInput) {
        taskChatInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        taskChatInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendTaskChatMessage();
          }
        });
      }
      
      // Close task chat modal on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && currentTaskChat) {
          closeTaskChat();
        }
      });
    });


    // ===== MICROSOFT 365 AUTHENTICATION =====
    let microsoftConnected = false;
    let microsoftUser = null;

    async function toggleMicrosoftAuth() {
      if (microsoftConnected) {
        const confirmed = confirm(`Disconnect from Microsoft 365 (${microsoftUser})?`);
        if (confirmed) {
          microsoftConnected = false;
          microsoftUser = null;
          updateMicrosoftButton();
        }
      } else {
        document.getElementById('msAuthModal').classList.add('show');
      }
    }

    function closeMicrosoftModal() {
      document.getElementById('msAuthModal').classList.remove('show');
    }

    async function authenticateMicrosoft() {
      try {
        console.log('üîê Starting Microsoft authentication...');
        const modal = document.getElementById('msAuthModal');
        const content = modal.querySelector('.ms-auth-content');
        content.innerHTML = `
          <h3>Authenticating...</h3>
          <p style="text-align: center;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: msSpinAnimation 1s linear infinite;">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 6v6l4 2"></path>
            </svg>
          </p>
          <p>Opening your browser for authentication...</p>
        `;
        
        const result = await window.electronAPI.microsoft.authenticate();
        
        if (result.success) {
          console.log('‚úÖ Microsoft authenticated:', result.account);
          microsoftConnected = true;
          microsoftUser = result.account.username;
          updateMicrosoftButton();
          
          content.innerHTML = `
            <h3>‚úÖ Connected!</h3>
            <p>Successfully connected to Microsoft 365 as <strong>${result.account.username}</strong></p>
            <div class="ms-auth-actions">
              <button class="ms-auth-primary" onclick="closeMicrosoftModal()" style="width: 100%;">Done</button>
            </div>
          `;
          
          setTimeout(() => closeMicrosoftModal(), 2000);
        } else {
          throw new Error(result.error || 'Authentication failed');
        }
      } catch (error) {
        console.error('‚ùå Microsoft authentication failed:', error);
        const content = document.querySelector('.ms-auth-content');
        content.innerHTML = `
          <h3>‚ùå Authentication Failed</h3>
          <p style="color: #ef4444;">${error.message}</p>
          <div class="ms-auth-actions">
            <button class="ms-auth-secondary" onclick="closeMicrosoftModal()">Close</button>
            <button class="ms-auth-primary" onclick="authenticateMicrosoft()">Try Again</button>
          </div>
        `;
      }
    }

    function updateMicrosoftButton() {
      const btn = document.getElementById('msAuthBtn');
      if (microsoftConnected) {
        btn.classList.add('connected');
        btn.title = `Microsoft 365 Connected (${microsoftUser}) - Click to disconnect`;
      } else {
        btn.classList.remove('connected');
        btn.title = 'Connect Microsoft 365';
      }
    }

    async function checkMicrosoftConnection() {
      try {
        if (window.electronAPI?.microsoft?.getUserProfile) {
          const result = await window.electronAPI.microsoft.getUserProfile();
          if (result.success) {
            microsoftConnected = true;
            microsoftUser = result.user.mail || result.user.userPrincipalName;
            updateMicrosoftButton();
            console.log('‚úÖ Microsoft 365 already connected:', microsoftUser);
          }
        }
      } catch (error) {
        console.log('‚ÑπÔ∏è Microsoft 365 not connected');
      }
    }

    setTimeout(checkMicrosoftConnection, 1000);

    // ===== MEETING APPROVAL SYSTEM =====
    let pendingMeeting = null;

    function showMeetingApproval(meetingData) {
      pendingMeeting = meetingData;
      const modal = document.getElementById('meetingApprovalModal');
      const detailsDiv = document.getElementById('meetingDetails');
      
      // Format the meeting time
      const startTime = new Date(meetingData.startTime);
      const endTime = new Date(meetingData.endTime);
      const timeOptions = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        timeZone: meetingData.timeZone || 'America/Denver'
      };
      
      detailsDiv.innerHTML = `
        <div style="margin-bottom: 12px;">
          <strong style="color: #666; font-size: 12px; text-transform: uppercase;">Subject</strong>
          <div style="font-size: 16px; font-weight: 600; margin-top: 4px;">${meetingData.subject}</div>
        </div>
        <div style="margin-bottom: 12px;">
          <strong style="color: #666; font-size: 12px; text-transform: uppercase;">When</strong>
          <div style="font-size: 14px; margin-top: 4px;">
            ${startTime.toLocaleString('en-US', timeOptions)}
          </div>
          <div style="font-size: 13px; color: #666; margin-top: 2px;">
            Duration: ${Math.round((endTime - startTime) / 60000)} minutes
          </div>
        </div>
        ${meetingData.attendeeList && meetingData.attendeeList.length > 0 ? `
          <div style="margin-bottom: 12px;">
            <strong style="color: #666; font-size: 12px; text-transform: uppercase;">Attendees (To Be Added Manually)</strong>
            <div style="font-size: 14px; margin-top: 4px;">
              ${meetingData.attendeeList.map(email => `
                <div style="display: flex; align-items: center; margin-top: 4px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  ${email}
                </div>
              `).join('')}
            </div>
            <div style="font-size: 12px; color: #f59e0b; margin-top: 8px; padding: 8px; background: #fffbeb; border-radius: 4px;">
              üí° These attendees will NOT be added automatically to avoid email delivery issues. You can add them in Outlook or share the Teams link directly.
            </div>
          </div>
        ` : ''}
        ${meetingData.isOnlineMeeting ? `
          <div style="margin-bottom: 12px;">
            <strong style="color: #666; font-size: 12px; text-transform: uppercase;">Meeting Type</strong>
            <div style="font-size: 14px; margin-top: 4px; display: flex; align-items: center;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#5B5FC7" stroke-width="2" style="margin-right: 6px;">
                <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                <polyline points="17 2 12 7 7 2"></polyline>
              </svg>
              <span style="color: #5B5FC7; font-weight: 500;">Microsoft Teams Online Meeting</span>
            </div>
          </div>
        ` : ''}
        ${meetingData.body ? `
          <div style="margin-bottom: 12px;">
            <strong style="color: #666; font-size: 12px; text-transform: uppercase;">Description</strong>
            <div style="font-size: 13px; margin-top: 4px; color: #666;">${meetingData.body}</div>
          </div>
        ` : ''}
      `;
      
      modal.style.display = 'flex';
      modal.classList.add('show');
    }

    async function approveMeeting() {
      if (!pendingMeeting) return;
      
      const modal = document.getElementById('meetingApprovalModal');
      const content = modal.querySelector('.ms-auth-content');
      
      // Show loading state
      content.innerHTML = `
        <h3>Creating Meeting...</h3>
        <p style="text-align: center;">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: msSpinAnimation 1s linear infinite;">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
        </p>
        <p>Creating calendar event and sending invitations...</p>
      `;
      
      try {
        // Call the backend to create the meeting
        console.log('üîÑ Creating meeting with data:', pendingMeeting);
        const result = await window.electronAPI.microsoft.createEvent(pendingMeeting);
        console.log('üìÖ Meeting creation result:', result);
        
        if (result.success) {
          // Extract meeting link from various possible locations
          const meetingLink = result.meetingLink 
            || result.event?.onlineMeeting?.joinUrl 
            || result.event?.webLink;
          
          console.log('‚úÖ Meeting created successfully!', {
            eventId: result.event?.id,
            meetingLink: meetingLink,
            subject: result.event?.subject
          });
          
          content.innerHTML = `
            <h3>‚úÖ Meeting Created!</h3>
            <p>The calendar event has been created on your calendar${meetingLink ? ' with a Teams meeting link' : ''}.</p>
            ${meetingLink ? `
              <div style="background: #f0f9ff; border: 1px solid #0ea5e9; padding: 12px; border-radius: 6px; margin: 16px 0;">
                <strong style="color: #0369a1;">üìã Teams Meeting Link:</strong>
                <div style="font-size: 12px; word-break: break-all; margin-top: 6px; color: #0369a1; user-select: all;">
                  ${meetingLink}
                </div>
                <button onclick="navigator.clipboard.writeText('${meetingLink}'); this.textContent='‚úì Copied!'" style="margin-top: 8px; padding: 6px 12px; background: #0ea5e9; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Copy Link
                </button>
              </div>
            ` : `
              <div style="background: #fffbeb; border: 1px solid #f59e0b; padding: 12px; border-radius: 6px; margin: 16px 0; font-size: 13px;">
                <strong style="color: #d97706;">‚ö†Ô∏è Teams Link Not Available Yet</strong>
                <p style="margin: 8px 0 0 0; color: #92400e;">The meeting was created but the Teams link may take a moment to generate. Check the meeting in your Outlook calendar in a few seconds.</p>
              </div>
            `}
            <div style="background: #fffbeb; border: 1px solid #f59e0b; padding: 12px; border-radius: 6px; margin: 16px 0; font-size: 13px;">
              <strong style="color: #d97706;">Next Steps:</strong>
              <ol style="margin: 8px 0 0 20px; color: #92400e;">
                ${meetingLink ? '<li>Copy the Teams link above</li>' : '<li>Open the meeting in Outlook to get the Teams link</li>'}
                <li>Share it with attendees via email, Slack, or any messaging app</li>
                <li>Or add attendees directly in Outlook</li>
              </ol>
            </div>
            <div class="ms-auth-actions">
              <button class="ms-auth-primary" onclick="closeMeetingApproval()" style="width: 100%;">Done</button>
            </div>
          `;
          
          // Don't auto-close if there's no meeting link yet
          if (meetingLink) {
            setTimeout(() => closeMeetingApproval(), 5000);
          }
        } else {
          throw new Error(result.error || 'Failed to create meeting');
        }
      } catch (error) {
        console.error('‚ùå Failed to create meeting:', error);
        content.innerHTML = `
          <h3>‚ùå Meeting Creation Failed</h3>
          <p style="color: #ef4444;">${error.message}</p>
          <p style="font-size: 13px; color: #666; margin-top: 12px;">The meeting was not created. Please try again or create it manually in Outlook.</p>
          <div class="ms-auth-actions">
            <button class="ms-auth-secondary" onclick="closeMeetingApproval()">Close</button>
            <button class="ms-auth-primary" onclick="retryMeetingCreation()">Try Again</button>
          </div>
        `;
      }
    }

    function retryMeetingCreation() {
      if (pendingMeeting) {
        showMeetingApproval(pendingMeeting);
      }
    }

    function rejectMeeting() {
      pendingMeeting = null;
      closeMeetingApproval();
      
      // Optionally add a message to chat
      addMessage('Meeting creation cancelled.', 'assistant');
    }

    function closeMeetingApproval() {
      const modal = document.getElementById('meetingApprovalModal');
      modal.style.display = 'none';
      modal.classList.remove('show');
      pendingMeeting = null;
    }

    // Listen for meeting approval requests from main process
    if (window.electronAPI && window.electronAPI.onMeetingApprovalRequest) {
      window.electronAPI.onMeetingApprovalRequest((meetingData) => {
        showMeetingApproval(meetingData);
      });
    }

  </script>

  <!-- Microsoft 365 Auth Modal -->
  <div class="ms-auth-modal" id="msAuthModal">
    <div class="ms-auth-content">
      <h3>Connect Microsoft 365</h3>
      <p>Connect your Microsoft account to enable calendar automation, email notifications, and Teams integration.</p>
      <div class="ms-auth-actions">
        <button class="ms-auth-secondary" onclick="closeMicrosoftModal()">Cancel</button>
        <button class="ms-auth-primary" onclick="authenticateMicrosoft()">Connect</button>
      </div>
    </div>
  </div>

  <!-- Meeting Approval Modal -->
  <div class="ms-auth-modal" id="meetingApprovalModal" style="display: none;">
    <div class="ms-auth-content" style="max-width: 500px;">
      <h3>üìÖ Approve Meeting</h3>
      <div id="meetingDetails" style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin: 16px 0; text-align: left;">
        <!-- Meeting details will be inserted here -->
      </div>
      <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
        üí° <strong>Note:</strong> The meeting will be created on your calendar with a Teams link. Attendees are NOT added automatically to avoid email delivery issues. You can add them manually in Outlook or share the Teams link directly.
      </p>
      <div class="ms-auth-actions">
        <button class="ms-auth-secondary" onclick="rejectMeeting()">Cancel</button>
        <button class="ms-auth-primary" onclick="approveMeeting()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Create Meeting
        </button>
      </div>
    </div>
  </div>

</body>
</html>