<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: https: http://localhost:*; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' http://localhost:* https:;">
  <title>HeyJarvis</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=SF+Pro+Text:wght@300;400;500;600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: rgba(28, 28, 30, 0.95);
      color: #ffffff;
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(20px) saturate(180%);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 0.5px rgba(255, 255, 255, 0.1);
      border: 0.5px solid rgba(255, 255, 255, 0.08);
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    body.collapsed {
      height: 60px;
      background: rgba(28, 28, 30, 0.85);
    }

    body.expanded {
      height: 680px;
      background: rgba(28, 28, 30, 0.95);
      box-shadow: 0 16px 64px rgba(0, 0, 0, 0.5);
    }

    body::before {
      content: '';
      position: absolute;
      top: -20%;
      left: -20%;
      width: 140%;
      height: 140%;
      background: radial-gradient(circle at center, 
        rgba(0, 122, 255, 0.02) 0%, 
        rgba(88, 86, 214, 0.01) 40%, 
        transparent 70%);
      animation: breathe 6s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes breathe {
      0%, 100% { opacity: 0.2; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(1.02); }
    }

    /* Header */
    .copilot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 32px;
      height: 60px;
      background: transparent;
      border-radius: 16px;
      gap: 20px;
      flex-shrink: 0;
    }

    .copilot-title {
      display: flex;
      align-items: center;
      gap: 14px;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      font-weight: 600;
      font-size: 17px;
      color: #ffffff;
      cursor: move;
      padding: 10px 16px;
      border-radius: 12px;
      user-select: none;
      -webkit-app-region: drag;
      transition: all 0.3s ease;
    }

    .copilot-title:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .copilot-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
      transition: all 0.3s ease;
    }

    .header-chat-container {
      display: none;
      align-items: center;
      flex: 1;
      max-width: 300px;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    body.collapsed .header-chat-container {
      display: flex;
    }

    .header-chat-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 22px;
      padding: 10px 18px;
      color: #ffffff;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
      min-width: 0;
    }

    .header-chat-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .header-send-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
      color: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }

    .copilot-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    body.collapsed .copilot-controls {
      display: none;
    }

    .control-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.1);
    }

    .control-btn.close:hover {
      background: rgba(255, 69, 58, 0.8);
      color: #ffffff;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 8px;
      padding: 0 24px 12px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      flex-shrink: 0;
    }

    body.collapsed .tab-nav {
      display: none;
    }

    .tab-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background: transparent;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.9);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }

    .task-badge {
      background: #FF9F0A;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 4px;
    }

    /* Content Area */
    .copilot-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    body.collapsed .copilot-content {
      display: none;
    }

    .tab-content {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .tab-content.active {
      display: flex;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      flex-shrink: 0;
    }

    .status-indicators {
      display: flex;
      gap: 20px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(142, 142, 147, 0.8);
    }

    .status-dot.online {
      background: #34C759;
      box-shadow: 0 0 8px rgba(52, 199, 89, 0.4);
    }

    /* Chat Interface */
    .chat-interface {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scroll-behavior: smooth;
      min-height: 0;
    }

    .welcome-message {
      text-align: center;
      padding: 32px 24px;
      background: rgba(0, 122, 255, 0.04);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .welcome-icon {
      font-size: 40px;
      margin-bottom: 16px;
    }

    .welcome-text {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .welcome-subtitle {
      font-size: 15px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 28px;
      line-height: 1.4;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      max-width: 400px;
      margin: 0 auto;
    }

    .quick-action {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-align: left;
    }

    .quick-action:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(0, 122, 255, 0.3);
      transform: translateY(-2px);
    }

    .message {
      display: flex;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
    }

    .message.assistant .message-avatar {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
    }

    .message-content {
      flex: 1;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 14px;
      line-height: 1.5;
      max-width: 80%;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 153, 204, 0.1));
      border-color: rgba(0, 212, 255, 0.3);
    }

    .typing-indicator {
      display: none;
      padding: 20px 24px;
      align-items: center;
      gap: 16px;
      background: rgba(0, 122, 255, 0.04);
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 14px;
      flex-shrink: 0;
    }

    .input-container {
      padding: 20px 24px;
      background: rgba(0, 0, 0, 0.3);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      flex-shrink: 0;
    }

    .input-wrapper {
      display: flex;
      gap: 16px;
      align-items: flex-end;
      max-width: 800px;
      margin: 0 auto;
    }

    .message-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      padding: 16px 20px;
      color: #ffffff;
      font-size: 15px;
      resize: none;
      min-height: 50px;
      max-height: 140px;
      transition: all 0.3s ease;
    }

    .message-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(0, 122, 255, 0.6);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
    }

    .message-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .send-btn {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
      border: none;
      border-radius: 50%;
      color: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
      flex-shrink: 0;
    }

    .send-btn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 122, 255, 0.4);
    }

    /* Tasks Styles */
    .tasks-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
    }

    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .tasks-title {
      font-size: 20px;
      font-weight: 600;
    }

    .task-stats {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-dot.todo { background: #FF9F0A; }
    .stat-dot.in-progress { background: #007AFF; }
    .stat-dot.completed { background: #34C759; }

    .task-input-section {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .task-input-wrapper {
      display: flex;
      gap: 12px;
    }

    .task-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;
      padding: 12px 16px;
      color: #ffffff;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
    }

    .task-input:focus {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(0, 122, 255, 0.6);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
    }

    .add-task-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }

    .priority-selector {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .priority-btn {
      padding: 6px 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: transparent;
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .priority-btn.active {
      background: linear-gradient(135deg, rgba(0, 122, 255, 0.3), rgba(88, 86, 214, 0.3));
      border-color: #007AFF;
      color: #ffffff;
    }

    .tasks-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .task-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .task-item:hover {
      background: rgba(0, 0, 0, 0.3);
      border-color: rgba(0, 122, 255, 0.3);
      transform: translateY(-2px);
    }

    .task-item.completed {
      opacity: 0.6;
    }

    .task-item.completed .task-title {
      text-decoration: line-through;
      color: rgba(255, 255, 255, 0.5);
    }

    .task-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .task-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .task-checkbox.checked {
      background: linear-gradient(135deg, #007AFF, #5856D6);
      border-color: #007AFF;
    }

    .task-checkbox.checked::after {
      content: '‚úì';
      color: white;
      font-size: 14px;
      font-weight: bold;
    }

    .task-title {
      flex: 1;
      font-size: 15px;
      font-weight: 500;
    }

    .task-priority {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .task-priority.urgent {
      background: rgba(255, 59, 48, 0.2);
      color: #FF3B30;
      border: 1px solid rgba(255, 59, 48, 0.3);
    }

    .task-priority.high {
      background: rgba(255, 159, 10, 0.2);
      color: #FF9F0A;
      border: 1px solid rgba(255, 159, 10, 0.3);
    }

    .task-priority.medium {
      background: rgba(0, 122, 255, 0.2);
      color: #007AFF;
      border: 1px solid rgba(0, 122, 255, 0.3);
    }

    .task-priority.low {
      background: rgba(142, 142, 147, 0.2);
      color: #8E8E93;
      border: 1px solid rgba(142, 142, 147, 0.3);
    }

    .task-actions {
      display: flex;
      gap: 8px;
    }

    .task-action-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .task-action-btn.delete:hover {
      background: rgba(255, 59, 48, 0.3);
      color: #FF3B30;
    }

    .task-description {
      margin-top: 8px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.4;
      padding-left: 32px;
    }

    .task-meta {
      margin-top: 12px;
      padding-left: 32px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 11px;
    }

    .task-assignor,
    .task-assignee {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
    }

    .task-assignor {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .task-assignee {
      background: rgba(34, 197, 94, 0.15);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .task-date {
      color: rgba(255, 255, 255, 0.5);
    }

    /* Task Chat Button */
    .task-action-btn.chat {
      background: rgba(0, 122, 255, 0.15);
      color: #007AFF;
      font-size: 14px;
    }
    
    .task-action-btn.chat:hover {
      background: rgba(0, 122, 255, 0.25);
      transform: scale(1.1);
    }
    
    /* Task Chat Modal */
    .task-chat-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .task-chat-container {
      width: 90%;
      max-width: 700px;
      height: 80vh;
      max-height: 600px;
      background: rgba(28, 28, 30, 0.98);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .task-chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }
    
    .task-chat-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .task-chat-icon {
      font-size: 24px;
    }
    
    .task-chat-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .task-chat-name {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
    }
    
    .task-chat-subtitle {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .task-chat-close {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #ffffff;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .task-chat-close:hover {
      background: rgba(255, 59, 48, 0.2);
      color: #FF3B30;
    }
    
    .task-chat-context {
      padding: 16px 24px;
      background: rgba(0, 122, 255, 0.08);
      border-bottom: 1px solid rgba(0, 122, 255, 0.2);
      flex-shrink: 0;
    }
    
    .task-context-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }
    
    .task-context-content {
      font-size: 14px;
      color: #ffffff;
      line-height: 1.5;
    }
    
    .task-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .task-chat-welcome {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .task-chat-welcome .welcome-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .task-chat-welcome .welcome-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .task-chat-welcome .welcome-subtitle {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .task-message {
      display: flex;
      flex-direction: column;
      gap: 8px;
      animation: messageSlideIn 0.3s ease;
    }
    
    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .task-message.user {
      align-items: flex-end;
    }
    
    .task-message.assistant {
      align-items: flex-start;
    }
    
    .task-message-bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    
    .task-message.user .task-message-bubble {
      background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
      color: #ffffff;
      border-bottom-right-radius: 4px;
    }
    
    .task-message.assistant .task-message-bubble {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border-bottom-left-radius: 4px;
    }
    
    .task-message-time {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      padding: 0 8px;
    }
    
    .task-chat-typing {
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .task-chat-input {
      padding: 16px 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-shrink: 0;
    }
    
    .task-chat-textarea {
      flex: 1;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 12px 16px;
      color: #ffffff;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      transition: all 0.2s ease;
    }
    
    .task-chat-textarea:focus {
      outline: none;
      border-color: #007AFF;
      background: rgba(255, 255, 255, 0.12);
    }
    
    .task-chat-textarea::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    .task-chat-send {
      background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
      border: none;
      color: #ffffff;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .task-chat-send:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
    }
    
    .task-chat-send:active {
      transform: scale(0.95);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 212, 255, 0.3);
      border-radius: 3px;
    }
  </style>
</head>
<body class="expanded">
  <div class="copilot-header">
    <div class="copilot-title" id="dragHandle">
      <img src="/Users/jarvis/Code/HeyJarvis/Jarvis.png" alt="Jarvis" class="copilot-icon">
      HeyJarvis
    </div>
    
    <div class="header-chat-container">
      <input type="text" class="header-chat-input" id="headerChatInput" placeholder="Ask me anything..." autocomplete="off">
      <button class="header-send-btn" onclick="sendHeaderMessage()">‚Üí</button>
    </div>
    
    <div class="copilot-controls">
      <button class="control-btn minimize" onclick="collapseTopBar()" title="Collapse">‚àí</button>
      <button class="control-btn close" onclick="closeWindow()" title="Hide">√ó</button>
    </div>
  </div>

  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('copilot')">
      <span>üí¨</span>
      <span>Copilot</span>
    </button>
    <button class="tab-btn" onclick="switchTab('tasks')">
      <span>‚úì</span>
      <span>To Do</span>
      <span id="taskBadge" class="task-badge" style="display: none;"></span>
    </button>
  </div>

  <div class="copilot-content">
    <!-- Copilot Tab -->
    <div id="copilotTab" class="tab-content active">
      <div class="status-bar">
        <div class="status-indicators">
          <div class="status-item">
            <div class="status-dot" id="slackStatusDot"></div>
            <span>Slack</span>
          </div>
          <div class="status-item">
            <div class="status-dot" id="crmStatusDot"></div>
            <span>CRM</span>
          </div>
        </div>
        <div id="activitySummary">All systems ready</div>
      </div>

      <div class="chat-interface">
        <div class="chat-container" id="chatContainer">
          <div class="welcome-message">
            <div class="welcome-icon">‚ú®</div>
            <div class="welcome-text">Hello! I'm your AI copilot.</div>
            <div class="welcome-subtitle">I can help with competitive intelligence, CRM insights, and Slack monitoring.</div>
            
            <div class="quick-actions">
              <div class="quick-action" onclick="sendQuickMessage('What are the latest competitor moves?')">
                <div>üìä</div>
                <div>Latest competitor moves</div>
              </div>
              <div class="quick-action" onclick="sendQuickMessage('Analyze my CRM data')">
                <div>üß†</div>
                <div>CRM insights</div>
              </div>
              <div class="quick-action" onclick="sendQuickMessage('Show Slack activity')">
                <div>üí¨</div>
                <div>Slack activity</div>
              </div>
              <div class="quick-action" onclick="startFactCheck()">
                <div>üîç</div>
                <div>Fact Check Screen</div>
              </div>
            </div>
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <div>‚ú®</div>
          <div>
            <span>HeyJarvis is thinking</span>
            <div style="display: inline-flex; gap: 6px; margin-left: 12px;">
              <div style="width: 8px; height: 8px; background: #007AFF; border-radius: 50%;"></div>
              <div style="width: 8px; height: 8px; background: #007AFF; border-radius: 50%;"></div>
              <div style="width: 8px; height: 8px; background: #007AFF; border-radius: 50%;"></div>
            </div>
          </div>
        </div>

        <div class="input-container">
          <div class="input-wrapper">
            <textarea class="message-input" id="messageInput" placeholder="Ask me anything..." rows="1"></textarea>
            <button class="send-btn" onclick="sendMessage()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m22 2-7 20-4-9-9-4z"/>
                <path d="M22 2 11 13"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tasks Tab -->
    <div id="tasksTab" class="tab-content">
      <div class="tasks-container">
        <div class="tasks-header">
          <div class="tasks-title">‚úì My Tasks</div>
          <div class="task-stats">
            <div class="stat-item">
              <div class="stat-dot todo"></div>
              <span id="todoCount">0</span> To Do
            </div>
            <div class="stat-item">
              <div class="stat-dot in-progress"></div>
              <span id="inProgressCount">0</span> In Progress
            </div>
            <div class="stat-item">
              <div class="stat-dot completed"></div>
              <span id="completedCount">0</span> Done
            </div>
          </div>
        </div>

        <div class="task-input-section">
          <div class="task-input-wrapper">
            <input type="text" id="taskInput" class="task-input" placeholder="What needs to be done?" onkeypress="if(event.key==='Enter') addTask()">
            <button class="add-task-btn" onclick="addTask()">+ Add Task</button>
          </div>
          <div class="priority-selector">
            <button class="priority-btn" onclick="selectPriority('low')">Low</button>
            <button class="priority-btn active" onclick="selectPriority('medium')">Medium</button>
            <button class="priority-btn" onclick="selectPriority('high')">High</button>
            <button class="priority-btn" onclick="selectPriority('urgent')">Urgent</button>
          </div>
        </div>

        <div class="tasks-list" id="tasksList">
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <div>No tasks yet. Add one above to get started!</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Chat Modal -->
  <div id="taskChatModal" class="task-chat-modal" style="display: none;">
    <div class="task-chat-container">
      <div class="task-chat-header">
        <div class="task-chat-title">
          <span class="task-chat-icon">üí¨</span>
          <div class="task-chat-info">
            <div class="task-chat-name" id="taskChatName">Task Discussion</div>
            <div class="task-chat-subtitle">AI-powered task assistant</div>
          </div>
        </div>
        <button class="task-chat-close" onclick="closeTaskChat()">√ó</button>
      </div>
      
      <div class="task-chat-context">
        <div class="task-context-label">Task Context:</div>
        <div class="task-context-content" id="taskChatContext"></div>
      </div>
      
      <div class="task-chat-messages" id="taskChatMessages">
        <div class="task-chat-welcome">
          <div class="welcome-icon">üéØ</div>
          <div class="welcome-text">Let's work on this task together!</div>
          <div class="welcome-subtitle">I can help you brainstorm, plan, and complete this task.</div>
        </div>
      </div>
      
      <div class="task-chat-typing" id="taskChatTyping" style="display: none;">
        <div>‚ú®</div>
        <div>
          <span>Thinking about your task...</span>
        </div>
      </div>
      
      <div class="task-chat-input">
        <textarea 
          id="taskChatInput" 
          class="task-chat-textarea" 
          placeholder="Ask about this task, brainstorm ideas, get help..." 
          rows="1"
        ></textarea>
        <button class="task-chat-send" onclick="sendTaskChatMessage()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m22 2-7 20-4-9-9-4z"/>
            <path d="M22 2 11 13"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentTab = 'copilot';
    let currentPriority = 'medium';
    let tasks = [];
    let isExpanded = true;
    let chatHistory = [];
    let crmData = null;
    let slackConnected = false;
    let servicesInitialized = false;
    let currentTaskChat = null;
    let taskChatHistories = {}; // Store chat history for each task

    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const headerChatInput = document.getElementById('headerChatInput');
    const typingIndicator = document.getElementById('typingIndicator');

    // Tab switching
    function switchTab(tab) {
      currentTab = tab;
      
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.closest('.tab-btn').classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tab + 'Tab').classList.add('active');
      
      if (tab === 'tasks') {
        loadTasks();
      }
    }

    // Priority selection
    function selectPriority(priority) {
      currentPriority = priority;
      document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    // Task management
    async function addTask() {
      const input = document.getElementById('taskInput');
      const title = input.value.trim();
      
      if (!title) return;
      
      if (!window.electronAPI || !window.electronAPI.tasks) {
        console.warn('Task API not available');
        alert('Task functionality requires the desktop app');
        return;
      }
      
      try {
        const result = await window.electronAPI.tasks.create({
          title,
          priority: currentPriority
        });
        
        if (result.success) {
          input.value = '';
          await loadTasks();
        } else {
          console.error('Failed to create task:', result.error);
        }
      } catch (error) {
        console.error('Error creating task:', error);
      }
    }

    async function loadTasks() {
      try {
        if (!window.electronAPI || !window.electronAPI.tasks) {
          console.warn('Task API not available');
          renderTasks(); // Show empty state
          return;
        }
        
        const result = await window.electronAPI.tasks.getAll();
        
        if (result.success) {
          tasks = result.tasks;
          renderTasks();
          updateStats();
        } else {
          console.error('Failed to load tasks:', result.error);
          renderTasks();
        }
      } catch (error) {
        console.error('Error loading tasks:', error);
        renderTasks();
      }
    }

    function renderTasks() {
      const tasksList = document.getElementById('tasksList');
      
      if (tasks.length === 0) {
        tasksList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <div>No tasks yet. Add one above to get started!</div>
          </div>
        `;
        return;
      }
      
    //   tasksList.innerHTML = tasks.map(task => `
    //     <div class="task-item ${task.status === 'completed' ? 'completed' : ''}">
    //       <div class="task-header">
    //         <div class="task-checkbox ${task.status === 'completed' ? 'checked' : ''}" 
    //              onclick="toggleTask('${task.id}', '${task.status}')"></div>
    //         <div class="task-title">${escapeHtml(task.title)}</div>
    //         <div class="task-priority ${task.priority}">${task.priority}</div>
    //         <div class="task-actions">
    //           <button class="task-action-btn delete" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
    //         </div>
    //       </div>
    //     </div>
    //   `).join('');
    tasksList.innerHTML = tasks.map(task => `
        <div class="task-item ${task.status === 'completed' ? 'completed' : ''}">
          <div class="task-header">
            <div class="task-checkbox ${task.status === 'completed' ? 'checked' : ''}" 
                 onclick="toggleTask('${task.id}', '${task.status}')"></div>
            <div class="task-title">${escapeHtml(task.title)}</div>
            <div class="task-priority ${task.priority}">${task.priority}</div>
            <div class="task-actions">
              <button class="task-action-btn chat" onclick="openTaskChat('${task.id}')" title="AI Chat">üí¨</button>
              <button class="task-action-btn delete" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
            </div>
          </div>
          ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
          <div class="task-meta">
            ${task.assignor ? `<span class="task-assignor">üë§ From: ${escapeHtml(task.assignor.name || task.assignor.id)}</span>` : ''}
            ${task.assignee ? `<span class="task-assignee">üëâ To: ${escapeHtml(task.assignee.name || task.assignee.id)}</span>` : ''}
            <span class="task-date">Created ${formatDate(task.created_at)}</span>
          </div>
        </div>
      `).join('');
    }

    async function toggleTask(taskId, currentStatus) {
      if (!window.electronAPI || !window.electronAPI.tasks) {
        console.warn('Task API not available');
        return;
      }
      
      try {
        const result = await window.electronAPI.tasks.toggle(taskId, currentStatus);
        if (result.success) await loadTasks();
      } catch (error) {
        console.error('Error toggling task:', error);
      }
    }

    async function deleteTask(taskId) {
      if (!confirm('Delete this task?')) return;
      
      if (!window.electronAPI || !window.electronAPI.tasks) {
        console.warn('Task API not available');
        return;
      }
      
      try {
        const result = await window.electronAPI.tasks.delete(taskId);
        if (result.success) await loadTasks();
      } catch (error) {
        console.error('Error deleting task:', error);
      }
    }

    function updateStats() {
      const todoCount = tasks.filter(t => t.status === 'todo').length;
      const inProgressCount = tasks.filter(t => t.status === 'in_progress').length;
      const completedCount = tasks.filter(t => t.status === 'completed').length;
      
      document.getElementById('todoCount').textContent = todoCount;
      document.getElementById('inProgressCount').textContent = inProgressCount;
      document.getElementById('completedCount').textContent = completedCount;
      
      const badge = document.getElementById('taskBadge');
      const activeCount = todoCount + inProgressCount;
      if (activeCount > 0) {
        badge.textContent = activeCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    // Chat functionality
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      await processChatMessage(message);
      messageInput.value = '';
      messageInput.style.height = 'auto';
    }

    async function sendHeaderMessage() {
      const message = headerChatInput.value.trim();
      if (!message) return;

      if (!isExpanded) expandTopBar();

      await processChatMessage(message);
      headerChatInput.value = '';
    }

    async function processChatMessage(message) {
      addMessage(message, 'user');
      showTypingIndicator();

      try {
        let response;
        if (window.electronAPI) {
          response = await window.electronAPI.sendMessage(message);
        } else {
          response = {
            content: 'I\'m here to help! What would you like to know?',
            timestamp: new Date().toISOString()
          };
        }

        hideTypingIndicator();
        addMessage(response.content, 'assistant');
      } catch (error) {
        console.error('Error sending message:', error);
        hideTypingIndicator();
        addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
      }
    }

    function sendQuickMessage(message) {
      if (isExpanded && messageInput) {
        messageInput.value = message;
        sendMessage();
      } else if (headerChatInput) {
        headerChatInput.value = message;
        sendHeaderMessage();
      }
    }

    function addMessage(content, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const avatar = sender === 'user' ? 'üë§' : 'ü§ñ';
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
          ${content}
          <div style="font-size: 11px; color: rgba(255, 255, 255, 0.4); margin-top: 4px;">${time}</div>
        </div>
      `;
      
      const welcomeMessage = chatContainer.querySelector('.welcome-message');
      if (welcomeMessage) welcomeMessage.remove();
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      chatHistory.push({ content, sender, timestamp: new Date().toISOString() });
    }

    function showTypingIndicator() {
      typingIndicator.style.display = 'flex';
    }

    function hideTypingIndicator() {
      typingIndicator.style.display = 'none';
    }

    // Window controls
    function collapseTopBar() {
      isExpanded = false;
      document.body.classList.remove('expanded');
      document.body.classList.add('collapsed');
      
      if (window.electronAPI?.collapseTopBar) {
        window.electronAPI.collapseTopBar();
      }
    }

    function expandTopBar() {
      isExpanded = true;
      document.body.classList.remove('collapsed');
      document.body.classList.add('expanded');
      
      if (window.electronAPI?.expandTopBar) {
        window.electronAPI.expandTopBar();
      }
    }

    function closeWindow() {
      if (window.electronAPI) {
        window.electronAPI.closeWindow();
      } else {
        window.close();
      }
    }

    // Services initialization
    async function initializeServices() {
      if (servicesInitialized) return;
      servicesInitialized = true;
      
      if (!window.electronAPI) return;
      
      try {
        if (window.electronAPI.slack?.startMonitoring) {
          const result = await window.electronAPI.slack.startMonitoring();
          if (result.success) {
            slackConnected = true;
            document.getElementById('slackStatusDot').classList.add('online');
          }
        }
        
        if (window.electronAPI.getCRMData) {
          const response = await window.electronAPI.getCRMData();
          if (response.success) {
            crmData = response.data;
            document.getElementById('crmStatusDot').classList.add('online');
          }
        }
      } catch (error) {
        console.error('Service initialization error:', error);
      }
    }

    // Fact checking
    async function startFactCheck() {
      addMessage('üîç Starting fact check...', 'assistant');
      showTypingIndicator();
      
      try {
        if (window.electronAPI?.factCheck) {
          // Implement fact checking logic
        }
      } catch (error) {
        console.error('Fact check error:', error);
      } finally {
        hideTypingIndicator();
      }
    }

    // Helper functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      
      return date.toLocaleDateString();
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
    }

    // ===== TASK CHAT FUNCTIONS =====
    
    function openTaskChat(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      
      currentTaskChat = task;
      
      // Update modal title and context
      document.getElementById('taskChatName').textContent = task.title;
      document.getElementById('taskChatContext').innerHTML = `
        <strong>${escapeHtml(task.title)}</strong>
        ${task.description ? `<br>${escapeHtml(task.description)}` : ''}
        <br><span style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">
          Priority: ${task.priority} ‚Ä¢ Status: ${task.status}
        </span>
      `;
      
      // Load existing chat history for this task
      renderTaskChatHistory(taskId);
      
      // Show modal
      document.getElementById('taskChatModal').style.display = 'flex';
      
      // Focus input after a brief delay to allow animation
      setTimeout(() => {
        document.getElementById('taskChatInput').focus();
      }, 100);
    }
    
    function closeTaskChat() {
      document.getElementById('taskChatModal').style.display = 'none';
      currentTaskChat = null;
    }
    
    function renderTaskChatHistory(taskId) {
      const messagesContainer = document.getElementById('taskChatMessages');
      const history = taskChatHistories[taskId] || [];
      
      if (history.length === 0) {
        messagesContainer.innerHTML = `
          <div class="task-chat-welcome">
            <div class="welcome-icon">üéØ</div>
            <div class="welcome-text">Let's work on this task together!</div>
            <div class="welcome-subtitle">I can help you brainstorm, plan, and complete this task.</div>
          </div>
        `;
      } else {
        messagesContainer.innerHTML = history.map(msg => `
          <div class="task-message ${msg.role}">
            <div class="task-message-bubble">${escapeHtml(msg.content)}</div>
            <div class="task-message-time">${formatTime(msg.timestamp)}</div>
          </div>
        `).join('');
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }
    
    async function sendTaskChatMessage() {
      if (!currentTaskChat) return;
      
      const input = document.getElementById('taskChatInput');
      const message = input.value.trim();
      if (!message) return;
      
      const taskId = currentTaskChat.id;
      
      // Initialize chat history for this task if needed
      if (!taskChatHistories[taskId]) {
        taskChatHistories[taskId] = [];
      }
      
      // Add user message to history
      const userMessage = {
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
      };
      taskChatHistories[taskId].push(userMessage);
      
      // Clear input and update UI
      input.value = '';
      input.style.height = 'auto';
      renderTaskChatHistory(taskId);
      
      // Show typing indicator
      document.getElementById('taskChatTyping').style.display = 'flex';
      
      try {
        // Call backend API with task context
        if (!window.electronAPI || !window.electronAPI.copilot) {
          throw new Error('Electron API not available');
        }
        
        const response = await window.electronAPI.copilot.sendTaskMessage(taskId, message, {
          task: currentTaskChat
        });
        
        // Add AI response to history
        const assistantMessage = {
          role: 'assistant',
          content: response.content || response,
          timestamp: new Date().toISOString()
        };
        taskChatHistories[taskId].push(assistantMessage);
        
        // Update UI
        renderTaskChatHistory(taskId);
        
      } catch (error) {
        console.error('Task chat error:', error);
        
        // Add error message
        const errorMessage = {
          role: 'assistant',
          content: 'Sorry, I encountered an error. Please try again.',
          timestamp: new Date().toISOString()
        };
        taskChatHistories[taskId].push(errorMessage);
        renderTaskChatHistory(taskId);
      } finally {
        // Hide typing indicator
        document.getElementById('taskChatTyping').style.display = 'none';
      }
    }

    // Auto-resize textarea
    if (messageInput) {
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    if (headerChatInput) {
      headerChatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendHeaderMessage();
        }
      });

      headerChatInput.addEventListener('focus', () => {
        if (!isExpanded) expandTopBar();
      });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ HeyJarvis loaded');
      initializeServices();
      
      // Setup task chat input handlers
      const taskChatInput = document.getElementById('taskChatInput');
      if (taskChatInput) {
        taskChatInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        taskChatInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendTaskChatMessage();
          }
        });
      }
      
      // Close task chat modal on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && currentTaskChat) {
          closeTaskChat();
        }
      });
    });
  </script>
</body>
</html>