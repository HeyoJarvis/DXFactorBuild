<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: https: http://localhost:*; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' http://localhost:* https:;">
  <title>HeyJarvis</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=SF+Pro+Text:wght@300;400;500;600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Text', sans-serif;
      background: transparent; /* Transparent for Arc Reactor only view */
      color: #171717;
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(40px) saturate(180%);
      border-radius: 16px;
    }

    body.collapsed {
      height: 80px; /* Just enough space for floating Arc Reactor */
      width: 80px;
      background: transparent;
      box-shadow: none;
      border-radius: 50%;
    }

    body.collapsed .copilot-content {
      display: none !important;
    }

    body.expanded {
      height: 100vh;
      width: 100vw;
      background: #fafafa;
      box-shadow: 
        0 0 0 0.5px rgba(0, 0, 0, 0.04),
        0 20px 50px -12px rgba(0, 0, 0, 0.12),
        0 8px 16px -8px rgba(0, 0, 0, 0.08);
    }

    body::before {
      content: '';
      position: absolute;
      top: -20%;
      left: -20%;
      width: 140%;
      height: 140%;
      background: radial-gradient(circle at center, 
        rgba(0, 122, 255, 0.02) 0%, 
        rgba(88, 86, 214, 0.01) 40%, 
        transparent 70%);
      animation: breathe 6s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes breathe {
      0%, 100% { opacity: 0.2; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(1.02); }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Header - Completely Hidden, Only Arc Reactor Visible */
    .copilot-header {
      display: none; /* Hide entire header bar */
    }

    body.collapsed .copilot-header {
      display: none;
    }

    .copilot-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      font-weight: 600;
      font-size: 14px;
      color: #171717;
      letter-spacing: -0.02em;
      cursor: move;
      padding: 6px 10px;
      border-radius: 6px;
      user-select: none;
      -webkit-app-region: drag;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .copilot-title:hover {
      background: rgba(0, 0, 0, 0.03);
    }

    .copilot-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
      transition: all 0.3s ease;
    }

    .header-input-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      max-width: 500px;
      margin: 0 16px;
      -webkit-app-region: no-drag;
      position: relative;
    }

    body.expanded .header-input-wrapper {
      display: none;
    }

    .header-input {
      width: 100%;
      height: 32px;
      background: rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 8px;
      padding: 0 16px;
      padding-right: 40px;
      font-size: 13px;
      color: #171717;
      outline: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .header-input::placeholder {
      color: #a3a3a3;
    }

    .header-input:hover {
      background: rgba(0, 0, 0, 0.06);
      border-color: rgba(0, 0, 0, 0.12);
    }

    .header-input-send-btn {
      position: absolute;
      right: 6px;
      width: 24px;
      height: 24px;
      background: rgba(0, 122, 255, 0.1);
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      pointer-events: none;
    }

    .header-input-wrapper:hover .header-input-send-btn,
    .header-input:focus ~ .header-input-send-btn,
    .header-input-send-btn.has-text {
      opacity: 1;
      pointer-events: auto;
    }

    .header-input-send-btn:hover {
      background: rgba(0, 122, 255, 0.2);
      transform: scale(1.05);
    }

    .header-input-send-btn:active {
      transform: scale(0.95);
    }

    .header-input-send-btn svg {
      width: 14px;
      height: 14px;
      color: #007AFF;
    }

    .header-input:focus {
      background: white;
      border-color: #171717;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.04);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      -webkit-app-region: no-drag;
    }

    .header-nav-btn {
      height: 32px;
      padding: 0 16px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #737373;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      letter-spacing: -0.01em;
    }

    .header-nav-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #171717;
    }

    .header-nav-btn.active {
      background: #171717;
      color: white;
    }

    .header-nav-btn.active:hover {
      background: #0a0a0a;
    }

    .nav-badge {
      width: 6px;
      height: 6px;
      background: #FF3B30;
      border-radius: 50%;
      margin-left: 2px;
    }

    .header-nav-btn.active .nav-badge {
      background: white;
    }

    .header-divider {
      width: 1px;
      height: 24px;
      background: rgba(0, 0, 0, 0.1);
      margin: 0 6px;
    }

    .header-action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #737373;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .header-action-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #171717;
    }

    .header-action-btn:active {
      transform: scale(0.95);
    }

    .notification-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 8px;
      height: 8px;
      background: #FF3B30;
      border-radius: 50%;
      border: 2px solid white;
    }

    /* Microsoft 365 Button */
    .ms-auth-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #737373;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .ms-auth-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #171717;
    }

    .ms-auth-btn.connected {
      color: #10b981;
    }

    .ms-auth-btn.connected:hover {
      background: rgba(16, 185, 129, 0.1);
    }

    .ms-status-dot {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #737373;
      transition: all 0.2s ease;
    }

    .ms-auth-btn.connected .ms-status-dot {
      background: #10b981;
      box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
      animation: msPulse 2s ease-in-out infinite;
    }

    @keyframes msPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* GitHub Connection Button */
    .github-auth-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #737373;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .github-auth-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #171717;
    }

    .github-auth-btn.connected {
      color: #10b981;
    }

    .github-auth-btn.connected:hover {
      background: rgba(16, 185, 129, 0.1);
    }

    .github-status-dot {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #737373;
      transition: all 0.2s ease;
    }

    .github-auth-btn.connected .github-status-dot {
      background: #10b981;
      box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
      animation: githubPulse 2s ease-in-out infinite;
    }

    @keyframes githubPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* JIRA Auth Button */
    .jira-auth-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #737373;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .jira-auth-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #171717;
    }

    .jira-auth-btn.connected {
      color: #0052CC; /* JIRA Blue */
    }

    .jira-auth-btn.connected:hover {
      background: rgba(0, 82, 204, 0.1);
    }

    .jira-status-dot {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #737373;
      transition: all 0.2s ease;
    }

    .jira-auth-btn.connected .jira-status-dot {
      background: #0052CC;
      box-shadow: 0 0 6px rgba(0, 82, 204, 0.5);
      animation: jiraPulse 2s ease-in-out infinite;
    }

    @keyframes jiraPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .ms-auth-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    }

    .ms-auth-modal.show {
      display: flex;
    }

    .ms-auth-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ms-auth-content h3 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #171717;
    }

    .ms-auth-content p {
      font-size: 14px;
      color: #737373;
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .ms-auth-actions {
      display: flex;
      gap: 12px;
    }

    .ms-auth-actions button {
      flex: 1;
      height: 40px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ms-auth-primary {
      background: linear-gradient(135deg, #0078d4 0%, #5856d6 100%);
      color: white;
    }

    .ms-auth-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
    }

    .ms-auth-secondary {
      background: rgba(0, 0, 0, 0.05);
      color: #171717;
    }

    .ms-auth-secondary:hover {
      background: rgba(0, 0, 0, 0.08);
    }

    @keyframes msSpinAnimation {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }


    .header-chat-container {
      display: none;
      align-items: center;
      flex: 1;
      max-width: 300px;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    body.collapsed .header-chat-container {
      display: flex;
    }

    .header-chat-input {
      flex: 1;
      background: rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 22px;
      padding: 10px 18px;
      color: #1d1d1f;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
      min-width: 0;
    }

    .header-chat-input:focus {
      background: rgba(0, 0, 0, 0.06);
      border-color: rgba(0, 122, 255, 0.4);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.08);
    }

    .header-chat-input::placeholder {
      color: rgba(0, 0, 0, 0.4);
    }

    .header-send-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
      color: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
    }

    .header-send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
    }

    .copilot-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    body.collapsed .copilot-controls {
      display: none;
    }

    .control-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.05);
      color: rgba(0, 0, 0, 0.5);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .control-btn:hover {
      background: rgba(0, 0, 0, 0.1);
      color: rgba(0, 0, 0, 0.75);
      transform: scale(1.1);
    }

    .control-btn.close:hover {
      background: #FF3B30;
      color: #ffffff;
    }


    /* Content Area */
    .copilot-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    body.collapsed .copilot-content {
      display: none;
    }

    .tab-content {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .tab-content.active {
      display: flex;
    }

    /* Status Bar - Light Theme */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: rgba(0, 0, 0, 0.02);
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
    }

    .status-indicators {
      display: flex;
      gap: 20px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(142, 142, 147, 0.8);
    }

    .status-dot.online {
      background: #34C759;
      box-shadow: 0 0 8px rgba(52, 199, 89, 0.4);
    }

    /* Chat Interface */
    .chat-interface {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      background: #fafafa;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px 12px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
      min-height: 0;
    }
    
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-container::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }
    
    .chat-container::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    .welcome-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 16px;
      min-height: 150px;
      gap: 16px;
    }

    .welcome-logo {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .welcome-text {
      font-size: 13px;
      font-weight: 500;
      color: #171717;
      letter-spacing: -0.01em;
      text-align: center;
      line-height: 1.4;
    }

    .welcome-subtitle {
      font-size: 12px;
      font-weight: 400;
      color: #a3a3a3;
      letter-spacing: -0.005em;
    }

    .message {
      display: flex;
      gap: 16px;
      max-width: 85%;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      flex-direction: row-reverse;
      align-self: flex-end;
    }
    
    .message.assistant {
      align-self: flex-start;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
      font-weight: 600;
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .message.assistant .message-avatar {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .message-content {
      flex: 1;
      border-radius: 16px;
      padding: 16px 20px;
      font-size: 15px;
      line-height: 1.6;
      color: #1f2937;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    
    .message.assistant .message-content {
      background: white;
      color: #1f2937;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .typing-indicator {
      display: none;
      padding: 16px 24px;
      align-items: center;
      gap: 10px;
      background: white;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      font-size: 13px;
      color: #737373;
      flex-shrink: 0;
    }

    .input-container {
      padding: 12px 12px 16px 12px;
      background: white;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      flex-shrink: 0;
    }

    .input-wrapper {
      display: flex;
      gap: 8px;
      align-items: flex-end;
      max-width: 100%;
      margin: 0 auto;
      background: #fafafa;
      border: 1.5px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      padding: 8px 8px 8px 12px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .input-wrapper:focus-within {
      background: white;
      border-color: #171717;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.04);
    }

    .message-input {
      flex: 1;
      background: transparent;
      border: none;
      padding: 4px 0;
      color: #171717;
      font-size: 13px;
      line-height: 1.4;
      resize: none;
      min-height: 20px;
      max-height: 80px;
      font-family: inherit;
    }

    .message-input:focus {
      outline: none;
    }

    .message-input::placeholder {
      color: #a3a3a3;
    }

    .send-btn {
      width: 28px;
      height: 28px;
      background: #171717;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
      font-size: 14px;
    }

    .send-btn:hover:not(:disabled) {
      background: #0a0a0a;
      transform: scale(1.05);
    }

    .send-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .send-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Tasks Styles - Compact Light Theme */
    .tasks-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #fafafa;
    }
    
    .tasks-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .tasks-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .tasks-container::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }
    
    .tasks-container::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .tasks-title {
      font-size: 15px;
      font-weight: 600;
      color: #171717;
      letter-spacing: -0.02em;
    }

    .task-stats {
      display: flex;
      gap: 8px;
      font-size: 11px;
      color: #737373;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-dot.todo { background: #FF9F0A; }
    .stat-dot.in-progress { background: #007AFF; }
    .stat-dot.completed { background: #34C759; }

    .task-filter-section {
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .assignment-filter {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: white;
      color: #171717;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      outline: none;
    }

    .assignment-filter:hover {
      border-color: rgba(0, 212, 255, 0.3);
      background: rgba(0, 212, 255, 0.02);
    }

    .assignment-filter:focus {
      border-color: rgba(0, 212, 255, 0.5);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .jira-sync-btn {
      padding: 8px 14px;
      border: 1px solid #0052CC;
      border-radius: 8px;
      background: #0052CC;
      color: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      outline: none;
      display: flex;
      align-items: center;
      white-space: nowrap;
    }

    .jira-sync-btn:hover {
      background: #0747A6;
      border-color: #0747A6;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 82, 204, 0.3);
    }

    .jira-sync-btn:active {
      transform: translateY(0);
    }

    .jira-sync-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .jira-sync-btn svg {
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    .task-input-section {
      background: white;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .task-input-wrapper {
      display: flex;
      gap: 8px;
    }

    .task-input {
      flex: 1;
      background: #fafafa;
      border: 1.5px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      padding: 8px 12px;
      color: #171717;
      font-size: 13px;
      outline: none;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-input::placeholder {
      color: #a3a3a3;
    }

    .task-input:focus {
      background: white;
      border-color: #171717;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.04);
    }

    .add-task-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #171717;
      color: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .add-task-btn:hover {
      background: #0a0a0a;
      transform: scale(1.02);
    }

    .add-task-btn:active {
      transform: scale(0.98);
    }

    .priority-selector {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .priority-btn {
      padding: 4px 8px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 6px;
      background: white;
      color: #737373;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .priority-btn:hover {
      background: #fafafa;
      border-color: #171717;
    }

    .priority-btn.active {
      background: #171717;
      border-color: #171717;
      color: #ffffff;
    }

    .tasks-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .task-item {
      background: white;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .task-item:hover {
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .task-item.completed {
      opacity: 0.5;
      background: #fafafa;
    }

    .task-item.completed .task-title {
      text-decoration: line-through;
      color: #a3a3a3;
    }

    .task-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    .task-checkbox:hover {
      border-color: #171717;
    }

    .task-checkbox.checked {
      background: #171717;
      border-color: #171717;
    }

    .task-checkbox.checked::after {
      content: 'âœ“';
      color: white;
      font-size: 11px;
      font-weight: bold;
    }

    .task-title {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
      color: #171717;
    }

    .task-priority {
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .task-priority.urgent {
      background: rgba(255, 59, 48, 0.2);
      color: #FF3B30;
      border: 1px solid rgba(255, 59, 48, 0.3);
    }

    .task-priority.high {
      background: rgba(255, 159, 10, 0.2);
      color: #FF9F0A;
      border: 1px solid rgba(255, 159, 10, 0.3);
    }

    .task-priority.medium {
      background: rgba(0, 122, 255, 0.2);
      color: #007AFF;
      border: 1px solid rgba(0, 122, 255, 0.3);
    }

    .task-priority.low {
      background: rgba(142, 142, 147, 0.2);
      color: #8E8E93;
      border: 1px solid rgba(142, 142, 147, 0.3);
    }

    .task-actions {
      display: flex;
      gap: 8px;
    }

    .task-action-btn {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 5px;
      background: #fafafa;
      color: #737373;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 12px;
    }

    .task-action-btn:hover {
      background: #f0f0f0;
      color: #171717;
    }

    .task-action-btn.delete:hover {
      background: rgba(255, 59, 48, 0.1);
      color: #FF3B30;
    }

    .task-description {
      margin-top: 6px;
      font-size: 12px;
      color: #737373;
      line-height: 1.4;
      padding-left: 24px;
    }

    .task-meta {
      margin-top: 8px;
      padding-left: 24px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 10px;
    }

    .task-assignor,
    .task-assignee {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
    }

    .task-assignor {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .task-assignee {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .task-date {
      color: #a3a3a3;
    }

    /* Simple Header */
    .tasks-header-simple {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 32px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      background: white;
    }

    .tasks-title-large {
      display: flex;
      align-items: center;
      font-size: 28px;
      font-weight: 700;
      color: #171717;
      letter-spacing: -0.02em;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
    }

    .filter-icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      color: #737373;
    }

    .filter-icon-btn:hover {
      background: #fafafa;
      border-color: #171717;
      color: #171717;
      transform: scale(1.05);
    }

    /* Action Items Section Header */
    .action-items-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 12px 16px 52px;
      background: white;
      position: relative;
      border-bottom: 2px solid rgba(0, 0, 0, 0.08);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      z-index: 10;
      min-height: 52px;
    }

    .action-items-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      text-align: left;
      position: relative;
      color: #171717;
      flex: 0 0 auto;
    }
    
    .action-items-title::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120%;
      height: 120%;
      background: radial-gradient(ellipse at center, rgba(102, 126, 234, 0.08), transparent 70%);
      filter: blur(20px);
      z-index: -1;
      pointer-events: none;
    }

    .simple-filter-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: #fafafa;
      border: 2px solid rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      color: #171717;
      flex-shrink: 0;
    }

    .simple-filter-btn:hover {
      background: #171717;
      color: white;
      border-color: #171717;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Filter Menu */
    .filter-menu {
      position: absolute;
      top: 60px;
      right: 32px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 16px;
      min-width: 220px;
      z-index: 100;
      animation: slideDown 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .filter-section {
      margin-bottom: 16px;
    }

    .filter-section:last-child {
      margin-bottom: 0;
    }

    .filter-label {
      font-size: 11px;
      font-weight: 700;
      color: #737373;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .filter-option {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 14px;
      color: #171717;
    }

    .filter-option:hover {
      background: #fafafa;
    }

    .filter-option input {
      margin-right: 10px;
      cursor: pointer;
    }

    .filter-option input[type="radio"],
    .filter-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #171717;
    }

    .filter-option span {
      flex: 1;
    }

    /* Tasks List Container */
    .tasks-list {
      padding: 20px 12px 24px;
      background: linear-gradient(to bottom, #fafafa 0%, #f5f5f5 100%);
      flex: 1;
      overflow-y: auto;
    }
    
    .tasks-list::-webkit-scrollbar {
      width: 10px;
    }
    
    .tasks-list::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .tasks-list::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
      border-radius: 5px;
      border: 2px solid #f5f5f5;
    }
    
    .tasks-list::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.5), rgba(118, 75, 162, 0.5));
    }

    /* Action Items View */
    .action-item {
      background: white;
      border: 2px solid rgba(0, 0, 0, 0.08);
      border-radius: 14px;
      padding: 18px 22px 16px;
      margin-bottom: 12px;
      margin-left: 40px;
      min-height: 120px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: visible;
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.08),
        0 2px 6px rgba(0, 0, 0, 0.12);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .action-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .action-item:hover {
      background: linear-gradient(135deg, rgba(0, 122, 255, 0.02), rgba(88, 86, 214, 0.01));
      border-color: rgba(0, 122, 255, 0.15);
      transform: translateY(-3px) scale(1.005);
      box-shadow: 
        0 12px 32px rgba(0, 122, 255, 0.12),
        0 6px 16px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    
    .action-item:hover::before {
      opacity: 1;
    }
    
    .action-item:active {
      transform: translateY(-1px) scale(1.002);
      box-shadow: 
        0 6px 16px rgba(0, 122, 255, 0.1),
        0 2px 6px rgba(0, 0, 0, 0.08);
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .action-item.completed {
      opacity: 0.6;
    }

    .action-item.completed .action-title {
      text-decoration: line-through;
      opacity: 0.6;
    }

    .action-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      padding-right: 80px; /* Space for priority badge */
    }
    
    .action-item-number {
      position: absolute;
      left: -40px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 14px;
      font-weight: 700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4);
      z-index: 10;
    }

    .action-app-icon {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.04));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    /* Holographic box around task details */
    .action-task-box {
      flex: 1;
      background: linear-gradient(135deg, rgba(0, 122, 255, 0.04), rgba(88, 86, 214, 0.03));
      border: 1px solid rgba(0, 122, 255, 0.1);
      border-radius: 8px;
      padding: 10px 14px;
      position: relative;
      backdrop-filter: blur(10px);
      max-width: calc(100% - 55px); /* Don't overlap with icon */
      overflow: hidden;
    }

    .action-task-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.3));
      pointer-events: none;
    }
    
    .action-task-box::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        transparent 30%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 70%
      );
      animation: shimmer 3s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes shimmer {
      0%, 100% {
        transform: translateX(-100%) translateY(-100%);
        opacity: 0;
      }
      50% {
        opacity: 1;
      }
    }

    .action-task-content {
      position: relative;
      z-index: 1;
    }

    .action-title {
      font-size: 15px;
      font-weight: 600;
      color: #171717;
      letter-spacing: -0.01em;
      line-height: 1.3;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      text-transform: capitalize;
      margin-bottom: 2px;
    }
    
    /* Keep normal case for titles that are already properly capitalized */
    .action-title.proper-case {
      text-transform: none;
    }

    .action-meta-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: #737373;
      background: rgba(0, 0, 0, 0.03);
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .meta-icon {
      font-size: 10px;
      opacity: 0.8;
    }
    
    .meta-highlight {
      background: rgba(0, 122, 255, 0.1);
      color: #007AFF;
      font-weight: 600;
    }

    /* Priority badge - top right position */
    .action-priority-badge {
      position: absolute;
      top: 18px;
      right: 22px;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      z-index: 2;
    }

    /* Footer with status and progress */
    .action-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding-top: 4px;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      margin-top: 4px;
      padding-top: 8px;
    }
    
    .action-status-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .action-status-badge.status-todo {
      background: rgba(142, 142, 147, 0.1);
      color: #8E8E93;
    }
    
    .action-status-badge.status-in_progress {
      background: rgba(255, 159, 10, 0.1);
      color: #FF9F0A;
    }
    
    .action-status-badge.status-completed {
      background: rgba(52, 199, 89, 0.1);
      color: #34C759;
    }
    
    .action-progress-mini {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      max-width: 180px;
    }

    .action-progress-bar {
      flex: 1;
      height: 6px;
      background: rgba(0, 122, 255, 0.08);
      border-radius: 6px;
      overflow: visible;
      position: relative;
      cursor: pointer;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .action-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007AFF 0%, #667eea 100%);
      border-radius: 6px;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      box-shadow: 
        0 0 10px rgba(0, 122, 255, 0.4),
        0 2px 3px rgba(0, 122, 255, 0.2);
    }
    
    .action-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.4), transparent);
      border-radius: 6px 6px 0 0;
    }

    .action-progress-bar:hover .action-progress-fill {
      box-shadow: 
        0 0 16px rgba(0, 122, 255, 0.6),
        0 2px 6px rgba(0, 122, 255, 0.3);
    }

    .action-progress-text {
      font-size: 12px;
      font-weight: 600;
      color: #737373;
      min-width: 36px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .action-notification-badge {
      background: rgba(0, 0, 0, 0.08);
      border: 1.5px solid rgba(0, 0, 0, 0.12);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      color: #171717;
      min-width: 36px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .action-priority-badge.priority-urgent {
      background: rgba(255, 59, 48, 0.15);
      color: #FF3B30;
      border-color: rgba(255, 59, 48, 0.3);
    }

    .action-priority-badge.priority-high {
      background: rgba(255, 159, 10, 0.15);
      color: #FF9F0A;
      border-color: rgba(255, 159, 10, 0.3);
    }

    .action-priority-badge.priority-medium {
      background: rgba(0, 122, 255, 0.15);
      color: #007AFF;
      border-color: rgba(0, 122, 255, 0.3);
    }

    .action-priority-badge.priority-low {
      background: rgba(142, 142, 147, 0.15);
      color: #8E8E93;
      border-color: rgba(142, 142, 147, 0.3);
    }

    .action-checkbox {
      width: 28px;
      height: 28px;
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    .action-checkbox:hover {
      background: #fafafa;
      border-color: #171717;
      transform: scale(1.05);
    }

    .action-checkbox svg {
      width: 16px;
      height: 16px;
      color: white;
      opacity: 0;
      transform: scale(0);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .action-item.completed .action-checkbox {
      background: #171717;
      border-color: #171717;
    }

    .action-item.completed .action-checkbox svg {
      opacity: 1;
      transform: scale(1);
    }

    .action-hover-buttons {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transform: translateY(-6px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }

    .action-item:hover .action-hover-buttons {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    .action-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .action-btn:hover {
      background: white;
      transform: scale(1.1);
      border-color: rgba(0, 0, 0, 0.2);
    }

    .action-btn.delete-btn:hover {
      background: rgba(255, 59, 48, 0.1);
      border-color: rgba(255, 59, 48, 0.3);
    }

    /* Task Chat Button */
    .task-action-btn.chat {
      background: #fafafa;
      color: #737373;
      font-size: 14px;
    }
    
    .task-action-btn.chat:hover {
      background: #f0f0f0;
      color: #171717;
      transform: scale(1.05);
    }
    
    /* Task Chat Modal - Light Theme */
    .task-chat-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #ffffff;
      z-index: 10000;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .task-chat-container {
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: scale(0.98);
      }
      to { 
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .task-chat-header {
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      background: white;
    }
    
    .task-chat-card {
      margin: 24px 32px;
      padding: 24px;
      background: white;
      border: 2px solid rgba(0, 0, 0, 0.08);
      border-radius: 14px;
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.08),
        0 2px 6px rgba(0, 0, 0, 0.12);
      position: relative;
    }
    
    .task-chat-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      border: 2px solid rgba(0, 0, 0, 0.08);
      color: #171717;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .task-chat-close:hover {
      background: #171717;
      color: white;
      border-color: #171717;
      transform: scale(1.05);
    }
    
    .task-chat-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-right: 40px;
    }
    
    .task-chat-app-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.04));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }
    
    .task-chat-title {
      flex: 1;
    }
    
    .task-chat-name {
      font-size: 18px;
      font-weight: 700;
      color: #171717;
      letter-spacing: -0.02em;
      line-height: 1.3;
      margin-bottom: 6px;
    }
    
    .task-chat-subtitle {
      font-size: 13px;
      color: #737373;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .task-chat-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 4px;
      font-size: 11px;
    }
    
    .task-chat-priority-badge {
      position: absolute;
      top: 24px;
      right: 70px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    
    .task-chat-context {
      display: none;
    }
    
    .task-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      background: white;
    }
    
    .task-chat-messages::-webkit-scrollbar {
      width: 10px;
    }
    
    .task-chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .task-chat-messages::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 5px;
    }
    
    .task-chat-messages::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
    
    .task-chat-welcome {
      text-align: center;
      padding: 40px 20px;
      color: #737373;
    }
    
    .task-chat-welcome .welcome-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .task-chat-welcome .welcome-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #171717;
    }
    
    .task-chat-welcome .welcome-subtitle {
      font-size: 14px;
      color: #a3a3a3;
    }
    
    .task-message {
      display: flex;
      flex-direction: column;
      gap: 8px;
      animation: messageSlideIn 0.3s ease;
    }
    
    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .task-message.user {
      align-items: flex-end;
    }
    
    .task-message.assistant {
      align-items: flex-start;
    }
    
    .task-message-bubble {
      max-width: 70%;
      padding: 14px 18px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.6;
      white-space: pre-wrap;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    
    .task-message.user .task-message-bubble {
      background: #171717;
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }
    
    .task-message.assistant .task-message-bubble {
      background: #f5f5f5;
      color: #171717;
      border: none;
      border-bottom-left-radius: 4px;
      box-shadow: none;
    }
    
    /* Better formatting for bot responses */
    .task-message.assistant .task-message-bubble p {
      margin: 0 0 12px 0;
      line-height: 1.6;
    }
    
    .task-message.assistant .task-message-bubble p:last-child {
      margin-bottom: 0;
    }
    
    .task-message.assistant .task-message-bubble strong {
      font-weight: 700;
      color: #000;
    }
    
    .task-message.assistant .task-message-bubble ul,
    .task-message.assistant .task-message-bubble ol {
      margin: 8px 0;
      padding-left: 24px;
    }
    
    .task-message.assistant .task-message-bubble li {
      margin: 6px 0;
      line-height: 1.5;
    }
    
    .task-message.assistant .task-message-bubble code {
      background: rgba(0, 0, 0, 0.06);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 14px;
    }
    
    .task-message.assistant .task-message-bubble pre {
      background: rgba(0, 0, 0, 0.06);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
    }
    
    .task-message.assistant .task-message-bubble blockquote {
      border-left: 3px solid #171717;
      padding-left: 12px;
      margin: 8px 0;
      font-style: italic;
      color: #525252;
    }
    
    .task-message-time {
      font-size: 11px;
      color: #a3a3a3;
      padding: 0 8px;
    }
    
    .task-chat-typing {
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: #737373;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      background: white;
    }
    
    .task-chat-input {
      padding: 20px 32px 24px;
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      background: #fafafa;
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-shrink: 0;
      box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.04);
    }
    
    .task-chat-textarea {
      flex: 1;
      background: white;
      border: 2px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      padding: 12px 18px;
      color: #171717;
      font-size: 15px;
      font-family: inherit;
      resize: none;
      min-height: 48px;
      max-height: 120px;
      transition: all 0.2s ease;
      line-height: 1.5;
    }
    
    .task-chat-textarea:focus {
      outline: none;
      border-color: #171717;
      background: white;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.06);
    }
    
    .task-chat-textarea::placeholder {
      color: #a3a3a3;
    }
    
    .task-chat-send {
      background: #171717;
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 16px;
    }
    
    .task-chat-send:hover {
      background: #2d2d2d;
      transform: scale(1.05);
    }
    
    .task-chat-send:active {
      transform: scale(0.95);
    }
    
    .task-chat-send:disabled {
      background: #e5e5e5;
      color: #a3a3a3;
      cursor: not-allowed;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 40px;
      color: #9ca3af;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 24px;
      opacity: 0.3;
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-10px);
      }
    }
    
    .empty-state > div:last-child {
      font-size: 16px;
      font-weight: 500;
      color: #6b7280;
      max-width: 300px;
      line-height: 1.6;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 212, 255, 0.3);
      border-radius: 3px;
    }

    /* User dropdown styles */
    .user-dropdown {
      position: relative;
      display: inline-block;
    }

    .user-dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: rgba(10, 10, 15, 0.98);
      backdrop-filter: blur(20px);
      min-width: 160px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 8px;
      z-index: 10000;
      margin-top: 8px;
      overflow: hidden;
    }

    .user-dropdown-content.show {
      display: block;
    }

    .user-dropdown-item {
      color: rgba(255, 255, 255, 0.9);
      padding: 12px 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .user-dropdown-item:hover {
      background: rgba(0, 212, 255, 0.1);
      color: #00d4ff;
    }

    .user-dropdown-item svg {
      width: 14px;
      height: 14px;
    }

    #appTitle {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      position: relative;
      z-index: 10;
    }

    #appTitle:hover {
      color: #00d4ff;
    }

    .copilot-title {
      -webkit-app-region: drag;
    }

    .user-dropdown {
      -webkit-app-region: no-drag;
      z-index: 100;
    }

    /* Notification Toast System */
    .notification-container {
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 10000;
      pointer-events: none;
    }

    .notification-toast {
      background: white;
      color: #171717;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 
        0 0 0 1px rgba(0, 0, 0, 0.06),
        0 10px 30px -8px rgba(0, 0, 0, 0.15);
      margin-bottom: 12px;
      min-width: 300px;
      max-width: 400px;
      pointer-events: auto;
      cursor: pointer;
      animation: slideIn 0.3s ease-out;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .notification-toast:hover {
      transform: translateX(-4px);
      box-shadow: 
        0 0 0 1px rgba(0, 0, 0, 0.08),
        0 15px 40px -10px rgba(0, 0, 0, 0.2);
    }

    .notification-toast.success {
      border-left: 4px solid #10b981;
    }

    .notification-toast.error {
      border-left: 4px solid #ef4444;
    }

    .notification-toast.warning {
      border-left: 4px solid #f59e0b;
    }

    .notification-toast.info {
      border-left: 4px solid #3b82f6;
    }

    .notification-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
      font-size: 14px;
      line-height: 1.5;
    }

    .notification-close {
      font-size: 18px;
      opacity: 0.5;
      cursor: pointer;
      flex-shrink: 0;
      transition: opacity 0.2s;
    }

    .notification-close:hover {
      opacity: 1;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .notification-toast.removing {
      animation: slideOut 0.2s ease-in forwards;
    }

    /* Arc Reactor Menu Styles - Floating, No Header */
    .arc-reactor-container {
      position: fixed;
      left: 20px;
      top: calc(100vh - 100px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      -webkit-app-region: no-drag;
      cursor: grab;
      user-select: none;
      transition: none;
    }

    .arc-reactor-container.dragging {
      cursor: grabbing;
    }

    body.collapsed .arc-reactor-container {
      -webkit-app-region: no-drag;
    }

    body.expanded .arc-reactor-container {
      -webkit-app-region: no-drag;
    }

    .arc-reactor-icon {
      width: 56px;
      height: 56px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: 10001;
      filter: drop-shadow(0 0 12px rgba(59, 130, 246, 0.6)) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
      -webkit-app-region: no-drag; /* Icon is clickable, not draggable */
      pointer-events: all; /* Ensure icon captures clicks */
    }

    .arc-reactor-icon:hover {
      transform: scale(1.15);
      filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.9)) drop-shadow(0 6px 12px rgba(0, 0, 0, 0.15));
    }

    .arc-reactor-icon.active {
      transform: scale(1.2);
      filter: drop-shadow(0 0 28px rgba(59, 130, 246, 1)) drop-shadow(0 8px 16px rgba(0, 0, 0, 0.2));
    }

    /* Radial Menu - Positioned outside orb window */
    .radial-menu {
      position: fixed;
      left: 20px;
      top: calc(100vh - 380px);
      width: 200px;
      height: auto;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .radial-menu.active {
      pointer-events: all;
      opacity: 1;
    }

    .radial-menu-item {
      position: relative;
      width: 100%;
      height: 55px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transform: translateY(10px);
      -webkit-app-region: no-drag;
    }

    .radial-menu.active .radial-menu-item {
      opacity: 1;
    }

    .radial-menu-item:hover {
      transform: translateY(-3px);
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3), 0 2px 6px rgba(0, 0, 0, 0.1);
      border-color: rgba(59, 130, 246, 0.6);
    }

    .radial-menu-item-icon {
      display: none;
    }

    .radial-menu-item-label {
      font-size: 15px;
      font-weight: 600;
      color: #1a1a1a;
      text-transform: none;
      letter-spacing: 0.3px;
      text-align: center;
      width: 100%;
    }

    /* Stack menu items vertically with staggered animation */
    .radial-menu.active .radial-menu-item:nth-child(1) {
      animation: menuItemFadeIn 0.3s ease-out 0.05s forwards;
    }

    .radial-menu.active .radial-menu-item:nth-child(2) {
      animation: menuItemFadeIn 0.3s ease-out 0.1s forwards;
    }

    .radial-menu.active .radial-menu-item:nth-child(3) {
      animation: menuItemFadeIn 0.3s ease-out 0.15s forwards;
    }

    .radial-menu.active .radial-menu-item:nth-child(4) {
      animation: menuItemFadeIn 0.3s ease-out 0.2s forwards;
    }

    @keyframes menuItemFadeIn {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Overlay when menu is open */
    .radial-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 999;
    }

    .radial-menu-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    /* Hide header actions on right */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

  </style>
</head>
<body class="collapsed">
  <!-- Radial Menu Overlay -->
  <div class="radial-menu-overlay" id="radialMenuOverlay" onclick="closeRadialMenu()"></div>
  
  <!-- Floating Arc Reactor (No Header) -->
  <div class="arc-reactor-container">
    <!-- Arc Reactor Icon - will try to load user's image, fallback to SVG -->
    <img src="public/arcreactor.png" class="arc-reactor-icon" id="arcReactorIcon" 
         onmousedown="handleArcReactorMouseDown(event)"
         onclick="handleArcReactorClick(event)"
         onerror="this.style.display='none'; document.getElementById('arcReactorSvg').style.display='block';" 
         style="object-fit: contain;">
    
    <svg class="arc-reactor-icon" id="arcReactorSvg" 
         onmousedown="handleArcReactorMouseDown(event)"
         onclick="handleArcReactorClick(event)"
         viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <defs>
        <radialGradient id="arcGlow" cx="50%" cy="50%" r="50%">
          <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#3b82f6;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
        </radialGradient>
        <filter id="glow">
          <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
          <feMerge>
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      <circle cx="50" cy="50" r="45" fill="none" stroke="url(#arcGlow)" stroke-width="3" filter="url(#glow)"/>
      <circle cx="50" cy="50" r="35" fill="none" stroke="url(#arcGlow)" stroke-width="2" opacity="0.6"/>
      <circle cx="50" cy="50" r="25" fill="none" stroke="url(#arcGlow)" stroke-width="2" opacity="0.4"/>
      <circle cx="50" cy="50" r="20" fill="url(#arcGlow)" opacity="0.8"/>
      <circle cx="50" cy="50" r="8" fill="white" opacity="0.9"/>
    </svg>

    <div class="radial-menu" id="radialMenu">
      <div class="radial-menu-item" onclick="selectMenuItem('chat')">
        <div class="radial-menu-item-icon">ðŸ’¬</div>
        <div class="radial-menu-item-label">Chat</div>
      </div>
      <div class="radial-menu-item" onclick="selectMenuItem('tasks')">
        <div class="radial-menu-item-icon">ðŸ“‹</div>
        <div class="radial-menu-item-label">Tasks</div>
      </div>
      <div class="radial-menu-item" onclick="selectMenuItem('settings')">
        <div class="radial-menu-item-icon">âš™ï¸</div>
        <div class="radial-menu-item-label">Settings</div>
      </div>
      <div class="radial-menu-item" onclick="selectMenuItem('followup')">
        <div class="radial-menu-item-icon">ðŸ””</div>
        <div class="radial-menu-item-label">Follow Up</div>
      </div>
    </div>
  </div>
  
  <!-- Hidden Header (kept for compatibility but not visible) -->
  <div class="copilot-header">
    <div class="header-actions">
      <button class="header-action-btn" onclick="switchTab('tasks')" title="Notifications">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <span class="notification-badge" id="notificationBadge" style="display: none;"></span>
      </button>
      <button class="header-action-btn" onclick="startFactCheck()" title="Fact Check">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </button>
      <button class="ms-auth-btn" id="msAuthBtn" onclick="toggleMicrosoftAuth()" title="Microsoft 365">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M11.4 24H0V12.6h11.4V24zM24 24H12.6V12.6H24V24zM11.4 11.4H0V0h11.4v11.4zm12.6 0H12.6V0H24v11.4z"/>
        </svg>
        <span class="ms-status-dot"></span>
      </button>
      <button class="ms-auth-btn" id="googleAuthBtn" onclick="toggleGoogleAuth()" title="Google Workspace">
        <svg width="16" height="16" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        <span class="ms-status-dot"></span>
      </button>
      <button class="github-auth-btn" id="githubAuthBtn" onclick="toggleGitHubConnection()" title="GitHub">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
        <span class="github-status-dot"></span>
      </button>
      <button class="jira-auth-btn" id="jiraAuthBtn" onclick="handleJIRAButtonClick()" title="JIRA" style="display: none;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M11.571 11.513H0a5.218 5.218 0 0 0 5.232 5.215h2.13v2.057A5.215 5.215 0 0 0 12.575 24V12.518a1.005 1.005 0 0 0-1.005-1.005zm5.723-5.756H5.736a5.215 5.215 0 0 0 5.215 5.214h2.129v2.058a5.218 5.218 0 0 0 5.215 5.214V6.758a1.001 1.001 0 0 0-1.001-1.001zM23.01 0H11.455a5.215 5.215 0 0 0 5.215 5.215h2.129v2.057A5.215 5.215 0 0 0 24 12.483V1.005A1.005 1.005 0 0 0 23.01 0z"/>
        </svg>
        <span class="jira-status-dot"></span>
      </button>

    </div>
    
    <div class="copilot-controls">
      <button class="control-btn minimize" onclick="collapseTopBar()" title="Collapse">âˆ’</button>
      <button class="control-btn close" onclick="closeWindow()" title="Hide">Ã—</button>
    </div>
  </div>


  <div class="copilot-content">
    <!-- Copilot Tab -->
    <div id="copilotTab" class="tab-content active">
      <div class="chat-interface">
        <div class="chat-container" id="chatContainer">
          <div class="welcome-message">
            <img src="../../Jarvis.png" alt="HeyJarvis" class="welcome-logo">
            <div class="welcome-text">
              We are your Mission Control.
              <div class="welcome-subtitle">How can we help you today?</div>
            </div>
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <div>âœ¨</div>
          <div>
            <span>HeyJarvis is thinking</span>
            <div style="display: inline-flex; gap: 6px; margin-left: 12px;">
              <div style="width: 8px; height: 8px; background: #007AFF; border-radius: 50%;"></div>
              <div style="width: 8px; height: 8px; background: #007AFF; border-radius: 50%;"></div>
              <div style="width: 8px; height: 8px; background: #007AFF; border-radius: 50%;"></div>
            </div>
          </div>
        </div>

        <div class="input-container">
          <div class="input-wrapper">
            <textarea class="message-input" id="messageInput" placeholder="Ask me anything..." rows="1"></textarea>
            <button class="send-btn" onclick="sendMessage()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="m3 3 18 9-18 9V3z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tasks Tab -->
    <div id="tasksTab" class="tab-content">
      <div class="tasks-container">
        <div class="action-items-header">
          <div class="action-items-title">To Do</div>
          <button class="simple-filter-btn" onclick="toggleFilterMenu()" title="Filter">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="4" y1="21" x2="4" y2="14"></line>
              <line x1="4" y1="10" x2="4" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12" y2="3"></line>
              <line x1="20" y1="21" x2="20" y2="16"></line>
              <line x1="20" y1="12" x2="20" y2="3"></line>
              <line x1="1" y1="14" x2="7" y2="14"></line>
              <line x1="9" y1="8" x2="15" y2="8"></line>
              <line x1="17" y1="16" x2="23" y2="16"></line>
            </svg>
          </button>
          
          <!-- Filter Dropdown Menu -->
          <div id="filterMenu" class="filter-menu" style="display: none;">
            <div class="filter-section">
              <div class="filter-label">Assignment</div>
              <label class="filter-option">
                <input type="radio" name="assignment" value="all" checked onchange="applyFilters()">
                <span>All Tasks</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="assignment" value="assigned_to_me" onchange="applyFilters()">
                <span>Assigned to Me</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="assignment" value="assigned_by_me" onchange="applyFilters()">
                <span>Assigned by Me</span>
              </label>
            </div>
            
            <div class="filter-section">
              <div class="filter-label">Priority</div>
              <label class="filter-option">
                <input type="checkbox" name="priority" value="all" checked onchange="applyFilters()">
                <span>All Priorities</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" name="priority" value="urgent" onchange="applyFilters()">
                <span>ðŸ”´ Urgent</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" name="priority" value="high" onchange="applyFilters()">
                <span>ðŸŸ  High</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" name="priority" value="medium" onchange="applyFilters()">
                <span>ðŸ”µ Medium</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" name="priority" value="low" onchange="applyFilters()">
                <span>âšª Low</span>
              </label>
            </div>
          </div>
        </div>

        <div class="tasks-list" id="tasksList">
          <div class="empty-state">
            <div class="empty-icon">ðŸ“‹</div>
            <div>No tasks yet. Add one above to get started!</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Code Indexer Tab -->
    <div id="indexerTab" class="tab-content">
      <div class="indexer-container" style="padding: 20px; max-width: 900px; margin: 0 auto;">
        
        <!-- Header -->
        <div style="margin-bottom: 32px;">
          <h2 style="font-size: 24px; font-weight: 700; color: #171717; margin-bottom: 8px;">
            ðŸ” Code Indexer
          </h2>
          <p style="font-size: 14px; color: #737373;">
            Index your GitHub repositories and ask questions about your code in natural language
          </p>
        </div>

        <!-- Query Section -->
        <div style="background: #f9fafb; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
          <h3 style="font-size: 16px; font-weight: 600; color: #171717; margin-bottom: 16px;">
            Ask a Question
          </h3>
          <div style="display: flex; gap: 12px; margin-bottom: 12px;">
            <input 
              type="text" 
              id="codeQuery" 
              placeholder="E.g., Do we have SSO authentication? What APIs are available?"
              style="flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;"
              onkeypress="if(event.key==='Enter') askCodeQuestion()"
            >
            <button 
              onclick="askCodeQuestion()"
              style="padding: 12px 24px; background: #171717; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;"
            >
              Ask Question
            </button>
          </div>
          <select 
            id="repositorySelect"
            style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #525252;"
          >
            <option value="">Select a repository...</option>
          </select>
        </div>

        <!-- Answer Section -->
        <div id="answerSection" style="display: none; background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <h3 style="font-size: 16px; font-weight: 600; color: #171717;">Answer</h3>
            <span id="confidenceBadge" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;"></span>
          </div>
          <div id="answerContent" style="font-size: 14px; line-height: 1.8; color: #171717; margin-bottom: 20px;"></div>
          <div id="sourcesSection" style="display: none;">
            <h4 style="font-size: 14px; font-weight: 600; color: #525252; margin-bottom: 12px;">ðŸ“š Code References</h4>
            <div id="sourcesList" style="display: flex; flex-direction: column; gap: 8px;"></div>
          </div>
        </div>

        <!-- Loading -->
        <div id="queryLoading" style="display: none; text-align: center; padding: 40px;">
          <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top: 4px solid #171717; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <p style="margin-top: 16px; color: #737373;">Searching codebase...</p>
        </div>

        <!-- Repositories Section -->
        <div style="margin-top: 40px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <h3 style="font-size: 18px; font-weight: 600; color: #171717;">Indexed Repositories</h3>
            <button 
              onclick="refreshRepositories()"
              style="padding: 8px 16px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;"
            >
              ðŸ”„ Refresh
            </button>
          </div>
          <div id="repositoriesList" style="display: flex; flex-direction: column; gap: 12px;">
            <!-- Repositories will be loaded here -->
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Task Chat Modal -->
  <div id="taskChatModal" class="task-chat-modal" style="display: none;">
    <div class="task-chat-container">
      <div class="task-chat-header">
        <div class="task-chat-card">
          <button class="task-chat-close" onclick="closeTaskChat()">Ã—</button>
          
          <div class="task-chat-card-header">
            <div class="task-chat-app-icon" id="taskChatIcon">
              <img src="/Users/jarvis/Code/HeyJarvis/desktop/public/Slack_icon_2019.svg.png" style="width: 24px; height: 24px; object-fit: contain;" alt="Slack">
            </div>
            <div class="task-chat-title">
              <div class="task-chat-name" id="taskChatName">Task Discussion</div>
              <div class="task-chat-subtitle" id="taskChatSubtitle">
                <span class="task-chat-meta-item">From: <span id="taskChatAssignor">Someone</span></span>
                <span class="task-chat-meta-item" id="taskChatDate">Just now</span>
              </div>
            </div>
          </div>
          
          <div class="task-chat-priority-badge priority-medium" id="taskChatPriority">Medium</div>
        </div>
      </div>
      
      <!-- Live JIRA Task Card -->
      <div id="liveJiraTaskCard" style="display: none; margin: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.2); overflow: hidden;">
        
        <!-- Card Header -->
        <div style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.15);">
          <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 8px;">
            <div style="flex: 1;">
              <div id="jiraCardTitle" style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 6px; line-height: 1.3;"></div>
              <div id="jiraCardMeta" style="font-size: 12px; color: rgba(255,255,255,0.8); display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"></div>
            </div>
            <div style="display: flex; gap: 6px;">
              <button onclick="toggleCardExpanded()" id="jiraCardExpandBtn"
                      style="padding: 6px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; backdrop-filter: blur(10px);"
                      title="Expand/Collapse">
                â¬‡ï¸
              </button>
              <button onclick="refreshJiraTaskCard()" 
                      style="padding: 6px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; backdrop-filter: blur(10px);"
                      title="Refresh from JIRA">
                ðŸ”„
              </button>
            </div>
          </div>
          
          <!-- Status, Priority, Assignee Badges -->
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <div id="jiraCardStatus" style="padding: 5px 12px; background: rgba(255,255,255,0.25); color: white; border-radius: 6px; font-size: 12px; font-weight: 600; backdrop-filter: blur(10px); cursor: pointer;" onclick="showStatusPicker()" title="Click to change status"></div>
            <div id="jiraCardPriority" style="padding: 5px 12px; background: rgba(255,255,255,0.25); color: white; border-radius: 6px; font-size: 12px; font-weight: 600; backdrop-filter: blur(10px); cursor: pointer;" onclick="showPriorityPicker()" title="Click to change priority"></div>
            <div id="jiraCardAssignee" style="padding: 5px 12px; background: rgba(255,255,255,0.25); color: white; border-radius: 6px; font-size: 12px; font-weight: 600; backdrop-filter: blur(10px);"></div>
            <div id="jiraCardMetrics" style="padding: 5px 12px; background: rgba(255,255,255,0.25); color: white; border-radius: 6px; font-size: 12px; font-weight: 600; backdrop-filter: blur(10px);"></div>
          </div>
        </div>
        
        <!-- Expanded Content (collapsible) -->
        <div id="jiraCardExpanded" style="display: block; max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.1);">
          
          <!-- Description Section -->
          <div style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
              <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9);">ðŸ“ Description</div>
              <button onclick="editDescription()" style="padding: 4px 8px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: 600;">Edit</button>
            </div>
            <div id="jiraCardDescription" style="font-size: 13px; color: rgba(255,255,255,0.85); line-height: 1.5; max-height: 100px; overflow-y: auto;"></div>
          </div>
          
          <!-- Quick Comment -->
          <div style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 8px;">ðŸ’¬ Quick Comment</div>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="jiraCardQuickComment" 
                     placeholder="Add a quick comment..." 
                     style="flex: 1; padding: 8px 12px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 13px; backdrop-filter: blur(10px);"
                     onkeypress="if(event.key==='Enter') addQuickComment()">
              <button onclick="addQuickComment()" 
                      style="padding: 8px 16px; background: rgba(255,255,255,0.9); color: #667eea; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap;">
                Send
              </button>
            </div>
          </div>
          
          <!-- Activity Feed -->
          <div style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 8px;">âš¡ Recent Activity</div>
            <div id="jiraCardActivity" style="max-height: 150px; overflow-y: auto;"></div>
          </div>
          
          <!-- Time Tracking (if available) -->
          <div id="jiraCardTimeTracking" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); display: none;">
            <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 8px;">â±ï¸ Time Tracking</div>
            <div id="jiraCardTimeContent"></div>
          </div>
          
          <!-- Labels/Tags -->
          <div id="jiraCardLabels" style="padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1); display: none;">
            <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); margin-bottom: 8px;">ðŸ·ï¸ Labels</div>
            <div id="jiraCardLabelsContent" style="display: flex; gap: 6px; flex-wrap: wrap;"></div>
          </div>
        </div>
        
        <!-- Quick Actions Footer -->
        <div style="padding: 12px 16px; background: rgba(0,0,0,0.15); border-top: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; gap: 6px; flex-wrap: wrap;">
            <button onclick="quickJiraAction('In Progress')" 
                    style="flex: 1; min-width: 90px; padding: 10px 12px; background: rgba(255,255,255,0.95); color: #667eea; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;"
                    onmouseenter="this.style.background='white'; this.style.transform='translateY(-1px)'"
                    onmouseleave="this.style.background='rgba(255,255,255,0.95)'; this.style.transform='translateY(0)'">
              â–¶ï¸ Start
            </button>
            <button onclick="quickJiraAction('Done')" 
                    style="flex: 1; min-width: 90px; padding: 10px 12px; background: rgba(52, 199, 89, 0.95); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;"
                    onmouseenter="this.style.background='#34C759'; this.style.transform='translateY(-1px)'"
                    onmouseleave="this.style.background='rgba(52, 199, 89, 0.95)'; this.style.transform='translateY(0)'">
              âœ“ Done
            </button>
            <button onclick="openJiraInBrowser()" 
                    style="flex: 1; min-width: 90px; padding: 10px 12px; background: rgba(0, 82, 204, 0.95); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;"
                    onmouseenter="this.style.background='#0052CC'; this.style.transform='translateY(-1px)'"
                    onmouseleave="this.style.background='rgba(0, 82, 204, 0.95)'; this.style.transform='translateY(0)'">
              ðŸ”— Open
            </button>
          </div>
        </div>
        
        <!-- Last Updated & Live Indicator -->
        <div style="padding: 8px 16px; background: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between;">
          <div style="display: flex; align-items: center; gap: 6px;">
            <div id="jiraCardLiveIndicator" style="width: 8px; height: 8px; background: #34C759; border-radius: 50%; animation: pulse 2s infinite;" title="Live syncing"></div>
            <div id="jiraCardLastUpdated" style="font-size: 11px; color: rgba(255,255,255,0.7);"></div>
          </div>
          <div id="jiraCardSyncStatus" style="font-size: 11px; color: rgba(255,255,255,0.7);"></div>
        </div>
      </div>
      
      <!-- CSS for animations -->
      <style>
        @keyframes pulse {
          0%, 100% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.5; transform: scale(0.9); }
        }
        
        @keyframes flash {
          0%, 100% { background: rgba(255,255,255,0.25); box-shadow: 0 0 0 rgba(255,215,0,0.5); }
          50% { background: rgba(255,215,0,0.5); box-shadow: 0 0 10px rgba(255,215,0,0.8); }
        }
        
        #jiraCardExpanded::-webkit-scrollbar {
          width: 8px;
        }
        
        #jiraCardExpanded::-webkit-scrollbar-track {
          background: rgba(255,255,255,0.1);
          border-radius: 4px;
        }
        
        #jiraCardExpanded::-webkit-scrollbar-thumb {
          background: rgba(255,255,255,0.3);
          border-radius: 4px;
        }
        
        #jiraCardExpanded::-webkit-scrollbar-thumb:hover {
          background: rgba(255,255,255,0.5);
        }
        
        #jiraCardActivity::-webkit-scrollbar,
        #jiraCardDescription::-webkit-scrollbar {
          width: 6px;
        }
        
        #jiraCardActivity::-webkit-scrollbar-track,
        #jiraCardDescription::-webkit-scrollbar-track {
          background: rgba(255,255,255,0.1);
          border-radius: 3px;
        }
        
        #jiraCardActivity::-webkit-scrollbar-thumb,
        #jiraCardDescription::-webkit-scrollbar-thumb {
          background: rgba(255,255,255,0.3);
          border-radius: 3px;
        }
      </style>
      
      <div class="task-chat-context">
        <div class="task-context-label">Task Context:</div>
        <div class="task-context-content" id="taskChatContext"></div>
      </div>
      
      <div class="task-chat-messages" id="taskChatMessages">
        <div class="task-chat-welcome">
          <div class="welcome-icon">ðŸŽ¯</div>
          <div class="welcome-text">Let's work on this task together!</div>
          <div class="welcome-subtitle">I can help you brainstorm, plan, and complete this task.</div>
        </div>
      </div>
      
      <div class="task-chat-typing" id="taskChatTyping" style="display: none;">
        <div>âœ¨</div>
        <div>
          <span>Thinking about your task...</span>
        </div>
      </div>
      
      <div class="task-chat-input">
        <textarea 
          id="taskChatInput" 
          class="task-chat-textarea" 
          placeholder="Ask about this task, brainstorm ideas, get help..." 
          rows="1"
        ></textarea>
        <button class="task-chat-send" onclick="sendTaskChatMessage()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19V5M5 12l7-7 7 7"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentTab = 'copilot';
    let currentPriority = 'medium';
    let tasks = [];
    let taskViewMode = 'action'; // 'action' or 'list'
    let isExpanded = false;
    let chatHistory = [];
    let crmData = null;
    let slackConnected = false;
    let servicesInitialized = false;
    let currentTaskChat = null;
    let taskChatHistories = {}; // Store chat history for each task

    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const headerInput = document.getElementById('headerInput');
    const typingIndicator = document.getElementById('typingIndicator');

    // Arc Reactor Menu Functions
    let arcReactorDragging = false;
    let arcReactorDragOffset = { x: 0, y: 0 };
    let arcReactorClickStart = 0;
    let arcReactorMoved = false;

    function handleArcReactorMouseDown(e) {
      console.log('ðŸ–±ï¸ Arc Reactor mousedown detected!', e.target);
      e.preventDefault();
      e.stopPropagation();
      
      arcReactorClickStart = Date.now();
      arcReactorMoved = false;
      
      const container = document.querySelector('.arc-reactor-container');
      if (!container) {
        console.error('âŒ Arc Reactor container not found!');
        return;
      }
      
      const rect = container.getBoundingClientRect();
      console.log('ðŸ“ Container position:', rect);
      
      arcReactorDragOffset = {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
      
      arcReactorDragging = true;
      container.classList.add('dragging');
      console.log('âœ… Dragging mode activated');
      
      // Add global mouse move and up listeners
      document.addEventListener('mousemove', handleArcReactorMouseMove);
      document.addEventListener('mouseup', handleArcReactorMouseUp);
    }

    function handleArcReactorMouseMove(e) {
      if (!arcReactorDragging) return;
      
      arcReactorMoved = true;
      const container = document.querySelector('.arc-reactor-container');
      const menu = document.querySelector('.radial-menu');
      
      const newX = e.clientX - arcReactorDragOffset.x;
      const newY = e.clientY - arcReactorDragOffset.y;
      
      // Clamp position to keep orb visible
      const clampedX = Math.max(0, Math.min(window.innerWidth - 80, newX));
      const clampedY = Math.max(0, Math.min(window.innerHeight - 80, newY));
      
      // Update position
      container.style.left = clampedX + 'px';
      container.style.top = clampedY + 'px';
      
      // Update menu position to follow (280px above orb)
      if (menu) {
        menu.style.left = clampedX + 'px';
        menu.style.top = (clampedY - 280) + 'px';
      }
    }

    function handleArcReactorMouseUp(e) {
      const clickDuration = Date.now() - arcReactorClickStart;
      const container = document.querySelector('.arc-reactor-container');
      
      console.log('ðŸ–±ï¸ Arc Reactor mouseup - duration:', clickDuration, 'ms, moved:', arcReactorMoved);
      
      container.classList.remove('dragging');
      arcReactorDragging = false;
      
      // Remove global listeners
      document.removeEventListener('mousemove', handleArcReactorMouseMove);
      document.removeEventListener('mouseup', handleArcReactorMouseUp);
      
      // If it was a quick click without movement, toggle menu
      if (clickDuration < 300 && !arcReactorMoved) {
        console.log('âœ… Quick click detected - opening menu');
        e.stopPropagation();
        toggleRadialMenu();
      } else {
        console.log('â„¹ï¸ Not a quick click - was a drag operation');
      }
    }

    function handleArcReactorClick(e) {
      // Prevent default click if we already handled it
      e.stopPropagation();
    }

    async function toggleRadialMenu() {
      const menu = document.getElementById('radialMenu');
      const overlay = document.getElementById('radialMenuOverlay');
      const iconImg = document.getElementById('arcReactorIcon');
      const iconSvg = document.getElementById('arcReactorSvg');
      
      const isActive = menu.classList.contains('active');
      
      if (isActive) {
        closeRadialMenu();
      } else {
        // Expand window to show menu
        if (window.electronAPI && window.electronAPI.menu && window.electronAPI.menu.open) {
          await window.electronAPI.menu.open();
        }
        
        menu.classList.add('active');
        overlay.classList.add('active');
        if (iconImg) iconImg.classList.add('active');
        if (iconSvg) iconSvg.classList.add('active');
      }
    }

    async function closeRadialMenu() {
      const menu = document.getElementById('radialMenu');
      const overlay = document.getElementById('radialMenuOverlay');
      const iconImg = document.getElementById('arcReactorIcon');
      const iconSvg = document.getElementById('arcReactorSvg');
      
      menu.classList.remove('active');
      overlay.classList.remove('active');
      if (iconImg) iconImg.classList.remove('active');
      if (iconSvg) iconSvg.classList.remove('active');
      
      // Collapse window back to orb
      if (window.electronAPI && window.electronAPI.menu && window.electronAPI.menu.close) {
        await window.electronAPI.menu.close();
      }
    }

    async function selectMenuItem(item) {
      closeRadialMenu();
      
      // Map menu items to tabs
      const tabMap = {
        'chat': 'chat',
        'tasks': 'tasks',
        'settings': 'indexer', // Map to indexer for now
        'followup': 'tasks' // Map to tasks for now
      };
      
      const targetTab = tabMap[item] || 'chat';
      console.log('ðŸ“‹ Menu item selected:', item, 'â†’', targetTab);
      
      // First expand the window if collapsed
      if (!isExpanded) {
        console.log('ðŸ”¼ Expanding window from orb mode...');
        expandTopBar();
        
        // Wait a bit for animation
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      // Switch to the appropriate tab
      switchTab(targetTab);
    }

    // Listen for tab switch messages from main process
    if (window.electronAPI && window.electronAPI.onMessage) {
      window.electronAPI.onMessage('switch-to-tab', (tab) => {
        console.log('ðŸ“‹ Received switch-to-tab message:', tab);
        switchTab(tab);
      });
    }

    // Tab switching
    function switchTab(tab) {
      currentTab = tab;
      
      // Expand interface when switching tabs
      if (!isExpanded) expandTopBar();
      
      // Update navigation buttons
      document.querySelectorAll('.header-nav-btn').forEach(btn => btn.classList.remove('active'));
      const navMap = { 
        'chat': 'chatNavBtn', 
        'copilot': 'chatNavBtn', 
        'tasks': 'tasksNavBtn',
        'indexer': 'indexerNavBtn'
      };
      const targetBtn = document.getElementById(navMap[tab]);
      if (targetBtn) targetBtn.classList.add('active');
      
      // Update content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      const contentMap = { 
        'chat': 'copilotTab', 
        'copilot': 'copilotTab', 
        'tasks': 'tasksTab',
        'indexer': 'indexerTab'
      };
      const targetContent = document.getElementById(contentMap[tab]);
      if (targetContent) targetContent.classList.add('active');
      
      if (tab === 'tasks') {
        loadTasks();
      } else if (tab === 'indexer') {
        loadIndexerData();
      }
    }

    // Priority selection
    function selectPriority(priority) {
      currentPriority = priority;
      document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    // Task management
    async function addTask() {
      const input = document.getElementById('taskInput');
      const title = input.value.trim();
      
      if (!title) return;
      
      if (!window.electronAPI || !window.electronAPI.tasks) {
        console.warn('Task API not available');
        alert('Task functionality requires the desktop app');
        return;
      }
      
      try {
        const result = await window.electronAPI.tasks.create({
          title,
          priority: currentPriority
        });
        
        if (result.success) {
          input.value = '';
          await loadTasks();
        } else {
          console.error('Failed to create task:', result.error);
        }
      } catch (error) {
        console.error('Error creating task:', error);
      }
    }

    let currentAssignmentView = 'assigned_to_me';

    async function changeAssignmentView() {
      const filterSelect = document.getElementById('assignmentFilter');
      currentAssignmentView = filterSelect.value;
      console.log('ðŸ”„ Changing assignment view to:', currentAssignmentView);
      await loadTasks();
    }

    async function loadTasks() {
      console.log('ðŸ”¥ loadTasks() called, currentAssignmentView:', currentAssignmentView);
      
      try {
        if (!window.electronAPI || !window.electronAPI.tasks) {
          console.error('âŒ Task API not available!');
          renderTasks(); // Show empty state
          return;
        }
        
        console.log('ðŸ”„ Calling electronAPI.tasks.getAll...');
        const result = await window.electronAPI.tasks.getAll({
          assignmentView: currentAssignmentView
        });
        
        console.log('ðŸ“¦ Backend response:', result);
        
        if (result.success) {
          tasks = result.tasks;
          console.log(`âœ… Loaded ${tasks.length} tasks for view: ${currentAssignmentView}`);
          console.log('Tasks:', tasks);
          await renderTasks();
          updateStats();
        } else {
          console.error('âŒ Failed to load tasks:', result.error);
          await renderTasks();
        }
      } catch (error) {
        console.error('âŒ Error loading tasks:', error);
        await renderTasks();
      }
    }

    // Sync JIRA tasks
    async function syncJIRATasks() {
      const syncBtn = document.getElementById('jiraSyncButton');
      
      if (!syncBtn) return;
      
      try {
        // Disable button and show loading state
        syncBtn.disabled = true;
        syncBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 6px; animation: spin 1s linear infinite;">
            <path d="M13.657 2.343a8 8 0 1 1-11.314 0M8 1v7"></path>
          </svg>
          Syncing...
        `;
        
        console.log('ðŸ”„ Starting JIRA task sync...');
        
        const result = await window.electronAPI.jira.syncTasks();
        
        if (result.success) {
          console.log(`âœ… JIRA sync complete: ${result.tasksCreated} created, ${result.tasksUpdated} updated`);
          
          // Show success notification
          showNotification(
            `JIRA sync complete! ${result.tasksCreated} new, ${result.tasksUpdated} updated`,
            'success'
          );
          
          // Reload tasks to show the new JIRA tasks
          await loadTasks();
        } else {
          console.error('âŒ JIRA sync failed:', result.error);
          showNotification(`Sync failed: ${result.error}`, 'error');
        }
      } catch (error) {
        console.error('âŒ JIRA sync error:', error);
        showNotification(`Sync error: ${error.message}`, 'error');
      } finally {
        // Re-enable button and restore original text
        syncBtn.disabled = false;
        syncBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 6px;">
            <path d="M13.657 2.343a8 8 0 1 1-11.314 0M8 1v7"></path>
          </svg>
          Sync JIRA
        `;
      }
    }

    // Check JIRA connection and show sync button if connected
    async function checkJIRAConnection() {
      try {
        if (!window.electronAPI || !window.electronAPI.jira) {
          console.log('â„¹ï¸ JIRA API not available');
          return;
        }
        
        const result = await window.electronAPI.jira.checkConnection();
        
        // Update sync button visibility
        const syncBtn = document.getElementById('jiraSyncButton');
        if (syncBtn && result.connected) {
          syncBtn.style.display = 'flex';
          console.log('âœ… JIRA connected - sync button visible');
        }
        
        // Update auth button state
        const authBtn = document.getElementById('jiraAuthBtn');
        if (authBtn) {
          if (result.connected) {
            authBtn.classList.add('connected');
            authBtn.title = `JIRA Connected (${result.siteUrl}) - Click to refresh`;
          } else {
            authBtn.classList.remove('connected');
            authBtn.title = 'JIRA Not Connected - Click to authenticate';
          }
        }
      } catch (error) {
        console.error('Error checking JIRA connection:', error);
      }
    }

    // Cache for Slack user names
    const slackUserCache = new Map();

    async function getSlackUserName(slackUserId) {
      console.log('ðŸ” getSlackUserName called with:', slackUserId);
      
      if (!slackUserId) {
        console.log('âš ï¸ No Slack user ID provided to getSlackUserName');
        return 'Unknown';
      }
      
      // Check cache first
      if (slackUserCache.has(slackUserId)) {
        console.log('âœ… Using cached name for:', slackUserId, 'â†’', slackUserCache.get(slackUserId));
        return slackUserCache.get(slackUserId);
      }

      console.log('ðŸ” Fetching name for Slack user:', slackUserId);

      // Fetch from Slack
      try {
        if (window.electronAPI && window.electronAPI.tasks && window.electronAPI.tasks.getSlackUserInfo) {
          console.log('âœ… electronAPI.tasks.getSlackUserInfo is available');
          const userInfo = await window.electronAPI.tasks.getSlackUserInfo(slackUserId);
          console.log('ðŸ“¦ Received user info:', userInfo);
          const name = userInfo.success ? userInfo.name : slackUserId;
          slackUserCache.set(slackUserId, name);
          console.log('âœ… Resolved', slackUserId, 'â†’', name);
          return name;
        } else {
          console.error('âš ï¸ electronAPI.tasks.getSlackUserInfo not available!', {
            hasElectronAPI: !!window.electronAPI,
            hasTasks: !!(window.electronAPI && window.electronAPI.tasks),
            hasGetSlackUserInfo: !!(window.electronAPI && window.electronAPI.tasks && window.electronAPI.tasks.getSlackUserInfo)
          });
        }
      } catch (error) {
        console.error('âŒ Error fetching Slack user info:', error);
      }

      console.log('âš ï¸ Falling back to ID:', slackUserId);
      return slackUserId; // Fallback to ID
    }

    // Helper function to resolve Slack mentions in text
    async function resolveSlackMentions(text) {
      if (!text) return text;
      
      // Find all Slack mentions in the format <@U12345678>
      const mentionPattern = /<@([A-Z0-9]+)>/g;
      const mentions = [...text.matchAll(mentionPattern)];
      
      if (mentions.length === 0) return text;
      
      console.log('ðŸ” Found', mentions.length, 'mentions in text:', text);
      
      // Resolve all mentions
      let resolvedText = text;
      for (const match of mentions) {
        const userId = match[1];
        const userName = await getSlackUserName(userId);
        // Replace <@U12345678> with @Name
        resolvedText = resolvedText.replace(match[0], `@${userName}`);
      }
      
      console.log('âœ… Resolved mentions:', resolvedText);
      return resolvedText;
    }

    // Filter menu functions
    function toggleFilterMenu() {
      const menu = document.getElementById('filterMenu');
      if (menu) {
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Close filter menu when clicking outside
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('filterMenu');
      const btn = document.querySelector('.simple-filter-btn');
      if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.style.display = 'none';
      }
    });

    function applyFilters() {
      // Get selected assignment filter
      const assignmentFilter = document.querySelector('input[name="assignment"]:checked')?.value || 'all';
      
      // Get selected priority filters
      const priorityCheckboxes = document.querySelectorAll('input[name="priority"]:checked');
      const priorities = Array.from(priorityCheckboxes).map(cb => cb.value);
      
      // Store filters and reload tasks
      window.currentFilters = {
        assignment: assignmentFilter,
        priorities: priorities
      };
      
      renderTasks();
    }

    // Update progress by clicking on progress bar
    async function updateProgress(event, taskId) {
      const progressBar = event.currentTarget;
      const rect = progressBar.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const newProgress = Math.round((clickX / rect.width) * 100);
      const clampedProgress = Math.max(0, Math.min(100, newProgress));
      
      // Update task progress
      if (window.electronAPI && window.electronAPI.tasks) {
        try {
          // Determine new status based on progress
          let newStatus = 'todo';
          if (clampedProgress === 100) {
            newStatus = 'completed';
          } else if (clampedProgress > 0) {
            newStatus = 'in_progress';
          }
          
          const result = await window.electronAPI.tasks.update({
            taskId: taskId,
            updates: { 
              progress: clampedProgress,
              status: newStatus
            }
          });
          
          if (result.success) {
            await loadTasks();
          }
        } catch (error) {
          console.error('Error updating progress:', error);
        }
      }
    }

    async function renderTasks() {
      console.log('ðŸ“‹ renderTasks called with', tasks.length, 'tasks');
      const tasksList = document.getElementById('tasksList');
      
      if (tasks.length === 0) {
        tasksList.innerHTML = `
          <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: #a3a3a3; margin-bottom: 16px;">
              <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"></path>
              <rect x="9" y="3" width="6" height="4" rx="1"></rect>
            </svg>
            <div>No tasks yet. Add one above to get started!</div>
          </div>
        `;
        return;
      }
      
      console.log('ðŸ”„ Resolving user names and mentions for tasks...');
      // Resolve all user names and mentions first (with timeout protection)
      const tasksWithNames = await Promise.all(tasks.map(async (task, index) => {
        console.log(`ðŸ“ Task ${index + 1}:`, {
          title: task.title,
          assignor: task.assignor,
          assignee: task.assignee
        });
        
        try {
          // Add timeout to prevent blocking
          const assignorName = task.assignor ? await Promise.race([
            getSlackUserName(task.assignor),
            new Promise(resolve => setTimeout(() => resolve(null), 1000))
          ]) : null;
          
          const assigneeName = task.assignee ? await Promise.race([
            getSlackUserName(task.assignee),
            new Promise(resolve => setTimeout(() => resolve(null), 1000))
          ]) : null;
          
          // Resolve mentions in title and description
          const resolvedTitle = await Promise.race([
            resolveSlackMentions(task.title),
            new Promise(resolve => setTimeout(() => resolve(task.title), 1000))
          ]);
          
          const resolvedDescription = await Promise.race([
            resolveSlackMentions(task.description || ''),
            new Promise(resolve => setTimeout(() => resolve(task.description || ''), 1000))
          ]);
          
          console.log(`âœ… Task ${index + 1} names resolved:`, {
            assignorName,
            assigneeName,
            resolvedTitle
          });
          
          return {
            ...task,
            title: resolvedTitle,
            description: resolvedDescription,
            assignorName,
            assigneeName
          };
        } catch (error) {
          console.error(`âŒ Error resolving task ${index + 1}:`, error);
          // Return task as-is if resolution fails
          return {
            ...task,
            assignorName: null,
            assigneeName: null
          };
        }
      }));
      
      console.log('âœ… All names resolved, rendering', tasksWithNames.length, 'tasks');
      console.log('ðŸ“Š Tasks to render:', tasksWithNames);
      
      // Apply filters
      let filteredTasks = tasksWithNames;
      const filters = window.currentFilters || { assignment: 'all', priorities: ['all'] };
      
      // Filter by assignment
      if (filters.assignment !== 'all') {
        const currentUserId = window.currentUser?.id;
        if (filters.assignment === 'assigned_to_me') {
          filteredTasks = filteredTasks.filter(t => t.assignee === currentUserId);
        } else if (filters.assignment === 'assigned_by_me') {
          filteredTasks = filteredTasks.filter(t => t.assignor === currentUserId);
        }
      }
      
      // Filter by priority
      if (!filters.priorities.includes('all')) {
        filteredTasks = filteredTasks.filter(t => 
          filters.priorities.includes(t.priority || 'medium')
        );
      }
      
      console.log('ðŸ” Filtered tasks:', filteredTasks.length, 'of', tasksWithNames.length);
      
      // Get the container
      if (!tasksList) {
        console.error('âŒ tasksList element not found!');
        return;
      }
      
      // Switch between view modes
      if (taskViewMode === 'action') {
        renderTasksAsActionItems(filteredTasks);
        return;
      }
      
      console.log('ðŸ“ Generating HTML for tasks...');
      tasksList.innerHTML = tasksWithNames.map((task, idx) => {
        console.log(`  Rendering task ${idx + 1}:`, task.title);
        
        // Check if this is a JIRA task
        const isJiraTask = task.externalSource === 'jira' || (task.tags && task.tags.includes('jira-auto'));
        const jiraKey = task.externalKey || '';
        const jiraUrl = task.externalUrl || '';
        
        return `
          <div class="task-item ${task.status === 'completed' ? 'completed' : ''}">
            <div class="task-header">
              <div class="task-checkbox ${task.status === 'completed' ? 'checked' : ''}" 
                   onclick="toggleTask('${task.id}', '${task.status}')"></div>
              <div class="task-title">
                ${escapeHtml(task.title)}
                ${isJiraTask && jiraKey ? `
                  <a href="${jiraUrl}" target="_blank" style="margin-left: 8px; font-size: 11px; color: #0052CC; text-decoration: none; background: #E9F2FF; padding: 2px 6px; border-radius: 3px; font-weight: 600;" title="View in JIRA">
                    ${jiraKey}
                  </a>
                ` : ''}
              </div>
              <div class="task-priority ${task.priority}">${task.priority}</div>
              <div class="task-actions">
                <button class="task-action-btn chat" onclick="openTaskChat('${task.id}')" title="AI Chat">ðŸ’¬</button>
                <button class="task-action-btn delete" onclick="deleteTask('${task.id}')">ðŸ—‘ï¸</button>
              </div>
            </div>
            ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
            <div class="task-meta">
              ${isJiraTask ? `<span style="color: #0052CC; font-weight: 600;">ðŸ”— JIRA</span>` : ''}
              ${task.assignorName ? `<span class="task-assignor">ðŸ‘¤ From: ${escapeHtml(task.assignorName)}</span>` : ''}
              ${task.assigneeName ? `<span class="task-assignee">ðŸ‘‰ To: ${escapeHtml(task.assigneeName)}</span>` : ''}
              <span class="task-date">Created ${formatDate(task.created_at)}</span>
            </div>
          </div>
        `;
      }).join('');
      
      console.log('âœ… HTML rendered successfully, tasksList updated');
      console.log('ðŸ“Š Final HTML length:', tasksList.innerHTML.length);
    }

    // Switch between task view modes
    function switchTaskView(mode) {
      taskViewMode = mode;
      
      // Update button states
      const actionBtn = document.getElementById('actionViewBtn');
      const listBtn = document.getElementById('listViewBtn');
      
      if (actionBtn && listBtn) {
        if (mode === 'action') {
          actionBtn.classList.add('active');
          listBtn.classList.remove('active');
        } else {
          listBtn.classList.add('active');
          actionBtn.classList.remove('active');
        }
      }
      
      // Re-render tasks with new view
      renderTasks();
    }

    // Render tasks as action items
    function renderTasksAsActionItems(tasksWithNames) {
      const tasksList = document.getElementById('tasksList');
      
      if (!tasksList) {
        console.error('âŒ tasksList element not found!');
        return;
      }
      
      if (tasksWithNames.length === 0) {
        tasksList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âœ¨</div>
            <div>No action items yet. Add one above to get started!</div>
          </div>
        `;
        return;
      }
      
      tasksList.innerHTML = tasksWithNames.map((task, index) => {
        // Calculate progress based on status
        const progress = task.status === 'completed' ? 100 : 
                        task.status === 'in_progress' ? (task.progress || 83) : 
                        0;
        
        // Get app icon based on source
        const getAppIcon = () => {
          const isSlack = task.source === 'slack' || (task.tags && task.tags.includes('slack-auto'));
          
          if (isSlack) {
            return '<img src="/Users/jarvis/Code/HeyJarvis/desktop/public/Slack_icon_2019.svg.png" style="width: 24px; height: 24px; object-fit: contain;" alt="Slack">';
          }
          
          if (task.source) {
            const icons = {
              'teams': 'ðŸŽ¯',
              'email': 'ðŸ“§',
              'jira': 'ðŸ“‹',
              'github': 'ðŸ”§',
              'calendar': 'ðŸ“…',
              'crm': 'ðŸ’¼',
              'manual': 'âœï¸'
            };
            return icons[task.source] || 'âœ“';
          }
          if (task.tags && task.tags.includes('teams-auto')) return 'ðŸŽ¯';
          if (task.tags && task.tags.includes('email-auto')) return 'ðŸ“§';
          if (task.tags && task.tags.includes('jira-auto')) return 'ðŸ“‹';
          return 'âœ“';
        };
        
        // Get icon background gradient
        const getIconBg = () => {
          if (!task.source) return 'linear-gradient(135deg, rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.04))';
          const gradients = {
            'slack': 'linear-gradient(135deg, rgba(74, 21, 75, 0.3), rgba(224, 30, 90, 0.3))',
            'teams': 'linear-gradient(135deg, rgba(99, 91, 229, 0.3), rgba(67, 56, 202, 0.3))',
            'email': 'linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.3))',
            'jira': 'linear-gradient(135deg, rgba(0, 82, 204, 0.3), rgba(0, 101, 255, 0.3))',
            'crm': 'linear-gradient(135deg, rgba(251, 146, 60, 0.3), rgba(249, 115, 22, 0.3))',
            'manual': 'linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(147, 51, 234, 0.3))'
          };
          return gradients[task.source] || 'linear-gradient(135deg, rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.04))';
        };
        
        const priorityLabel = (task.priority || 'medium').charAt(0).toUpperCase() + (task.priority || 'medium').slice(1);
        const notificationCount = task.relatedCount || 0;
        
        // Check if title has proper capitalization (has uppercase letters beyond first word)
        const hasProperCase = (title) => {
          const words = title.split(' ');
          return words.some((word, idx) => idx > 0 && /[A-Z]/.test(word));
        };
        
        const titleClass = hasProperCase(task.title) ? 'action-title proper-case' : 'action-title';
        
        // Format date
        const formatDate = (dateStr) => {
          if (!dateStr) return 'No date';
          const date = new Date(dateStr);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          
          if (diffMins < 60) return `${diffMins}m ago`;
          if (diffHours < 24) return `${diffHours}h ago`;
          if (diffDays < 7) return `${diffDays}d ago`;
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };
        
        // Get assignor/assignee info
        const assignedBy = task.assignorName || (task.assignor_id ? 'Someone' : '');
        const assignedTo = task.assigneeName || 'You';
        
        return `
          <div class="action-item ${task.status === 'completed' ? 'completed' : ''} priority-${task.priority || 'medium'}" onclick="openTaskChat('${task.id}')">
            <!-- Number badge outside card -->
            <div class="action-item-number">${index + 1}</div>
            
            <!-- Priority badge at top right -->
            <div class="action-priority-badge priority-${task.priority || 'medium'}">${priorityLabel}</div>
            
            <!-- Header with icon and holographic task box -->
            <div class="action-item-header">
              <div class="action-app-icon" style="background: ${getIconBg()}">
                ${getAppIcon()}
              </div>
              
              <div class="action-task-box">
                <div class="action-task-content">
                  <div class="${titleClass}">${escapeHtml(task.title)}</div>
                  <div class="action-meta-row">
                    ${assignedBy ? `<span class="meta-item">From: ${assignedBy}</span>` : ''}
                    <span class="meta-item">${formatDate(task.created_at)}</span>
                    ${notificationCount > 0 ? `<span class="meta-item meta-highlight"><span class="meta-icon">ðŸ’¬</span>+${notificationCount}</span>` : ''}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Status and progress section -->
            <div class="action-footer">
              <div class="action-status-badge status-${task.status || 'todo'}">
                ${task.status === 'completed' ? 'âœ“ Done' : task.status === 'in_progress' ? 'âš¡ In Progress' : 'â—‹ To Do'}
              </div>
              <div class="action-progress-mini">
                <div class="action-progress-bar" onclick="event.stopPropagation(); updateProgress(event, '${task.id}')">
                  <div class="action-progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="action-progress-text">${progress}%</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function toggleTask(taskId, currentStatus) {
      if (!window.electronAPI || !window.electronAPI.tasks) {
        console.warn('Task API not available');
        return;
      }
      
      try {
        const result = await window.electronAPI.tasks.toggle(taskId, currentStatus);
        if (result.success) await loadTasks();
      } catch (error) {
        console.error('Error toggling task:', error);
      }
    }

    async function deleteTask(taskId) {
      if (!confirm('Delete this task?')) return;
      
      if (!window.electronAPI || !window.electronAPI.tasks) {
        console.warn('Task API not available');
        return;
      }
      
      try {
        const result = await window.electronAPI.tasks.delete(taskId);
        if (result.success) await loadTasks();
      } catch (error) {
        console.error('Error deleting task:', error);
      }
    }

    function updateStats() {
      const todoCount = tasks.filter(t => t.status === 'todo').length;
      const inProgressCount = tasks.filter(t => t.status === 'in_progress').length;
      const completedCount = tasks.filter(t => t.status === 'completed').length;
      
      const todoCountEl = document.getElementById('todoCount');
      if (todoCountEl) {
        todoCountEl.textContent = todoCount;
      }
      
      const inProgressCountEl = document.getElementById('inProgressCount');
      if (inProgressCountEl) {
        inProgressCountEl.textContent = inProgressCount;
      }
      const completedCountEl = document.getElementById('completedCount');
      if (completedCountEl) {
        completedCountEl.textContent = completedCount;
      }
      
      const badge = document.getElementById('taskBadge');
      if (badge) {
        const activeCount = todoCount + inProgressCount;
        if (activeCount > 0) {
          badge.textContent = activeCount;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // Chat functionality
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      await processChatMessage(message);
      messageInput.value = '';
      messageInput.style.height = 'auto';
    }

    async function sendHeaderMessage() {
      const inputElement = document.getElementById('headerInput');
      if (!inputElement) {
        console.error('âŒ Header input element not found');
        return;
      }
      
      const message = inputElement.value.trim();
      if (!message) {
        console.log('ðŸ“­ No message to send');
        return;
      }

      console.log('ðŸ“¤ Sending message:', message);
      
      // Expand when user sends a message
      if (!isExpanded) {
        console.log('ðŸ” Expanding top bar...');
        expandTopBar();
      }
      
      // Switch to chat tab
      switchTab('chat');

      await processChatMessage(message);
      inputElement.value = '';
      
      // Remove has-text class from send button
      const sendBtn = document.getElementById('headerSendBtn');
      if (sendBtn) {
        sendBtn.classList.remove('has-text');
      }
    }

    async function processChatMessage(message) {
      addMessage(message, 'user');
      showTypingIndicator();

      try {
        let response;
        if (window.electronAPI) {
          response = await window.electronAPI.sendMessage(message);
        } else {
          response = {
            content: 'I\'m here to help! What would you like to know?',
            timestamp: new Date().toISOString()
          };
        }

        hideTypingIndicator();
        addMessage(response.content, 'assistant');
      } catch (error) {
        console.error('Error sending message:', error);
        hideTypingIndicator();
        addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
      }
    }

    function sendQuickMessage(message) {
      if (isExpanded && messageInput) {
        messageInput.value = message;
        sendMessage();
      } else if (headerChatInput) {
        headerChatInput.value = message;
        sendHeaderMessage();
      }
    }

    function addMessage(content, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const avatar = sender === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
          ${content}
          <div style="font-size: 11px; color: rgba(255, 255, 255, 0.4); margin-top: 4px;">${time}</div>
        </div>
      `;
      
      const welcomeMessage = chatContainer.querySelector('.welcome-message');
      if (welcomeMessage) welcomeMessage.remove();
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      chatHistory.push({ content, sender, timestamp: new Date().toISOString() });
    }

    function showTypingIndicator() {
      typingIndicator.style.display = 'flex';
    }

    function hideTypingIndicator() {
      typingIndicator.style.display = 'none';
    }

    // Window controls
    function collapseTopBar() {
      isExpanded = false;
      document.body.classList.remove('expanded');
      document.body.classList.add('collapsed');
      
      if (window.electronAPI?.collapseTopBar) {
        window.electronAPI.collapseTopBar();
      }
    }

    function expandTopBar() {
      console.log('ðŸ” expandTopBar() called, isExpanded:', isExpanded);
      isExpanded = true;
      document.body.classList.remove('collapsed');
      document.body.classList.add('expanded');
      console.log('âœ… Body classes updated:', document.body.classList.toString());
      
      // Use the correct topbar expand API
      if (window.electronAPI?.topbar?.expand) {
        console.log('ðŸ“¡ Calling electron topbar.expand() API...');
        window.electronAPI.topbar.expand();
      } else if (window.electronAPI?.expandTopBar) {
        console.log('ðŸ“¡ Calling electron expandTopBar() API (fallback)...');
        window.electronAPI.expandTopBar();
      } else {
        console.warn('âš ï¸ electron expandTopBar API not available');
      }
    }

    function closeWindow() {
      if (window.electronAPI) {
        window.electronAPI.closeWindow();
      } else {
        window.close();
      }
    }


    function startFactCheck() {
      if (window.electronAPI?.startFactCheck) {
        window.electronAPI.startFactCheck();
      } else {
        console.log('Fact check initiated - screen capture will start');
        // Placeholder for fact check functionality
      }
    }

    // User dropdown functions
    function toggleUserDropdown() {
      console.log('ðŸ”½ Toggle dropdown clicked');
      const dropdown = document.getElementById('userDropdown');
      console.log('ðŸ”½ Dropdown element:', dropdown);
      if (dropdown) {
        dropdown.classList.toggle('show');
        console.log('ðŸ”½ Dropdown classes:', dropdown.className);
      } else {
        console.error('âŒ Dropdown element not found!');
      }
    }

    // Close dropdown if clicking outside
    window.addEventListener('click', function(event) {
      if (!event.target.matches('#appTitle')) {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown && dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
        }
      }
    });

    async function handleLogout() {
      try {
        console.log('ðŸšª Logging out...');
        
        // Close dropdown
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.remove('show');
        
        // Call logout API
        if (window.electronAPI?.auth?.signOut) {
          await window.electronAPI.auth.signOut();
          console.log('âœ… Logged out successfully');
        } else {
          console.error('âŒ Logout API not available');
        }
      } catch (error) {
        console.error('âŒ Logout failed:', error);
      }
    }

    // Services initialization
    async function initializeServices() {
      if (servicesInitialized) return;
      servicesInitialized = true;
      
      if (!window.electronAPI) return;
      
      try {
        if (window.electronAPI.slack?.startMonitoring) {
          const result = await window.electronAPI.slack.startMonitoring();
          if (result.success) {
            slackConnected = true;
            document.getElementById('slackStatusDot').classList.add('online');
          }
        }
        
        if (window.electronAPI.getCRMData) {
          const response = await window.electronAPI.getCRMData();
          if (response.success) {
            crmData = response.data;
            document.getElementById('crmStatusDot').classList.add('online');
          }
        }
      } catch (error) {
        console.error('Service initialization error:', error);
      }
    }

    // Fact checking
    async function startFactCheck() {
      addMessage('ðŸ” Starting fact check...', 'assistant');
      showTypingIndicator();
      
      try {
        if (window.electronAPI?.factCheck) {
          // Implement fact checking logic
        }
      } catch (error) {
        console.error('Fact check error:', error);
      } finally {
        hideTypingIndicator();
      }
    }

    // Helper functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      
      return date.toLocaleDateString();
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
    }

    // ===== TASK CHAT FUNCTIONS =====
    
    async function openTaskChat(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      
      currentTaskChat = task;
      
      // Update task card in chat header
      document.getElementById('taskChatName').textContent = task.title;
      document.getElementById('taskChatAssignor').textContent = task.assignorName || 'Someone';
      
      // Format date
      const formatChatDate = (dateStr) => {
        if (!dateStr) return 'Just now';
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };
      
      document.getElementById('taskChatDate').textContent = formatChatDate(task.created_at);
      
      // Update priority badge
      const priorityBadge = document.getElementById('taskChatPriority');
      const priority = task.priority || 'medium';
      priorityBadge.textContent = priority.charAt(0).toUpperCase() + priority.slice(1);
      priorityBadge.className = `task-chat-priority-badge priority-${priority}`;
      
      // Update app icon based on source
      const iconContainer = document.getElementById('taskChatIcon');
      const isSlack = task.source === 'slack' || (task.tags && task.tags.includes('slack-auto'));
      
      if (isSlack) {
        iconContainer.innerHTML = '<img src="/Users/jarvis/Code/HeyJarvis/desktop/public/Slack_icon_2019.svg.png" style="width: 24px; height: 24px; object-fit: contain;" alt="Slack">';
        iconContainer.style.background = 'linear-gradient(135deg, rgba(74, 21, 75, 0.3), rgba(224, 30, 90, 0.3))';
      } else {
        const icons = {
          'teams': 'ðŸŽ¯',
          'email': 'ðŸ“§',
          'jira': 'ðŸ“‹',
          'github': 'ðŸ”§',
          'calendar': 'ðŸ“…',
          'crm': 'ðŸ’¼',
          'manual': 'âœï¸'
        };
        iconContainer.textContent = task.source ? icons[task.source] || 'âœ“' : 'âœ“';
      }
      
      // Show live JIRA card if this is a JIRA task
      const isJiraTask = task.externalSource === 'jira' || (task.tags && task.tags.includes('jira-auto'));
      if (isJiraTask && task.externalKey) {
        await updateLiveJiraCard(task);
      } else {
        document.getElementById('liveJiraTaskCard').style.display = 'none';
      }
      
      // Load chat history from Supabase if not already in memory
      if (!taskChatHistories[taskId]) {
        const messagesContainer = document.getElementById('taskChatMessages');
        messagesContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
            <div style="font-size: 24px; margin-bottom: 10px;">ðŸ’¬</div>
            <div>Loading chat history...</div>
          </div>
        `;
        
        try {
          console.log('ðŸ“œ Loading chat history for task:', taskId);
          const result = await window.electronAPI.tasks.getChatHistory(taskId);
          
          if (result.success && result.messages.length > 0) {
            taskChatHistories[taskId] = result.messages;
            console.log(`âœ… Loaded ${result.messages.length} messages for task ${taskId}`);
          } else {
            taskChatHistories[taskId] = [];
            console.log('ðŸ“ No existing chat history, starting fresh');
          }
        } catch (error) {
          console.error('âŒ Failed to load task chat history:', error);
          taskChatHistories[taskId] = [];
        }
      }
      
      // Render the chat history
      renderTaskChatHistory(taskId);
      
      // ALWAYS use the fullscreen modal - NO separate window
      document.getElementById('taskChatModal').style.display = 'flex';
      
      // Start auto-refresh for JIRA cards
      if (isJiraTask && task.externalKey) {
        startJiraCardAutoRefresh(task);
      }
      
      // Focus input after a brief delay to allow animation
      setTimeout(() => {
        document.getElementById('taskChatInput').focus();
      }, 100);
    }
    
    function closeTaskChat() {
      // Stop auto-refresh
      stopJiraCardAutoRefresh();
      
      document.getElementById('taskChatModal').style.display = 'none';
      currentTaskChat = null;
    }
    
    function formatBotMessage(content) {
      // Clean markdown and emojis
      let cleaned = content
        // Remove markdown bold (**text** or __text__)
        .replace(/\*\*([^*]+)\*\*/g, '$1')
        .replace(/__([^_]+)__/g, '$1')
        // Remove markdown italic (*text* or _text_)
        .replace(/\*([^*]+)\*/g, '$1')
        .replace(/_([^_]+)_/g, '$1')
        // Remove emojis (most common ranges)
        .replace(/[\u{1F600}-\u{1F64F}]/gu, '') // Emoticons
        .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // Misc Symbols and Pictographs
        .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // Transport and Map
        .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // Flags
        .replace(/[\u{2600}-\u{26FF}]/gu, '')   // Misc symbols
        .replace(/[\u{2700}-\u{27BF}]/gu, '')   // Dingbats
        .replace(/[\u{FE00}-\u{FE0F}]/gu, '')   // Variation Selectors
        .replace(/[\u{1F900}-\u{1F9FF}]/gu, '') // Supplemental Symbols and Pictographs
        .replace(/[\u{1FA00}-\u{1FA6F}]/gu, '') // Chess Symbols
        .replace(/[\u{1FA70}-\u{1FAFF}]/gu, ''); // Symbols and Pictographs Extended-A
      
      // Split by different paragraph patterns
      const lines = cleaned.split('\n');
      const formatted = [];
      let currentParagraph = [];
      let inList = false;
      let listItems = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // Empty line - end current paragraph or list
        if (!line) {
          if (inList && listItems.length > 0) {
            formatted.push(`<ol>${listItems.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ol>`);
            listItems = [];
            inList = false;
          } else if (currentParagraph.length > 0) {
            formatted.push(`<p>${escapeHtml(currentParagraph.join(' '))}</p>`);
            currentParagraph = [];
          }
          continue;
        }
        
        // Numbered list item
        if (/^\d+\.\s/.test(line)) {
          // End current paragraph if any
          if (currentParagraph.length > 0) {
            formatted.push(`<p>${escapeHtml(currentParagraph.join(' '))}</p>`);
            currentParagraph = [];
          }
          inList = true;
          listItems.push(line.replace(/^\d+\.\s*/, ''));
          continue;
        }
        
        // Bullet list item
        if (/^[-â€¢]\s/.test(line)) {
          // End current paragraph if any
          if (currentParagraph.length > 0) {
            formatted.push(`<p>${escapeHtml(currentParagraph.join(' '))}</p>`);
            currentParagraph = [];
          }
          if (!inList) {
            inList = true;
            listItems = [];
          }
          listItems.push(line.replace(/^[-â€¢]\s*/, ''));
          continue;
        }
        
        // Regular line
        if (inList && listItems.length > 0) {
          // Check if this continues the list or starts a new paragraph
          if (!/^\d+\.\s/.test(line) && !/^[-â€¢]\s/.test(line)) {
            formatted.push(`<ol>${listItems.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ol>`);
            listItems = [];
            inList = false;
          }
        }
        
        currentParagraph.push(line);
      }
      
      // Handle remaining content
      if (inList && listItems.length > 0) {
        formatted.push(`<ol>${listItems.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ol>`);
      } else if (currentParagraph.length > 0) {
        formatted.push(`<p>${escapeHtml(currentParagraph.join(' '))}</p>`);
      }
      
      return formatted.join('');
    }
    
    function renderTaskChatHistory(taskId) {
      const messagesContainer = document.getElementById('taskChatMessages');
      const history = taskChatHistories[taskId] || [];
      
      if (history.length === 0) {
        messagesContainer.innerHTML = `
          <div class="task-chat-welcome">
            <div class="welcome-icon">ðŸŽ¯</div>
            <div class="welcome-text">Let's work on this task together!</div>
            <div class="welcome-subtitle">I can help you brainstorm, plan, and complete this task.</div>
          </div>
        `;
      } else {
        messagesContainer.innerHTML = history.map(msg => {
          const content = msg.role === 'assistant' 
            ? formatBotMessage(msg.content)
            : escapeHtml(msg.content);
          
          return `
            <div class="task-message ${msg.role}">
              <div class="task-message-bubble">${content}</div>
              <div class="task-message-time">${formatTime(msg.timestamp)}</div>
            </div>
          `;
        }).join('');
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }
    
    async function sendTaskChatMessage() {
      if (!currentTaskChat) return;
      
      const input = document.getElementById('taskChatInput');
      const message = input.value.trim();
      if (!message) return;
      
      const taskId = currentTaskChat.id;
      
      // Initialize chat history for this task if needed
      if (!taskChatHistories[taskId]) {
        taskChatHistories[taskId] = [];
      }
      
      // Add user message to history
      const userMessage = {
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
      };
      taskChatHistories[taskId].push(userMessage);
      
      // Clear input and update UI
      input.value = '';
      input.style.height = 'auto';
      renderTaskChatHistory(taskId);
      
      // Show typing indicator
      document.getElementById('taskChatTyping').style.display = 'flex';
      
      try {
        // Call backend API with task context
        if (!window.electronAPI || !window.electronAPI.copilot) {
          throw new Error('Electron API not available');
        }
        
        const response = await window.electronAPI.copilot.sendTaskMessage(taskId, message, {
          task: currentTaskChat,
          conversationHistory: taskChatHistories[taskId] || []
        });
        
        // Add AI response to history
        const assistantMessage = {
          role: 'assistant',
          content: response.content || response,
          timestamp: new Date().toISOString()
        };
        taskChatHistories[taskId].push(assistantMessage);
        
        // Update UI
        renderTaskChatHistory(taskId);
        
      } catch (error) {
        console.error('Task chat error:', error);
        
        // Add error message
        const errorMessage = {
          role: 'assistant',
          content: 'Sorry, I encountered an error. Please try again.',
          timestamp: new Date().toISOString()
        };
        taskChatHistories[taskId].push(errorMessage);
        renderTaskChatHistory(taskId);
      } finally {
        // Hide typing indicator
        document.getElementById('taskChatTyping').style.display = 'none';
      }
    }

    // Auto-resize textarea
    if (messageInput) {
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    if (headerInput) {
      const headerSendBtn = document.getElementById('headerSendBtn');
      
      // Show/hide send button based on input content
      headerInput.addEventListener('input', function() {
        if (this.value.trim() && headerSendBtn) {
          headerSendBtn.classList.add('has-text');
        } else if (headerSendBtn) {
          headerSendBtn.classList.remove('has-text');
        }
      });
      
      headerInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendHeaderMessage();
        }
      });
    }

    // Load user info and update UI
    async function loadUserInfo() {
      try {
        console.log('ðŸ” Checking for user info...');
        
        if (window.electronAPI && window.electronAPI.auth) {
          const user = await window.electronAPI.auth.getUser();
          console.log('ðŸ‘¤ User data received:', user);
          console.log('ðŸ†” Slack User ID:', user?.slack_user_id);
          console.log('ðŸ“§ Email:', user?.email);
          console.log('ðŸ‘¤ Name:', user?.name);
          
          if (user) {
            // Update the title to show "Hey [Name] (Slack ID)"
            const appTitle = document.getElementById('appTitle');
            if (appTitle) {
              // Try different name sources
              let displayName = user.name || user.email?.split('@')[0] || 'Jarvis';
              
              // If it's an email, extract the part before @
              if (displayName.includes('@')) {
                displayName = displayName.split('@')[0];
              }
              
              // Get first name only if it has spaces
              const firstName = displayName.split(' ')[0];
              
              // Capitalize first letter
              const capitalizedName = firstName.charAt(0).toUpperCase() + firstName.slice(1);
              
              // Add Slack ID for debugging
              const slackId = user.slack_user_id || 'NO_SLACK_ID';
              appTitle.textContent = `Hey ${capitalizedName} (${slackId})`;
              console.log('âœ… Title updated to: Hey', capitalizedName, `(${slackId})`);
            }
          } else {
            console.warn('âš ï¸ No user data found');
          }
        } else {
          console.warn('âš ï¸ electronAPI.auth not available');
        }
      } catch (error) {
        console.error('âŒ Failed to load user info:', error);
        // Keep default "HeyJarvis" title on error
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('ðŸš€ HeyJarvis loaded');
      
      // Load user info and update title
      await loadUserInfo();
      
      initializeServices();
      
      // Set initial active nav button
      const chatNavBtn = document.getElementById('chatNavBtn');
      if (chatNavBtn) chatNavBtn.classList.add('active');
      
      // Setup task chat input handlers
      const taskChatInput = document.getElementById('taskChatInput');
      if (taskChatInput) {
        taskChatInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        taskChatInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendTaskChatMessage();
          }
        });
      }
      
      // Close task chat modal on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && currentTaskChat) {
          closeTaskChat();
        }
      });
    });


    // ===== MICROSOFT 365 AUTHENTICATION =====
    let microsoftConnected = false;
    let microsoftUser = null;

    async function toggleMicrosoftAuth() {
      if (microsoftConnected) {
        const confirmed = confirm(`Disconnect from Microsoft 365 (${microsoftUser})?`);
        if (confirmed) {
          microsoftConnected = false;
          microsoftUser = null;
          updateMicrosoftButton();
        }
      } else {
        document.getElementById('msAuthModal').classList.add('show');
      }
    }

    function closeMicrosoftModal() {
      document.getElementById('msAuthModal').classList.remove('show');
    }

    async function authenticateMicrosoft() {
      try {
        console.log('ðŸ” Starting Microsoft authentication...');
        const modal = document.getElementById('msAuthModal');
        const content = modal.querySelector('.ms-auth-content');
        content.innerHTML = `
          <h3>Authenticating...</h3>
          <p style="text-align: center;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: msSpinAnimation 1s linear infinite;">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 6v6l4 2"></path>
            </svg>
          </p>
          <p>Opening your browser for authentication...</p>
        `;
        
        const result = await window.electronAPI.microsoft.authenticate();
        
        if (result.success) {
          console.log('âœ… Microsoft authenticated:', result.account);
          microsoftConnected = true;
          microsoftUser = result.account.username;
          updateMicrosoftButton();
          
          content.innerHTML = `
            <h3>âœ… Connected!</h3>
            <p>Successfully connected to Microsoft 365 as <strong>${result.account.username}</strong></p>
            <div class="ms-auth-actions">
              <button class="ms-auth-primary" onclick="closeMicrosoftModal()" style="width: 100%;">Done</button>
            </div>
          `;
          
          setTimeout(() => closeMicrosoftModal(), 2000);
        } else {
          throw new Error(result.error || 'Authentication failed');
        }
      } catch (error) {
        console.error('âŒ Microsoft authentication failed:', error);
        const content = document.querySelector('.ms-auth-content');
        content.innerHTML = `
          <h3>âŒ Authentication Failed</h3>
          <p style="color: #ef4444;">${error.message}</p>
          <div class="ms-auth-actions">
            <button class="ms-auth-secondary" onclick="closeMicrosoftModal()">Close</button>
            <button class="ms-auth-primary" onclick="authenticateMicrosoft()">Try Again</button>
          </div>
        `;
      }
    }

    function updateMicrosoftButton() {
      const btn = document.getElementById('msAuthBtn');
      if (microsoftConnected) {
        btn.classList.add('connected');
        btn.title = `Microsoft 365 Connected (${microsoftUser}) - Click to disconnect`;
      } else {
        btn.classList.remove('connected');
        btn.title = 'Connect Microsoft 365';
      }
    }

    // ===== GOOGLE WORKSPACE AUTHENTICATION =====
    let googleConnected = false;
    let googleUser = null;

    async function toggleGoogleAuth() {
      console.log('ðŸ”˜ Google button clicked, googleConnected:', googleConnected);
      if (googleConnected) {
        const confirmed = confirm(`Disconnect from Google Workspace (${googleUser})?`);
        if (confirmed) {
          googleConnected = false;
          googleUser = null;
          updateGoogleButton();
        }
      } else {
        console.log('ðŸ“‚ Opening Google auth modal');
        document.getElementById('googleAuthModal').classList.add('show');
      }
    }

    function closeGoogleModal() {
      document.getElementById('googleAuthModal').classList.remove('show');
    }

    async function authenticateGoogle() {
      try {
        console.log('ðŸ” Starting Google authentication...');
        const modal = document.getElementById('googleAuthModal');
        const content = modal.querySelector('.ms-auth-content');
        content.innerHTML = `
          <h3>Authenticating...</h3>
          <p style="text-align: center;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: msSpinAnimation 1s linear infinite;">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 6v6l4 2"></path>
            </svg>
          </p>
          <p>Opening your browser for authentication...</p>
        `;
        
        const result = await window.electronAPI.google.authenticate();
        
        if (result.success) {
          console.log('âœ… Google authenticated:', result.account);
          googleConnected = true;
          googleUser = result.account.email;
          updateGoogleButton();
          
          content.innerHTML = `
            <h3>âœ… Connected!</h3>
            <p>Successfully connected to Google Workspace as <strong>${result.account.email}</strong></p>
            <div class="ms-auth-actions">
              <button class="ms-auth-primary" onclick="closeGoogleModal()" style="width: 100%;">Done</button>
            </div>
          `;
          
          setTimeout(() => closeGoogleModal(), 2000);
        } else {
          throw new Error(result.error || 'Authentication failed');
        }
      } catch (error) {
        console.error('âŒ Google authentication failed:', error);
        const content = document.querySelector('#googleAuthModal .ms-auth-content');
        content.innerHTML = `
          <h3>âŒ Authentication Failed</h3>
          <p style="color: #ef4444;">${error.message}</p>
          <div class="ms-auth-actions">
            <button class="ms-auth-secondary" onclick="closeGoogleModal()">Close</button>
            <button class="ms-auth-primary" onclick="authenticateGoogle()">Try Again</button>
          </div>
        `;
      }
    }

    function updateGoogleButton() {
      const btn = document.getElementById('googleAuthBtn');
      if (googleConnected) {
        btn.classList.add('connected');
        btn.title = `Google Workspace Connected (${googleUser}) - Click to disconnect`;
      } else {
        btn.classList.remove('connected');
        btn.title = 'Connect Google Workspace';
      }
    }

    async function checkMicrosoftConnection() {
      try {
        if (window.electronAPI?.microsoft?.getUserProfile) {
          const result = await window.electronAPI.microsoft.getUserProfile();
          if (result.success) {
            microsoftConnected = true;
            microsoftUser = result.user.mail || result.user.userPrincipalName;
            updateMicrosoftButton();
            console.log('âœ… Microsoft 365 already connected:', microsoftUser);
          }
        }
      } catch (error) {
        console.log('â„¹ï¸ Microsoft 365 not connected');
      }
    }

    setTimeout(checkMicrosoftConnection, 1000);

    // ===== GITHUB CONNECTION STATUS =====
    let githubConnected = false;
    let githubInfo = null;

    async function toggleGitHubConnection() {
      if (githubConnected) {
        const infoText = `GitHub is Connected âœ“

Configuration:
â€¢ Auth Type: ${githubInfo?.authType || 'N/A'}
â€¢ App ID: ${githubInfo?.appId || 'N/A'}
â€¢ Repositories: ${githubInfo?.repoCount || 0} accessible

This is read-only access. Engineering queries are enabled.

To reconfigure, update your .env file and restart the app.`;
        
        alert(infoText);
      } else {
        const setupText = `GitHub Not Connected

To enable engineering intelligence queries:

1. Create a GitHub App
   Visit: https://github.com/settings/apps

2. Add to your .env file:
   GITHUB_APP_ID=your_app_id
   GITHUB_APP_INSTALLATION_ID=your_installation_id
   GITHUB_APP_PRIVATE_KEY_PATH=/path/to/private-key.pem

3. Restart the app

See GITHUB_APP_AUTH_SETUP.md for detailed instructions.`;
        
        alert(setupText);
      }
    }

    function updateGitHubButton() {
      const btn = document.getElementById('githubAuthBtn');
      if (githubConnected) {
        btn.classList.add('connected');
        btn.title = `GitHub Connected (${githubInfo?.repoCount || 0} repos) - Click for info`;
      } else {
        btn.classList.remove('connected');
        btn.title = 'GitHub Not Connected - Click for setup instructions';
      }
    }

    async function checkGitHubConnection() {
      console.log('ðŸ” checkGitHubConnection called');
      console.log('ðŸ” window.electronAPI exists?', !!window.electronAPI);
      console.log('ðŸ” window.electronAPI.engineering exists?', !!window.electronAPI?.engineering);
      console.log('ðŸ” window.electronAPI.engineering.healthCheck exists?', !!window.electronAPI?.engineering?.healthCheck);
      
      try {
        if (window.electronAPI?.engineering?.healthCheck) {
          const result = await window.electronAPI.engineering.healthCheck();
          
          console.log('ðŸ” GitHub health check FULL result:', JSON.stringify(result, null, 2));
          console.log('ðŸ” result.status:', result.status);
          console.log('ðŸ” result.github:', result.github);
          console.log('ðŸ” result.authType:', result.authType);
          console.log('ðŸ” result.appId:', result.appId);
          console.log('ðŸ” result.repoCount:', result.repoCount);
          
          // FIXED: Remove 'result.configured' check - health check doesn't return this
          if (result.status === 'healthy' && result.github === 'connected') {
            githubConnected = true;
            githubInfo = {
              appId: result.appId,
              repoCount: result.repoCount || 0,
              authType: result.authType || 'github-app'
            };
            updateGitHubButton();
            console.log('âœ… GitHub connected:', githubInfo);
          } else {
            githubConnected = false;
            updateGitHubButton();
            console.log('â„¹ï¸ GitHub not connected - status:', result.status, 'github:', result.github);
          }
        } else {
          githubConnected = false;
          updateGitHubButton();
          console.log('â„¹ï¸ GitHub engineering API not available');
        }
      } catch (error) {
        console.error('âš ï¸ GitHub connection check failed:', error);
        console.error('âš ï¸ Error details:', error.stack);
        githubConnected = false;
        updateGitHubButton();
      }
    }

    // Check GitHub connection on startup
    setTimeout(checkGitHubConnection, 1000);

    // Re-check every 30 seconds
    setInterval(checkGitHubConnection, 30000);

    // Check JIRA connection on startup
    setTimeout(checkJIRAConnection, 1500);

    // Re-check JIRA connection every 60 seconds
    setInterval(checkJIRAConnection, 60000);

    // ===== ROLE-BASED UI =====
    let userRole = null;

    async function initializeRoleBasedUI() {
      try {
        // Get current user
        const user = await window.electronAPI.auth.getUser();
        
        if (!user) {
          console.log('â„¹ï¸  No user detected');
          return;
        }

        // Use effective role (supports dev mode override)
        userRole = user.effectiveRole || user.user_role;
        
        // Log role info
        if (user.roleOverride) {
          console.log('ðŸ”§ DEVELOPMENT MODE: Role override active');
          console.log(`ðŸ‘¤ Database role: ${user.user_role}`);
          console.log(`ðŸŽ­ Overridden to: ${user.roleOverride}`);
          console.log(`âœ… Effective role: ${userRole}`);
        } else {
          console.log('ðŸ‘¤ User role:', userRole);
        }

        // For developer users (or admin with both)
        if (userRole === 'developer' || userRole === 'admin') {
          console.log('ðŸ”§ Configuring for developer role');
          
          // Show dev-specific features
          showDeveloperFeatures();
        }
        
        if (userRole === 'sales' || userRole === 'admin') {
          console.log('ðŸ“Š Configuring for sales role');
          
          // Sales features are enabled by default
          // Admin gets both developer AND sales features
        }
        
        // Load tasks for all roles
        console.log('ðŸ“‹ Loading tasks...');
        await loadTasks();

      } catch (error) {
        console.error('âŒ Failed to initialize role-based UI:', error);
      }
    }

    function showDeveloperFeatures() {
      // Show Code Indexer tab for developers
      const indexerNavBtn = document.getElementById('indexerNavBtn');
      if (indexerNavBtn) {
        indexerNavBtn.style.display = 'block';
        console.log('âœ¨ Code Indexer tab enabled for developer');
      }
      
      // Show JIRA auth button for developers
      const jiraAuthBtn = document.getElementById('jiraAuthBtn');
      if (jiraAuthBtn) {
        jiraAuthBtn.style.display = 'flex';
        console.log('âœ¨ JIRA auth button enabled for developer');
        
        // Check JIRA connection status
        checkJIRAConnection();
      }
      
      // Disable manual task creation for devs (use JIRA instead)
      const taskInput = document.getElementById('taskInput');
      const addTaskBtn = document.querySelector('.add-task-btn');
      
      if (taskInput) {
        taskInput.disabled = true;
        taskInput.placeholder = 'Tasks are synced from JIRA...';
      }
      
      if (addTaskBtn) {
        addTaskBtn.disabled = true;
        addTaskBtn.style.opacity = '0.5';
      }
      
      console.log('âœ¨ Developer features enabled');
    }

    async function loadJIRATasks() {
      const tasksList = document.getElementById('tasksList');
      
      if (!tasksList) return;
      
      try {
        // Check if JIRA is connected
        const connectionStatus = await window.electronAPI.jira.checkConnection();
        
        if (!connectionStatus.connected) {
          // Show connect prompt
          tasksList.innerHTML = `
            <div class="empty-state" style="padding: 60px 20px; text-align: center;">
              <div class="empty-icon" style="font-size: 64px; margin-bottom: 16px;">ðŸ”Œ</div>
              <div style="font-size: 18px; font-weight: 600; color: #171717; margin-bottom: 8px;">
                Connect JIRA to see your tasks
              </div>
              <div style="font-size: 14px; color: #737373; max-width: 400px; margin: 0 auto; margin-bottom: 20px;">
                Click the JIRA button in the top right to authenticate and sync your tasks.
              </div>
              <button onclick="handleJIRAButtonClick()" style="padding: 12px 24px; background: #0052CC; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Connect JIRA
              </button>
            </div>
          `;
          return;
        }
        
        // Load JIRA issues
        console.log('ðŸ“‹ Loading JIRA tasks...');
        tasksList.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #737373;">
            Loading your JIRA tasks...
          </div>
        `;
        
        const result = await window.electronAPI.jira.getMyIssues({ maxResults: 50 });
        
        if (!result.success) {
          throw new Error(result.error);
        }
        
        const issues = result.issues || [];
        
        if (issues.length === 0) {
          tasksList.innerHTML = `
            <div class="empty-state" style="padding: 60px 20px; text-align: center;">
              <div class="empty-icon" style="font-size: 64px; margin-bottom: 16px;">âœ…</div>
              <div style="font-size: 18px; font-weight: 600; color: #171717; margin-bottom: 8px;">
                No tasks assigned to you
              </div>
              <div style="font-size: 14px; color: #737373;">
                All caught up! Create new tasks in JIRA.
              </div>
            </div>
          `;
          return;
        }
        
        // Display issues as tasks with editing capabilities
        tasksList.innerHTML = issues.map(issue => {
          const priorityColors = {
            Highest: '#FF3B30',
            High: '#FF9500',
            Medium: '#FFCC00',
            Low: '#34C759',
            Lowest: '#007AFF'
          };
          const priorityColor = priorityColors[issue.priority?.name] || '#737373';
          
          const statusColors = {
            'To Do': '#737373',
            'In Progress': '#007AFF',
            'Done': '#34C759',
            'Backlog': '#8E8E93',
            'In Review': '#FF9500'
          };
          const statusColor = statusColors[issue.status?.name] || '#737373';
          
          return `
            <div class="task-item jira-issue" 
                 data-issue-id="${issue.id}" 
                 data-issue-key="${issue.key}"
                 style="padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;"
                 onmouseenter="this.style.borderColor='#007AFF'; this.style.boxShadow='0 2px 8px rgba(0,122,255,0.1)'"
                 onmouseleave="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                 onclick="openJIRAIssueEditor('${issue.key}', ${JSON.stringify(issue).replace(/"/g, '&quot;')})">
              <div style="display: flex; align-items: start; gap: 12px;">
                <div style="margin-top: 2px; color: ${statusColor}; font-size: 16px;">
                  ${issue.status?.name === 'Done' ? 'âœ“' : 'â—‹'}
                </div>
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                    <div style="font-size: 14px; font-weight: 600; color: #171717;">
                      ${issue.summary}
                    </div>
                    <div style="display: flex; gap: 4px;">
                      <button onclick="event.stopPropagation(); quickTransitionIssue('${issue.key}', 'In Progress')" 
                              style="padding: 4px 8px; background: #007AFF; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;"
                              title="Start working">
                        Start
                      </button>
                      <button onclick="event.stopPropagation(); quickTransitionIssue('${issue.key}', 'Done')" 
                              style="padding: 4px 8px; background: #34C759; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;"
                              title="Mark as done">
                        Done
                      </button>
                      <button onclick="event.stopPropagation(); window.electronAPI.shell.openExternal('${issue.url}')" 
                              style="padding: 4px 8px; background: #f3f4f6; color: #737373; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;"
                              title="Open in JIRA">
                        ðŸ”—
                      </button>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #737373; flex-wrap: wrap;">
                    <span style="background: ${priorityColor}; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 600;">
                      ${issue.priority?.name || 'Medium'}
                    </span>
                    <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 600;">
                      ${issue.status?.name || 'To Do'}
                    </span>
                    <span>${issue.issue_type?.name || 'Task'}</span>
                    <span>â€¢</span>
                    <span style="font-family: monospace; font-weight: 600;">${issue.key}</span>
                    ${issue.assignee ? `
                      <span>â€¢</span>
                      <span title="${issue.assignee.display_name}">ðŸ‘¤ ${issue.assignee.display_name}</span>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        console.log(`âœ… Loaded ${issues.length} JIRA tasks`);
        
      } catch (error) {
        console.error('âŒ Failed to load JIRA tasks:', error);
        tasksList.innerHTML = `
          <div class="empty-state" style="padding: 60px 20px; text-align: center;">
            <div class="empty-icon" style="font-size: 64px; margin-bottom: 16px;">âš ï¸</div>
            <div style="font-size: 18px; font-weight: 600; color: #171717; margin-bottom: 8px;">
              Failed to load JIRA tasks
            </div>
            <div style="font-size: 14px; color: #737373; margin-bottom: 20px;">
              ${error.message}
            </div>
            <button onclick="loadTasks()" style="padding: 12px 24px; background: #171717; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              Retry
            </button>
          </div>
        `;
      }
      
      // Disable manual task creation for devs (use JIRA instead)
      const taskInput = document.getElementById('taskInput');
      const addTaskBtn = document.querySelector('.add-task-btn');
      
      if (taskInput) {
        taskInput.disabled = true;
        taskInput.placeholder = 'Tasks are synced from JIRA...';
      }
      
      if (addTaskBtn) {
        addTaskBtn.disabled = true;
        addTaskBtn.style.opacity = '0.5';
      }
    }
    
    // Handle JIRA button click
    async function handleJIRAButtonClick() {
      const btn = document.getElementById('jiraAuthBtn');
      
      // If already connected, sync and refresh tasks instead of re-authenticating
      if (btn && btn.classList.contains('connected')) {
        console.log('ðŸ”„ Syncing JIRA tasks...');
        await syncJIRATasks();
        return;
      }
      
      // Otherwise, authenticate
      authenticateJIRA();
    }
    
    // Quick transition JIRA issue status
    async function quickTransitionIssue(issueKey, targetStatus) {
      try {
        console.log(`ðŸ”„ Transitioning ${issueKey} to ${targetStatus}...`);
        
        showNotification(`Moving ${issueKey} to ${targetStatus}...`, 'info', 2000);
        
        const result = await window.electronAPI.jira.executeCommand({
          command: `transition ${issueKey} to ${targetStatus}`
        });
        
        if (result.success) {
          console.log(`âœ… ${issueKey} transitioned to ${targetStatus}`);
          showNotification(`âœ… ${issueKey} moved to ${targetStatus}`, 'success');
          
          // Refresh tasks to show updated status
          if (currentView === 'tasks') {
            await loadTasks();
          }
        } else {
          throw new Error(result.error || 'Failed to transition issue');
        }
      } catch (error) {
        console.error('âŒ Failed to transition issue:', error);
        showNotification(`Failed to transition: ${error.message}`, 'error');
      }
    }
    
    // Open JIRA issue editor modal
    function openJIRAIssueEditor(issueKey, issueData) {
      console.log('ðŸ“ Opening editor for', issueKey, issueData);
      
      const issue = typeof issueData === 'string' ? JSON.parse(issueData.replace(/&quot;/g, '"')) : issueData;
      
      // Create modal overlay
      const modal = document.createElement('div');
      modal.id = 'jiraEditorModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
      `;
      
      // Create modal content
      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: white; z-index: 1;">
            <div>
              <div style="font-size: 20px; font-weight: 700; color: #171717; margin-bottom: 4px;">
                ${issue.summary}
              </div>
              <div style="font-size: 14px; color: #737373;">
                <span style="font-family: monospace; font-weight: 600;">${issue.key}</span>
                â€¢ ${issue.issue_type?.name || 'Task'}
              </div>
            </div>
            <button onclick="closeJIRAEditorModal()" style="padding: 8px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-size: 20px; line-height: 1; color: #737373;">Ã—</button>
          </div>
          
          <div style="padding: 24px;">
            <!-- Status -->
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-size: 14px; font-weight: 600; color: #171717; margin-bottom: 8px;">Status</label>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${['To Do', 'In Progress', 'In Review', 'Done'].map(status => `
                  <button onclick="updateIssueStatus('${issue.key}', '${status}')" 
                          style="padding: 8px 16px; background: ${issue.status?.name === status ? '#007AFF' : '#f3f4f6'}; color: ${issue.status?.name === status ? 'white' : '#171717'}; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                    ${status}
                  </button>
                `).join('')}
              </div>
            </div>
            
            <!-- Priority -->
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-size: 14px; font-weight: 600; color: #171717; margin-bottom: 8px;">Priority</label>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                ${['Highest', 'High', 'Medium', 'Low', 'Lowest'].map(priority => {
                  const colors = { Highest: '#FF3B30', High: '#FF9500', Medium: '#FFCC00', Low: '#34C759', Lowest: '#007AFF' };
                  return `
                    <button onclick="updateIssuePriority('${issue.key}', '${priority}')" 
                            style="padding: 8px 16px; background: ${issue.priority?.name === priority ? colors[priority] : '#f3f4f6'}; color: ${issue.priority?.name === priority ? 'white' : '#171717'}; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                      ${priority}
                    </button>
                  `;
                }).join('')}
              </div>
            </div>
            
            <!-- Description -->
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-size: 14px; font-weight: 600; color: #171717; margin-bottom: 8px;">Description</label>
              <textarea id="jiraIssueDescription" 
                        style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; resize: vertical;"
                        placeholder="Add a description...">${issue.description || ''}</textarea>
              <button onclick="updateIssueDescription('${issue.key}')" 
                      style="margin-top: 8px; padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                Update Description
              </button>
            </div>
            
            <!-- Add Comment -->
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-size: 14px; font-weight: 600; color: #171717; margin-bottom: 8px;">Add Comment</label>
              <textarea id="jiraIssueComment" 
                        style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; resize: vertical;"
                        placeholder="Write a comment..."></textarea>
              <button onclick="addIssueComment('${issue.key}')" 
                      style="margin-top: 8px; padding: 8px 16px; background: #34C759; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                Add Comment
              </button>
            </div>
            
            <!-- Assignee -->
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-size: 14px; font-weight: 600; color: #171717; margin-bottom: 8px;">Assigned to</label>
              <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f3f4f6; border-radius: 8px;">
                ${issue.assignee ? `
                  <div style="width: 32px; height: 32px; border-radius: 50%; background: #007AFF; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">
                    ${issue.assignee.display_name.charAt(0).toUpperCase()}
                  </div>
                  <div>
                    <div style="font-size: 14px; font-weight: 600; color: #171717;">${issue.assignee.display_name}</div>
                    <div style="font-size: 12px; color: #737373;">${issue.assignee.email || ''}</div>
                  </div>
                ` : `
                  <div style="font-size: 14px; color: #737373;">Unassigned</div>
                `}
              </div>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
              <button onclick="window.electronAPI.shell.openExternal('${issue.url}')" 
                      style="flex: 1; padding: 12px; background: #0052CC; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                Open in JIRA â†’
              </button>
              <button onclick="closeJIRAEditorModal()" 
                      style="flex: 1; padding: 12px; background: #f3f4f6; color: #171717; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                Close
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close on overlay click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeJIRAEditorModal();
        }
      });
    }
    
    // Close JIRA editor modal
    function closeJIRAEditorModal() {
      const modal = document.getElementById('jiraEditorModal');
      if (modal) {
        modal.remove();
      }
    }
    
    // Update issue status
    async function updateIssueStatus(issueKey, newStatus) {
      try {
        showNotification(`Updating ${issueKey} status...`, 'info', 2000);
        
        const result = await window.electronAPI.jira.executeCommand({
          command: `transition ${issueKey} to ${newStatus}`
        });
        
        if (result.success) {
          showNotification(`âœ… Status updated to ${newStatus}`, 'success');
          closeJIRAEditorModal();
          if (currentView === 'tasks') {
            await loadTasks();
          }
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showNotification(`Failed: ${error.message}`, 'error');
      }
    }
    
    // Update issue priority
    async function updateIssuePriority(issueKey, newPriority) {
      try {
        showNotification(`Updating ${issueKey} priority...`, 'info', 2000);
        
        const result = await window.electronAPI.jira.executeCommand({
          command: `update ${issueKey} set priority to ${newPriority}`
        });
        
        if (result.success) {
          showNotification(`âœ… Priority updated to ${newPriority}`, 'success');
          closeJIRAEditorModal();
          if (currentView === 'tasks') {
            await loadTasks();
          }
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showNotification(`Failed: ${error.message}`, 'error');
      }
    }
    
    // Update issue description
    async function updateIssueDescription(issueKey) {
      try {
        const description = document.getElementById('jiraIssueDescription').value;
        
        if (!description.trim()) {
          showNotification('Description cannot be empty', 'error');
          return;
        }
        
        showNotification(`Updating ${issueKey} description...`, 'info', 2000);
        
        const result = await window.electronAPI.jira.executeCommand({
          command: `update ${issueKey} set description to "${description.replace(/"/g, '\\"')}"`
        });
        
        if (result.success) {
          showNotification(`âœ… Description updated`, 'success');
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showNotification(`Failed: ${error.message}`, 'error');
      }
    }
    
    // Add issue comment
    async function addIssueComment(issueKey) {
      try {
        const commentText = document.getElementById('jiraIssueComment').value;
        
        if (!commentText.trim()) {
          showNotification('Comment cannot be empty', 'error');
          return;
        }
        
        showNotification(`Adding comment to ${issueKey}...`, 'info', 2000);
        
        const result = await window.electronAPI.jira.executeCommand({
          command: `comment on ${issueKey} "${commentText.replace(/"/g, '\\"')}"`
        });
        
        if (result.success) {
          showNotification(`âœ… Comment added`, 'success');
          document.getElementById('jiraIssueComment').value = '';
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showNotification(`Failed: ${error.message}`, 'error');
      }
    }
    
    // ===== LIVE JIRA CARD FUNCTIONS =====
    
    // Global variable to track card state
    let cardExpanded = true;
    let lastKnownJiraState = null;
    
    // Update live JIRA card with latest data
    async function updateLiveJiraCard(task, silentUpdate = false) {
      try {
        const card = document.getElementById('liveJiraTaskCard');
        if (!task || !task.externalKey) {
          card.style.display = 'none';
          return;
        }
        
        // Show loading state only if not silent
        if (!silentUpdate) {
          card.style.display = 'block';
          document.getElementById('jiraCardTitle').textContent = 'Loading...';
          document.getElementById('jiraCardSyncStatus').textContent = 'Syncing...';
        }
        
        // Fetch latest JIRA data
        const result = await window.electronAPI.jira.getMyIssues({ 
          maxResults: 100 
        });
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to fetch JIRA data');
        }
        
        // Find the specific issue
        const jiraIssue = result.issues.find(issue => issue.key === task.externalKey);
        
        if (!jiraIssue) {
          // Issue not found - maybe it was deleted or user doesn't have access
          card.style.display = 'none';
          return;
        }
        
        // Check if state changed (for highlighting changes)
        const stateChanged = detectChanges(lastKnownJiraState, jiraIssue);
        lastKnownJiraState = JSON.parse(JSON.stringify(jiraIssue));
        
        // Store the full JIRA data for actions
        currentTaskChat.jiraData = jiraIssue;
        
        // Update header
        document.getElementById('jiraCardTitle').textContent = jiraIssue.summary;
        document.getElementById('jiraCardMeta').innerHTML = `
          <span style="font-family: monospace; font-weight: 600;">${jiraIssue.key}</span>
          <span>â€¢</span>
          <span>${jiraIssue.issue_type?.name || 'Task'}</span>
          ${jiraIssue.story_points ? `<span>â€¢ ${jiraIssue.story_points} pts</span>` : ''}
        `;
        
        // Status badge with click to change
        const statusColors = {
          'To Do': 'rgba(115, 115, 115, 0.5)',
          'In Progress': 'rgba(0, 122, 255, 0.5)',
          'Done': 'rgba(52, 199, 89, 0.5)',
          'Backlog': 'rgba(142, 142, 147, 0.5)',
          'In Review': 'rgba(255, 149, 0, 0.5)'
        };
        const statusColor = statusColors[jiraIssue.status?.name] || 'rgba(255,255,255,0.25)';
        const statusEl = document.getElementById('jiraCardStatus');
        statusEl.textContent = jiraIssue.status?.name || 'Unknown';
        statusEl.style.background = statusColor;
        
        // Highlight if changed
        if (stateChanged.status && silentUpdate) {
          statusEl.style.animation = 'flash 1s ease-in-out';
          setTimeout(() => statusEl.style.animation = '', 1000);
        }
        
        // Priority badge with click to change
        const priorityIcons = {
          'Highest': 'ðŸ”´',
          'High': 'ðŸŸ ',
          'Medium': 'ðŸŸ¡',
          'Low': 'ðŸŸ¢',
          'Lowest': 'ðŸ”µ'
        };
        const priorityIcon = priorityIcons[jiraIssue.priority?.name] || 'âšª';
        const priorityEl = document.getElementById('jiraCardPriority');
        priorityEl.textContent = `${priorityIcon} ${jiraIssue.priority?.name || 'Medium'}`;
        
        // Highlight if changed
        if (stateChanged.priority && silentUpdate) {
          priorityEl.style.animation = 'flash 1s ease-in-out';
          setTimeout(() => priorityEl.style.animation = '', 1000);
        }
        
        // Assignee
        if (jiraIssue.assignee) {
          document.getElementById('jiraCardAssignee').textContent = `ðŸ‘¤ ${jiraIssue.assignee.display_name}`;
          document.getElementById('jiraCardAssignee').style.display = 'block';
        } else {
          document.getElementById('jiraCardAssignee').textContent = 'ðŸ‘¤ Unassigned';
          document.getElementById('jiraCardAssignee').style.display = 'block';
        }
        
        // Metrics (comments, attachments)
        const metrics = [];
        if (jiraIssue.comments) metrics.push(`ðŸ’¬ ${jiraIssue.comments}`);
        if (jiraIssue.attachments) metrics.push(`ðŸ“Ž ${jiraIssue.attachments}`);
        if (metrics.length > 0) {
          document.getElementById('jiraCardMetrics').textContent = metrics.join(' â€¢ ');
          document.getElementById('jiraCardMetrics').style.display = 'block';
        } else {
          document.getElementById('jiraCardMetrics').style.display = 'none';
        }
        
        // Description
        const description = jiraIssue.description || 'No description provided.';
        document.getElementById('jiraCardDescription').textContent = description.length > 300 
          ? description.substring(0, 300) + '...' 
          : description;
        
        // Activity feed (simulated - would need real JIRA changelog API)
        updateActivityFeed(jiraIssue, stateChanged);
        
        // Labels
        if (jiraIssue.labels && jiraIssue.labels.length > 0) {
          document.getElementById('jiraCardLabels').style.display = 'block';
          document.getElementById('jiraCardLabelsContent').innerHTML = jiraIssue.labels.map(label => 
            `<span style="padding: 4px 10px; background: rgba(255,255,255,0.25); color: white; border-radius: 4px; font-size: 11px; font-weight: 600;">${label}</span>`
          ).join('');
        } else {
          document.getElementById('jiraCardLabels').style.display = 'none';
        }
        
        // Last updated
        const now = new Date();
        document.getElementById('jiraCardLastUpdated').textContent = `Updated ${now.toLocaleTimeString()}`;
        document.getElementById('jiraCardSyncStatus').textContent = silentUpdate ? 'Auto-synced' : 'Synced';
        
        // Show notification if changes detected
        if (stateChanged.any && silentUpdate) {
          showNotification(`ðŸ”” JIRA updated: ${jiraIssue.key}`, 'info', 3000);
          
          // Broadcast to other views
          broadcastJiraUpdate(jiraIssue);
        }
        
        console.log('âœ… Live JIRA card updated:', jiraIssue.key, stateChanged);
        
      } catch (error) {
        console.error('âŒ Failed to update live JIRA card:', error);
        document.getElementById('jiraCardSyncStatus').textContent = 'Sync failed';
        // Don't hide the card on error
      }
    }
    
    // Detect changes between old and new state
    function detectChanges(oldState, newState) {
      if (!oldState) return { any: false };
      
      const changes = {
        any: false,
        status: false,
        priority: false,
        assignee: false,
        description: false
      };
      
      if (oldState.status?.name !== newState.status?.name) {
        changes.status = true;
        changes.any = true;
      }
      
      if (oldState.priority?.name !== newState.priority?.name) {
        changes.priority = true;
        changes.any = true;
      }
      
      if (oldState.assignee?.account_id !== newState.assignee?.account_id) {
        changes.assignee = true;
        changes.any = true;
      }
      
      if (oldState.description !== newState.description) {
        changes.description = true;
        changes.any = true;
      }
      
      return changes;
    }
    
    // Update activity feed
    function updateActivityFeed(jiraIssue, changes) {
      const activityEl = document.getElementById('jiraCardActivity');
      const activities = [];
      
      // Show detected changes
      if (changes.status) {
        activities.push({
          time: 'Just now',
          icon: 'ðŸ”„',
          text: `Status changed to ${jiraIssue.status?.name}`,
          highlight: true
        });
      }
      
      if (changes.priority) {
        activities.push({
          time: 'Just now',
          icon: 'âš¡',
          text: `Priority changed to ${jiraIssue.priority?.name}`,
          highlight: true
        });
      }
      
      // Show update time
      if (jiraIssue.updated_at) {
        const updated = new Date(jiraIssue.updated_at);
        const timeAgo = getTimeAgo(updated);
        activities.push({
          time: timeAgo,
          icon: 'ðŸ“',
          text: 'Issue updated'
        });
      }
      
      // Show creation time
      if (jiraIssue.created_at) {
        const created = new Date(jiraIssue.created_at);
        const timeAgo = getTimeAgo(created);
        activities.push({
          time: timeAgo,
          icon: 'ðŸ†•',
          text: 'Issue created'
        });
      }
      
      if (activities.length === 0) {
        activityEl.innerHTML = '<div style="font-size: 12px; color: rgba(255,255,255,0.6); font-style: italic;">No recent activity</div>';
      } else {
        activityEl.innerHTML = activities.map(activity => `
          <div style="padding: 8px; margin-bottom: 6px; background: ${activity.highlight ? 'rgba(255,255,255,0.15)' : 'rgba(255,255,255,0.05)'}; border-radius: 6px; display: flex; align-items: start; gap: 8px;">
            <span style="font-size: 14px;">${activity.icon}</span>
            <div style="flex: 1;">
              <div style="font-size: 12px; color: rgba(255,255,255,0.95); margin-bottom: 2px;">${activity.text}</div>
              <div style="font-size: 10px; color: rgba(255,255,255,0.6);">${activity.time}</div>
            </div>
          </div>
        `).join('');
      }
    }
    
    // Helper to calculate time ago
    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
      return date.toLocaleDateString();
    }
    
    // Broadcast JIRA updates to other views
    function broadcastJiraUpdate(jiraIssue) {
      // Update task in global tasks array
      const taskIndex = tasks.findIndex(t => t.externalKey === jiraIssue.key);
      if (taskIndex !== -1) {
        // Update task data
        tasks[taskIndex] = {
          ...tasks[taskIndex],
          title: jiraIssue.summary,
          description: jiraIssue.description,
          priority: mapJiraPriorityToTask(jiraIssue.priority?.name),
          status: jiraIssue.status?.name === 'Done' ? 'completed' : 'pending'
        };
        
        // Refresh task list if visible
        if (currentView === 'tasks') {
          loadTasks();
        }
      }
    }
    
    // Map JIRA priority to task priority
    function mapJiraPriorityToTask(jiraPriority) {
      if (!jiraPriority) return 'medium';
      const priority = jiraPriority.toLowerCase();
      if (priority.includes('highest') || priority.includes('critical')) return 'urgent';
      if (priority.includes('high')) return 'high';
      if (priority.includes('low')) return 'low';
      return 'medium';
    }
    
    // Refresh JIRA task card
    async function refreshJiraTaskCard() {
      if (!currentTaskChat) return;
      
      showNotification('Syncing with JIRA...', 'info', 2000);
      await updateLiveJiraCard(currentTaskChat, false); // Not silent
      showNotification('âœ… Synced with JIRA', 'success');
    }
    
    // Toggle card expanded/collapsed
    function toggleCardExpanded() {
      cardExpanded = !cardExpanded;
      const expandedContent = document.getElementById('jiraCardExpanded');
      const expandBtn = document.getElementById('jiraCardExpandBtn');
      
      if (cardExpanded) {
        expandedContent.style.display = 'block';
        expandBtn.textContent = 'â¬‡ï¸';
      } else {
        expandedContent.style.display = 'none';
        expandBtn.textContent = 'âž¡ï¸';
      }
    }
    
    // Show status picker
    function showStatusPicker() {
      if (!currentTaskChat || !currentTaskChat.externalKey) return;
      
      const statuses = ['To Do', 'In Progress', 'In Review', 'Done'];
      const currentStatus = currentTaskChat.jiraData?.status?.name || 'Unknown';
      
      // Create inline picker
      const statusEl = document.getElementById('jiraCardStatus');
      const originalContent = statusEl.innerHTML;
      
      statusEl.innerHTML = `
        <select onchange="changeStatus(this.value); this.parentElement.innerHTML = '${originalContent.replace(/'/g, "\\'")}'" 
                style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; font-weight: 600; cursor: pointer;">
          ${statuses.map(status => `
            <option value="${status}" ${status === currentStatus ? 'selected' : ''}>${status}</option>
          `).join('')}
        </select>
      `;
      
      statusEl.querySelector('select').focus();
    }
    
    // Change status
    async function changeStatus(newStatus) {
      if (!currentTaskChat || !currentTaskChat.externalKey) return;
      
      try {
        const issueKey = currentTaskChat.externalKey;
        showNotification(`Changing status to ${newStatus}...`, 'info', 2000);
        
        const result = await window.electronAPI.jira.executeCommand({
          command: `transition ${issueKey} to ${newStatus}`
        });
        
        if (result.success) {
          showNotification(`âœ… Status updated to ${newStatus}`, 'success');
          await updateLiveJiraCard(currentTaskChat, false);
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showNotification(`Failed: ${error.message}`, 'error');
      }
    }
    
    // Show priority picker
    function showPriorityPicker() {
      if (!currentTaskChat || !currentTaskChat.externalKey) return;
      
      const priorities = ['Highest', 'High', 'Medium', 'Low', 'Lowest'];
      const currentPriority = currentTaskChat.jiraData?.priority?.name || 'Medium';
      
      // Create inline picker
      const priorityEl = document.getElementById('jiraCardPriority');
      const originalContent = priorityEl.innerHTML;
      
      priorityEl.innerHTML = `
        <select onchange="changePriority(this.value); this.parentElement.innerHTML = '${originalContent.replace(/'/g, "\\'")}'" 
                style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; font-weight: 600; cursor: pointer;">
          ${priorities.map(priority => `
            <option value="${priority}" ${priority === currentPriority ? 'selected' : ''}>${priority}</option>
          `).join('')}
        </select>
      `;
      
      priorityEl.querySelector('select').focus();
    }
    
    // Change priority
    async function changePriority(newPriority) {
      if (!currentTaskChat || !currentTaskChat.externalKey) return;
      
      try {
        const issueKey = currentTaskChat.externalKey;
        showNotification(`Changing priority to ${newPriority}...`, 'info', 2000);
        
        const result = await window.electronAPI.jira.executeCommand({
          command: `update ${issueKey} set priority to ${newPriority}`
        });
        
        if (result.success) {
          showNotification(`âœ… Priority updated to ${newPriority}`, 'success');
          await updateLiveJiraCard(currentTaskChat, false);
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showNotification(`Failed: ${error.message}`, 'error');
      }
    }
    
    // Add quick comment
    async function addQuickComment() {
      if (!currentTaskChat || !currentTaskChat.externalKey) return;
      
      const input = document.getElementById('jiraCardQuickComment');
      const comment = input.value.trim();
      
      if (!comment) {
        showNotification('Please enter a comment', 'error');
        return;
      }
      
      try {
        const issueKey = currentTaskChat.externalKey;
        showNotification(`Adding comment...`, 'info', 2000);
        
        const result = await window.electronAPI.jira.executeCommand({
          command: `comment on ${issueKey} "${comment.replace(/"/g, '\\"')}"`
        });
        
        if (result.success) {
          showNotification(`âœ… Comment added`, 'success');
          input.value = '';
          
          // Refresh card to show updated comment count
          await updateLiveJiraCard(currentTaskChat, true);
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showNotification(`Failed: ${error.message}`, 'error');
      }
    }
    
    // Edit description
    function editDescription() {
      if (!currentTaskChat || !currentTaskChat.jiraData) return;
      
      const currentDesc = currentTaskChat.jiraData.description || '';
      const descEl = document.getElementById('jiraCardDescription');
      
      // Show textarea
      descEl.innerHTML = `
        <textarea id="descEditArea" 
                  style="width: 100%; min-height: 100px; padding: 8px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: white; font-size: 13px; font-family: inherit; resize: vertical;"
                  placeholder="Enter description...">${currentDesc}</textarea>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          <button onclick="saveDescription()" style="padding: 6px 12px; background: rgba(255,255,255,0.9); color: #667eea; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">Save</button>
          <button onclick="updateLiveJiraCard(currentTaskChat, false)" style="padding: 6px 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">Cancel</button>
        </div>
      `;
      
      document.getElementById('descEditArea').focus();
    }
    
    // Save description
    async function saveDescription() {
      if (!currentTaskChat || !currentTaskChat.externalKey) return;
      
      const textarea = document.getElementById('descEditArea');
      const newDesc = textarea.value.trim();
      
      if (!newDesc) {
        showNotification('Description cannot be empty', 'error');
        return;
      }
      
      try {
        const issueKey = currentTaskChat.externalKey;
        showNotification(`Updating description...`, 'info', 2000);
        
        const result = await window.electronAPI.jira.executeCommand({
          command: `update ${issueKey} set description to "${newDesc.replace(/"/g, '\\"')}"`
        });
        
        if (result.success) {
          showNotification(`âœ… Description updated`, 'success');
          await updateLiveJiraCard(currentTaskChat, false);
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showNotification(`Failed: ${error.message}`, 'error');
      }
    }
    
    // Quick JIRA action from live card
    async function quickJiraAction(targetStatus) {
      if (!currentTaskChat || !currentTaskChat.externalKey) return;
      
      try {
        const issueKey = currentTaskChat.externalKey;
        showNotification(`Moving ${issueKey} to ${targetStatus}...`, 'info', 2000);
        
        const result = await window.electronAPI.jira.executeCommand({
          command: `transition ${issueKey} to ${targetStatus}`
        });
        
        if (result.success) {
          showNotification(`âœ… ${issueKey} moved to ${targetStatus}`, 'success');
          
          // Update the live card
          await updateLiveJiraCard(currentTaskChat);
          
          // Also refresh the main task list
          if (currentView === 'tasks') {
            await loadTasks();
          }
        } else {
          throw new Error(result.error || 'Failed to transition issue');
        }
      } catch (error) {
        console.error('âŒ Quick action failed:', error);
        showNotification(`Failed: ${error.message}`, 'error');
      }
    }
    
    // Open JIRA card full editor
    function openJiraCardEditor() {
      if (!currentTaskChat || !currentTaskChat.jiraData) return;
      
      // Close task chat modal first
      closeTaskChat();
      
      // Open the full JIRA editor
      openJIRAIssueEditor(currentTaskChat.externalKey, currentTaskChat.jiraData);
    }
    
    // Open JIRA in browser from live card
    function openJiraInBrowser() {
      if (!currentTaskChat || !currentTaskChat.externalUrl) return;
      
      window.electronAPI.shell.openExternal(currentTaskChat.externalUrl);
    }
    
    // Auto-refresh live card every 30 seconds when task chat is open
    let jiraCardRefreshInterval = null;
    
    function startJiraCardAutoRefresh() {
      // Clear any existing interval
      if (jiraCardRefreshInterval) {
        clearInterval(jiraCardRefreshInterval);
      }
      
      // Start new interval - refresh every 30 seconds
      jiraCardRefreshInterval = setInterval(async () => {
        if (currentTaskChat && currentTaskChat.externalKey) {
          console.log('ðŸ”„ Auto-refreshing JIRA card (silent)...');
          await updateLiveJiraCard(currentTaskChat, true); // Silent update
        }
      }, 30000); // 30 seconds
    }
    
    function stopJiraCardAutoRefresh() {
      if (jiraCardRefreshInterval) {
        clearInterval(jiraCardRefreshInterval);
        jiraCardRefreshInterval = null;
      }
    }
    
    // JIRA Authentication
    async function authenticateJIRA() {
      try {
        console.log('ðŸ” Authenticating with JIRA...');
        console.log('Debug: window.electronAPI =', window.electronAPI);
        console.log('Debug: window.electronAPI.jira =', window.electronAPI?.jira);
        
        if (!window.electronAPI?.jira?.authenticate) {
          throw new Error('JIRA API not available. Please restart the app.');
        }
        
        const result = await window.electronAPI.jira.authenticate();
        
        if (result.success) {
          console.log('âœ… JIRA authenticated successfully');
          
          // Immediately update button state (don't wait for DB check)
          const btn = document.getElementById('jiraAuthBtn');
          if (btn) {
            btn.classList.add('connected');
            btn.title = `JIRA Connected (${result.siteUrl}) - Click to refresh`;
          }
          
          alert(`Successfully connected to JIRA!\n\nSite: ${result.siteUrl}`);
          
          // Sync and load tasks immediately for developers
          if (userRole === 'developer') {
            await syncJIRATasks();
          }
        } else {
          console.error('âŒ JIRA authentication failed:', result.error);
          alert(`Failed to authenticate with JIRA:\n\n${result.error}`);
        }
      } catch (error) {
        console.error('âŒ JIRA authentication error:', error);
        alert(`JIRA authentication error:\n\n${error.message}`);
      }
    }
    
    // Check JIRA connection status

    // Initialize on page load
    setTimeout(initializeRoleBasedUI, 1000);

    // ===== CODE INDEXER FUNCTIONS =====
    let indexedRepositories = [];
    let availableRepositories = [];

    async function loadIndexerData() {
      console.log('ðŸ“Š Loading indexer data...');
      await Promise.all([
        loadAvailableRepositories(),
        loadIndexedRepositories()
      ]);
    }

    async function loadAvailableRepositories() {
      try {
        if (!window.electronAPI?.engineering?.listRepos) {
          console.log('â„¹ï¸  Engineering API not available');
          return;
        }

        const result = await window.electronAPI.engineering.listRepos();
        
        if (result.success && result.repos) {
          availableRepositories = result.repos;
          console.log('âœ… Loaded', availableRepositories.length, 'available repositories');
          
          // Populate repository select
          const select = document.getElementById('repositorySelect');
          select.innerHTML = '<option value="">Select a repository...</option>';
          availableRepositories.forEach(repo => {
            const option = document.createElement('option');
            option.value = JSON.stringify({ owner: repo.owner.login, name: repo.name });
            option.textContent = repo.full_name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('âŒ Failed to load available repositories:', error);
      }
    }

    async function loadIndexedRepositories() {
      try {
        if (!window.electronAPI?.codeIndexer?.listRepositories) {
          console.log('â„¹ï¸  Code Indexer API not available');
          return;
        }

        const result = await window.electronAPI.codeIndexer.listRepositories();
        
        if (result.success && result.repositories) {
          indexedRepositories = result.repositories;
          console.log('âœ… Loaded', indexedRepositories.length, 'indexed repositories');
          renderRepositories();
        }
      } catch (error) {
        console.error('âŒ Failed to load indexed repositories:', error);
      }
    }

    function renderRepositories() {
      const container = document.getElementById('repositoriesList');
      
      if (indexedRepositories.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #737373;">
            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“¦</div>
            <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">No Indexed Repositories</div>
            <div style="font-size: 14px;">Select a repository above and click "Index Repository" to get started</div>
          </div>
        `;
        return;
      }

      container.innerHTML = indexedRepositories.map(repo => {
        const status = repo.status || 'completed';
        const statusColors = {
          completed: { bg: '#d1fae5', text: '#065f46', label: 'âœ“ Indexed' },
          in_progress: { bg: '#fef3c7', text: '#92400e', label: 'â³ Indexing' },
          failed: { bg: '#fee2e2', text: '#991b1b', label: 'âœ— Failed' },
          pending: { bg: '#e0e7ff', text: '#3730a3', label: 'â—‹ Pending' }
        };
        const statusInfo = statusColors[status] || statusColors.pending;

        return `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <div>
                <div style="font-size: 16px; font-weight: 600; color: #171717; margin-bottom: 4px;">
                  ${repo.repository_owner}/${repo.repository_name}
                </div>
                <div style="font-size: 13px; color: #737373;">
                  ${repo.indexed_chunks || 0} chunks indexed â€¢ ${repo.indexed_files || 0} files
                </div>
              </div>
              <span style="padding: 6px 12px; background: ${statusInfo.bg}; color: ${statusInfo.text}; border-radius: 8px; font-size: 12px; font-weight: 600;">
                ${statusInfo.label}
              </span>
            </div>
            ${repo.status === 'completed' ? `
              <div style="font-size: 12px; color: #525252;">
                Last indexed: ${new Date(repo.updated_at).toLocaleDateString()}
              </div>
            ` : ''}
            ${repo.status === 'failed' && repo.error_message ? `
              <div style="font-size: 12px; color: #991b1b; margin-top: 8px;">
                Error: ${repo.error_message}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function refreshRepositories() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'ðŸ”„ Loading...';
      
      await loadIndexerData();
      
      btn.disabled = false;
      btn.textContent = 'ðŸ”„ Refresh';
    }

    async function askCodeQuestion() {
      const queryInput = document.getElementById('codeQuery');
      const repoSelect = document.getElementById('repositorySelect');
      const question = queryInput.value.trim();
      const repoData = repoSelect.value;

      if (!question) {
        alert('Please enter a question');
        return;
      }

      if (!repoData) {
        alert('Please select a repository');
        return;
      }

      const repo = JSON.parse(repoData);
      
      // Show loading
      document.getElementById('queryLoading').style.display = 'block';
      document.getElementById('answerSection').style.display = 'none';

      try {
        console.log('ðŸ” Querying:', question, 'in', repo.owner + '/' + repo.name);

        // Fallback response for demo purposes
        const fallbackResult = {
          success: true,
          answer: `Based on your (Avinash Sanghavi's) responses, we've found that your devs have made progress on the Dashboard feature update (new color scheme) but are still waiting to put together an AI chatbot for your website.\n\nI recommend checking in at your 9:00 stand-up to ensure design consistency, however the team is ahead of schedule on task delivery.`,
          confidence: 'high',
          sources: [
            {
              filePath: 'src/components/Dashboard/Dashboard.jsx',
              chunkType: 'component',
              chunkName: 'Dashboard',
              startLine: 45,
              similarity: 0.89
            },
            {
              filePath: 'src/styles/theme.css',
              chunkType: 'stylesheet',
              chunkName: 'theme',
              startLine: 12,
              similarity: 0.82
            },
            {
              filePath: 'docs/ROADMAP.md',
              chunkType: 'documentation',
              chunkName: 'roadmap',
              startLine: 78,
              similarity: 0.75
            }
          ]
        };

        // For now, always use fallback
        // TODO: Implement real code indexer query when ready
        // if (!window.electronAPI?.codeIndexer?.query) {
        //   console.log('Using fallback response (Code Indexer not available)');
        //   displayAnswer(fallbackResult);
        //   document.getElementById('queryLoading').style.display = 'none';
        //   return;
        // }

        // Simulate loading time
        setTimeout(() => {
          // Hide loading
          document.getElementById('queryLoading').style.display = 'none';
          displayAnswer(fallbackResult);
        }, 1500);

        // Real implementation (commented out for now):
        /*
        const result = await window.electronAPI.codeIndexer.query({
          owner: repo.owner,
          repo: repo.name,
          question: question
        });

        // Hide loading
        document.getElementById('queryLoading').style.display = 'none';

        if (result.success) {
          displayAnswer(result);
        } else {
          // Fall back to demo response if query fails
          displayAnswer(fallbackResult);
        }
        */

      } catch (error) {
        console.error('âŒ Query failed:', error);
        document.getElementById('queryLoading').style.display = 'none';
        
        // Show fallback response even on error
        displayAnswer({
          success: true,
          answer: `Based on your (Avinash Sanghavi's) responses, we've found that your devs have made progress on the Dashboard feature update (new color scheme) but are still waiting to put together an AI chatbot for your website.\n\nI recommend checking in at your 9:00 stand-up to ensure design consistency, however the team is ahead of schedule on task delivery.`,
          confidence: 'high',
          sources: []
        });
      }
    }

    function displayAnswer(result) {
      const answerSection = document.getElementById('answerSection');
      const answerContent = document.getElementById('answerContent');
      const confidenceBadge = document.getElementById('confidenceBadge');
      const sourcesSection = document.getElementById('sourcesSection');
      const sourcesList = document.getElementById('sourcesList');

      // Show answer section
      answerSection.style.display = 'block';

      // Set confidence badge
      const confidenceColors = {
        high: { bg: '#d1fae5', text: '#065f46' },
        medium: { bg: '#fef3c7', text: '#92400e' },
        low: { bg: '#e0e7ff', text: '#3730a3' }
      };
      const confidence = result.confidence || 'medium';
      const colors = confidenceColors[confidence];
      confidenceBadge.style.background = colors.bg;
      confidenceBadge.style.color = colors.text;
      confidenceBadge.textContent = confidence.toUpperCase() + ' CONFIDENCE';

      // Display answer
      answerContent.innerHTML = result.answer.replace(/\n/g, '<br>');

      // Display sources
      if (result.sources && result.sources.length > 0) {
        sourcesSection.style.display = 'block';
        sourcesList.innerHTML = result.sources.map((source, index) => `
          <div style="padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 13px;">
            <div style="font-weight: 600; color: #171717; margin-bottom: 4px;">
              ${index + 1}. ${source.filePath}
            </div>
            <div style="color: #525252;">
              ${source.chunkType} ${source.chunkName ? `â€¢ ${source.chunkName}` : ''}
              ${source.startLine ? `â€¢ Line ${source.startLine}` : ''}
              â€¢ ${(source.similarity * 100).toFixed(0)}% match
            </div>
          </div>
        `).join('');
      } else {
        sourcesSection.style.display = 'none';
      }

      // Scroll to answer
      answerSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // ===== MEETING APPROVAL SYSTEM =====
    let pendingMeeting = null;

    function showMeetingApproval(meetingData) {
      pendingMeeting = meetingData;
      const modal = document.getElementById('meetingApprovalModal');
      const detailsDiv = document.getElementById('meetingDetails');
      
      // Format the meeting time
      const startTime = new Date(meetingData.startTime);
      const endTime = new Date(meetingData.endTime);
      const timeOptions = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        timeZone: meetingData.timeZone || 'America/Denver'
      };
      
      detailsDiv.innerHTML = `
        <div style="margin-bottom: 12px;">
          <strong style="color: #666; font-size: 12px; text-transform: uppercase;">Subject</strong>
          <div style="font-size: 16px; font-weight: 600; margin-top: 4px;">${meetingData.subject}</div>
        </div>
        <div style="margin-bottom: 12px;">
          <strong style="color: #666; font-size: 12px; text-transform: uppercase;">When</strong>
          <div style="font-size: 14px; margin-top: 4px;">
            ${startTime.toLocaleString('en-US', timeOptions)}
          </div>
          <div style="font-size: 13px; color: #666; margin-top: 2px;">
            Duration: ${Math.round((endTime - startTime) / 60000)} minutes
          </div>
        </div>
        ${meetingData.attendeeList && meetingData.attendeeList.length > 0 ? `
          <div style="margin-bottom: 12px;">
            <strong style="color: #666; font-size: 12px; text-transform: uppercase;">Attendees (To Be Added Manually)</strong>
            <div style="font-size: 14px; margin-top: 4px;">
              ${meetingData.attendeeList.map(email => `
                <div style="display: flex; align-items: center; margin-top: 4px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  ${email}
                </div>
              `).join('')}
            </div>
            <div style="font-size: 12px; color: #f59e0b; margin-top: 8px; padding: 8px; background: #fffbeb; border-radius: 4px;">
              ðŸ’¡ These attendees will NOT be added automatically to avoid email delivery issues. You can add them in Outlook or share the Teams link directly.
            </div>
          </div>
        ` : ''}
        ${meetingData.isOnlineMeeting ? `
          <div style="margin-bottom: 12px;">
            <strong style="color: #666; font-size: 12px; text-transform: uppercase;">Meeting Type</strong>
            <div style="font-size: 14px; margin-top: 4px; display: flex; align-items: center;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#5B5FC7" stroke-width="2" style="margin-right: 6px;">
                <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                <polyline points="17 2 12 7 7 2"></polyline>
              </svg>
              <span style="color: #5B5FC7; font-weight: 500;">Microsoft Teams Online Meeting</span>
            </div>
          </div>
        ` : ''}
        ${meetingData.body ? `
          <div style="margin-bottom: 12px;">
            <strong style="color: #666; font-size: 12px; text-transform: uppercase;">Description</strong>
            <div style="font-size: 13px; margin-top: 4px; color: #666;">${meetingData.body}</div>
          </div>
        ` : ''}
      `;
      
      modal.style.display = 'flex';
      modal.classList.add('show');
    }

    async function approveMeeting() {
      if (!pendingMeeting) return;
      
      const modal = document.getElementById('meetingApprovalModal');
      const content = modal.querySelector('.ms-auth-content');
      
      // Show loading state
      content.innerHTML = `
        <h3>Creating Meeting...</h3>
        <p style="text-align: center;">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: msSpinAnimation 1s linear infinite;">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
        </p>
        <p>Creating calendar event and sending invitations...</p>
      `;
      
      try {
        // Call the backend to create the meeting using the correct service
        const service = pendingMeeting.service || 'microsoft';
        console.log(`ðŸ”„ Creating meeting with ${service} service:`, pendingMeeting);
        
        const result = service === 'google' 
          ? await window.electronAPI.google.createEvent(pendingMeeting)
          : await window.electronAPI.microsoft.createEvent(pendingMeeting);
        
        console.log('ðŸ“… Meeting creation result:', result);
        
        if (result.success) {
          // Extract meeting link from various possible locations
          const meetingLink = result.meetingLink 
            || result.event?.onlineMeeting?.joinUrl 
            || result.event?.webLink;
          
          console.log('âœ… Meeting created successfully!', {
            eventId: result.event?.id,
            meetingLink: meetingLink,
            subject: result.event?.subject
          });
          
          content.innerHTML = `
            <h3>âœ… Meeting Created!</h3>
            <p>The calendar event has been created on your calendar${meetingLink ? ' with a Teams meeting link' : ''}.</p>
            ${meetingLink ? `
              <div style="background: #f0f9ff; border: 1px solid #0ea5e9; padding: 12px; border-radius: 6px; margin: 16px 0;">
                <strong style="color: #0369a1;">ðŸ“‹ Teams Meeting Link:</strong>
                <div style="font-size: 12px; word-break: break-all; margin-top: 6px; color: #0369a1; user-select: all;">
                  ${meetingLink}
                </div>
                <button onclick="navigator.clipboard.writeText('${meetingLink}'); this.textContent='âœ“ Copied!'" style="margin-top: 8px; padding: 6px 12px; background: #0ea5e9; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Copy Link
                </button>
              </div>
            ` : `
              <div style="background: #fffbeb; border: 1px solid #f59e0b; padding: 12px; border-radius: 6px; margin: 16px 0; font-size: 13px;">
                <strong style="color: #d97706;">âš ï¸ Teams Link Not Available Yet</strong>
                <p style="margin: 8px 0 0 0; color: #92400e;">The meeting was created but the Teams link may take a moment to generate. Check the meeting in your Outlook calendar in a few seconds.</p>
              </div>
            `}
            <div style="background: #fffbeb; border: 1px solid #f59e0b; padding: 12px; border-radius: 6px; margin: 16px 0; font-size: 13px;">
              <strong style="color: #d97706;">Next Steps:</strong>
              <ol style="margin: 8px 0 0 20px; color: #92400e;">
                ${meetingLink ? '<li>Copy the Teams link above</li>' : '<li>Open the meeting in Outlook to get the Teams link</li>'}
                <li>Share it with attendees via email, Slack, or any messaging app</li>
                <li>Or add attendees directly in Outlook</li>
              </ol>
            </div>
            <div class="ms-auth-actions">
              <button class="ms-auth-primary" onclick="closeMeetingApproval()" style="width: 100%;">Done</button>
            </div>
          `;
          
          // Don't auto-close if there's no meeting link yet
          if (meetingLink) {
            setTimeout(() => closeMeetingApproval(), 5000);
          }
        } else {
          throw new Error(result.error || 'Failed to create meeting');
        }
      } catch (error) {
        console.error('âŒ Failed to create meeting:', error);
        content.innerHTML = `
          <h3>âŒ Meeting Creation Failed</h3>
          <p style="color: #ef4444;">${error.message}</p>
          <p style="font-size: 13px; color: #666; margin-top: 12px;">The meeting was not created. Please try again or create it manually in Outlook.</p>
          <div class="ms-auth-actions">
            <button class="ms-auth-secondary" onclick="closeMeetingApproval()">Close</button>
            <button class="ms-auth-primary" onclick="retryMeetingCreation()">Try Again</button>
          </div>
        `;
      }
    }

    function retryMeetingCreation() {
      if (pendingMeeting) {
        showMeetingApproval(pendingMeeting);
      }
    }

    function rejectMeeting() {
      pendingMeeting = null;
      closeMeetingApproval();
      
      // Optionally add a message to chat
      addMessage('Meeting creation cancelled.', 'assistant');
    }

    function closeMeetingApproval() {
      const modal = document.getElementById('meetingApprovalModal');
      modal.style.display = 'none';
      modal.classList.remove('show');
      pendingMeeting = null;
    }

    // Listen for meeting approval requests from main process
    if (window.electronAPI && window.electronAPI.onMeetingApprovalRequest) {
      window.electronAPI.onMeetingApprovalRequest((meetingData) => {
        showMeetingApproval(meetingData);
      });
    }

  </script>

  <!-- Microsoft 365 Auth Modal -->
  <div class="ms-auth-modal" id="msAuthModal">
    <div class="ms-auth-content">
      <h3>Connect Microsoft 365</h3>
      <p>Connect your Microsoft account to enable calendar automation, email notifications, and Teams integration.</p>
      <div class="ms-auth-actions">
        <button class="ms-auth-secondary" onclick="closeMicrosoftModal()">Cancel</button>
        <button class="ms-auth-primary" onclick="authenticateMicrosoft()">Connect</button>
      </div>
    </div>
  </div>

  <!-- Google Workspace Auth Modal -->
  <div class="ms-auth-modal" id="googleAuthModal">
    <div class="ms-auth-content">
      <h3>Connect Google Workspace</h3>
      <p>Connect your Google account to enable Gmail automation, Google Calendar integration, and Google Meet links.</p>
      <div class="ms-auth-actions">
        <button class="ms-auth-secondary" onclick="closeGoogleModal()">Cancel</button>
        <button class="ms-auth-primary" onclick="authenticateGoogle()">Connect</button>
      </div>
    </div>
  </div>

  <!-- Meeting Approval Modal -->
  <div class="ms-auth-modal" id="meetingApprovalModal" style="display: none;">
    <div class="ms-auth-content" style="max-width: 500px;">
      <h3>ðŸ“… Approve Meeting</h3>
      <div id="meetingDetails" style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin: 16px 0; text-align: left;">
        <!-- Meeting details will be inserted here -->
      </div>
      <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
        ðŸ’¡ <strong>Note:</strong> The meeting will be created on your calendar with a Teams link. Attendees are NOT added automatically to avoid email delivery issues. You can add them manually in Outlook or share the Teams link directly.
      </p>
      <div class="ms-auth-actions">
        <button class="ms-auth-secondary" onclick="rejectMeeting()">Cancel</button>
        <button class="ms-auth-primary" onclick="approveMeeting()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: middle;">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Create Meeting
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Toast Container -->
  <div id="notificationContainer" class="notification-container"></div>

  <script>
    // ===== NOTIFICATION SYSTEM =====
    /**
     * Show a toast notification
     * @param {string} message - The message to display
     * @param {string} type - 'success', 'error', 'warning', or 'info'
     * @param {number} duration - How long to show (ms), 0 for permanent
     */
    function showNotification(message, type = 'info', duration = 5000) {
      const container = document.getElementById('notificationContainer');
      if (!container) return;

      const notification = document.createElement('div');
      notification.className = `notification-toast ${type}`;
      
      const icons = {
        success: 'âœ“',
        error: 'âœ•',
        warning: 'âš ',
        info: 'â„¹'
      };
      
      notification.innerHTML = `
        <div class="notification-icon">${icons[type] || icons.info}</div>
        <div class="notification-content">${message}</div>
        <div class="notification-close" onclick="this.parentElement.remove()">âœ•</div>
      `;
      
      container.appendChild(notification);
      
      // Auto-remove after duration (if not permanent)
      if (duration > 0) {
        setTimeout(() => {
          if (notification.parentElement) {
            notification.classList.add('removing');
            setTimeout(() => notification.remove(), 200);
          }
        }, duration);
      }
      
      // Click notification to close
      notification.addEventListener('click', (e) => {
        if (!e.target.classList.contains('notification-close')) {
          notification.classList.add('removing');
          setTimeout(() => notification.remove(), 200);
        }
      });
    }

    // Listen for notifications from main process
    if (window.electronAPI && window.electronAPI.on) {
      window.electronAPI.on('notification', (data) => {
        console.log('ðŸ“¬ Received notification:', data);
        
        if (data.type === 'jira_auth_required') {
          showNotification(data.message || 'JIRA authentication expired. Please reconnect.', 'warning', 0);
          // Optionally trigger re-authentication
          if (data.action === 'reconnect_jira') {
            // Show reconnect button or modal
            setTimeout(() => {
              if (confirm('JIRA authentication expired. Would you like to reconnect now?')) {
                handleJIRAButtonClick();
              }
            }, 500);
          }
        } else {
          // Generic notification
          const typeMap = {
            'success': 'success',
            'error': 'error',
            'warning': 'warning',
            'info': 'info'
          };
          showNotification(data.message, typeMap[data.type] || 'info', data.duration || 5000);
        }
      });
    }
  </script>

</body>
</html>
</html>